<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#ff758c">
<title>Catch the Love - For Beatrix ‚ù§Ô∏è</title>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    margin: 0;
    overflow: hidden;
    background: linear-gradient(to bottom, #ff758c, #ff7eb3);
    font-family: -apple-system, BlinkMacSystemFont, 'Arial', sans-serif;
    text-align: center;
    touch-action: none;
    position: fixed;
    width: 100%;
    height: 100vh;
    height: 100dvh;
    overscroll-behavior: none;
    transition: background 1s ease;
}

/* Level-specific backgrounds */
body.level-1 {
    background: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%);
}

body.level-2 {
    background: 
        radial-gradient(circle at 20% 50%, rgba(168, 237, 234, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(254, 214, 227, 0.3) 0%, transparent 50%),
        linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
}

body.level-3 {
    background: 
        repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255, 255, 255, 0.1) 35px, rgba(255, 255, 255, 0.1) 70px),
        linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
}

body.level-4 {
    background: 
        radial-gradient(circle at 10% 20%, rgba(224, 195, 252, 0.4) 0%, transparent 40%),
        radial-gradient(circle at 90% 60%, rgba(142, 197, 252, 0.4) 0%, transparent 40%),
        radial-gradient(circle at 50% 80%, rgba(224, 195, 252, 0.3) 0%, transparent 50%),
        linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
}

body.level-5 {
    background: 
        repeating-linear-gradient(90deg, transparent, transparent 50px, rgba(255, 215, 0, 0.1) 50px, rgba(255, 215, 0, 0.1) 100px),
        repeating-linear-gradient(0deg, transparent, transparent 50px, rgba(25, 84, 123, 0.1) 50px, rgba(25, 84, 123, 0.1) 100px),
        linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
}

/* Header */
.header {
    position: relative;
    z-index: 100;
    padding: 10px 15px;
    padding-top: max(10px, env(safe-area-inset-top, 10px));
    background: rgba(0,0,0,0.2);
}

h1 {
    color: white;
    font-size: 22px;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.4);
    margin-bottom: 5px;
}

#scoreBoard {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
}

.stat {
    color: white;
    font-size: 16px;
    font-weight: bold;
    text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
}

#combo {
    color: #FFD700;
    font-size: 20px;
    transform: scale(1);
    transition: transform 0.2s;
}

#combo.pulse {
    transform: scale(1.3);
}

/* Sparkles - color changes per level */
.sparkle {
    position: absolute;
    width: 6px;
    height: 6px;
    background: white;
    border-radius: 50%;
    opacity: 0.8;
    animation: sparkleFloat 4s linear infinite;
    pointer-events: none;
}

body.level-2 .sparkle { background: #a8edea; }
body.level-3 .sparkle { background: #fcb69f; }
body.level-4 .sparkle { background: #e0c3fc; }
body.level-5 .sparkle { background: #ffd89b; }

@keyframes sparkleFloat {
    from { transform: translateY(100vh) scale(0.5); opacity: 0; }
    50% { opacity: 1; }
    to { transform: translateY(-10vh) scale(1.2); opacity: 0; }
}

#gameArea {
    position: relative;
    width: 100vw;
    height: calc(100vh - 100px);
    height: calc(100dvh - 100px);
    overflow: hidden;
}

/* Hearts and Items */
.heart, .powerup, .bomb {
    position: absolute;
    font-size: 28px;
    animation: fall linear;
    cursor: pointer;
    user-select: none;
}

.powerup {
    font-size: 32px;
    animation: fall linear, starPulse 0.6s ease-in-out infinite alternate;
}

@keyframes starPulse {
    from { filter: brightness(1) drop-shadow(0 0 4px rgba(255,220,0,0.6)); }
    to   { filter: brightness(1.5) drop-shadow(0 0 12px rgba(255,220,0,1)); }
}

.bomb {
    font-size: 30px;
    animation: fallWobble linear;
}

@keyframes fall {
    from { transform: translateY(-50px); }
    to { transform: translateY(calc(100vh + 50px)); }
}


@keyframes fallWobble {
    from { transform: translateY(-50px) rotate(-5deg); }
    25% { transform: translateY(calc(25vh)) rotate(5deg); }
    50% { transform: translateY(calc(50vh)) rotate(-5deg); }
    75% { transform: translateY(calc(75vh)) rotate(5deg); }
    to { transform: translateY(calc(100vh + 50px)) rotate(-5deg); }
}

#basket {
    position: absolute;
    bottom: max(20px, env(safe-area-inset-bottom, 20px) + 10px);
    left: 50%;
    transform: translateX(-50%);
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    z-index: 10;
    touch-action: none;
    will-change: transform;
    -webkit-transform: translateX(-50%);
}

#basket.invincible img {
    animation: shieldGlow 0.4s ease-in-out infinite alternate;
    border-color: gold !important;
}

@keyframes shieldGlow {
    from { box-shadow: 0 0 8px 2px rgba(255, 215, 0, 0.6); }
    to   { box-shadow: 0 0 20px 6px rgba(255, 215, 0, 1); }
}

@keyframes hitFlash {
    0%   { opacity: 1; }
    20%  { opacity: 0.1; }
    40%  { opacity: 1; }
    60%  { opacity: 0.1; }
    80%  { opacity: 1; }
    100% { opacity: 1; }
}

@keyframes celebrateJump {
    0%   { transform: translateY(0) scale(1); }
    30%  { transform: translateY(-18px) scale(1.08); }
    55%  { transform: translateY(-8px) scale(1.04); }
    75%  { transform: translateY(-14px) scale(1.06); }
    100% { transform: translateY(0) scale(1); }
}

@keyframes screenShake {
    0%,100% { transform: translate(0,0); }
    15%     { transform: translate(-8px, 4px); }
    30%     { transform: translate(8px, -4px); }
    45%     { transform: translate(-6px, -6px); }
    60%     { transform: translate(6px, 4px); }
    75%     { transform: translate(-4px, 2px); }
}

@keyframes particleBurst {
    0%   { transform: translate(0,0) scale(1); opacity: 1; }
    100% { transform: translate(var(--px), var(--py)) scale(0); opacity: 0; }
}

/* Golden double-points glow around basket */
#basket.doublePoints img {
    animation: goldPulse 0.5s ease-in-out infinite alternate;
    outline: 3px solid gold;
    outline-offset: 3px;
    border-radius: 4px;
}
@keyframes goldPulse {
    from { filter: drop-shadow(0 0 6px rgba(255,215,0,0.8)); }
    to   { filter: drop-shadow(0 0 18px rgba(255,215,0,1)) brightness(1.1); }
}

/* Double points banner */
#doublePointsBanner, #doubleBanner {
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #000;
    font-weight: bold;
    font-size: 14px;
    padding: 4px 14px;
    border-radius: 20px;
    box-shadow: 0 0 12px rgba(255,215,0,0.8);
    display: none;
    z-index: 50;
    white-space: nowrap;
}




/* Love message overlay */
#loveOverlay {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, rgba(180,0,60,0.95), rgba(255,100,150,0.95));
    z-index: 1500;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 40px 30px;
    backdrop-filter: blur(4px);
    animation: fadeIn 0.4s ease;
}
#loveOverlay .love-emoji { font-size: 64px; margin-bottom: 16px; }
#loveOverlay .love-msg   { font-size: clamp(1.3rem,5vw,2rem); color: white; font-weight: 600; line-height: 1.5; text-shadow: 0 2px 8px rgba(0,0,0,0.4); }
#loveOverlay .level-tag  { margin-top: 20px; font-size: 1.1rem; color: rgba(255,255,255,0.8); }

/* Messages */
#message {
    position: absolute;
    top: 35%;
    width: 100%;
    font-size: 28px;
    color: white;
    display: none;
    padding: 0 20px;
    animation: fadeIn 2s ease-in-out;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
}

#popupText {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    font-weight: bold;
    color: #FFD700;
    text-shadow: 3px 3px 10px rgba(0,0,0,0.8);
    opacity: 0;
    pointer-events: none;
    z-index: 150;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Floating love text */
.loveText {
    position: absolute;
    color: white;
    font-weight: bold;
    font-size: 18px;
    text-shadow: 2px 2px 6px rgba(0,0,0,0.5);
    animation: floatUp 6s ease-in forwards;
    pointer-events: none;
    z-index: 5;
}

@keyframes floatUp {
    from { transform: translateY(100vh); opacity: 0; }
    20% { opacity: 1; }
    80% { opacity: 1; }
    to { transform: translateY(-20vh); opacity: 0; }
}

/* Particle burst */
.particle {
    position: absolute;
    width: 8px;
    height: 8px;
    background: radial-gradient(circle, #FFD700, #FF69B4);
    border-radius: 50%;
    pointer-events: none;
    animation: particleBurst 0.8s ease-out forwards;
}

/* Menu overlay */
#menuOverlay, #gameOver, #howToPlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 30px;
    backdrop-filter: blur(6px);
}

#menuOverlay h1 {
    font-size: clamp(2rem, 8vw, 3.5rem);
    margin-bottom: 20px;
    background: linear-gradient(135deg, #ff758c, #FFD700);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.menu-buttons {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 20px;
}

.menu-button, .restart-btn {
    background: linear-gradient(135deg, #ff758c, #ff7eb3);
    color: white;
    border: none;
    padding: 15px 40px;
    font-size: 18px;
    font-weight: bold;
    border-radius: 50px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
}

.menu-button:active, .restart-btn:active {
    transform: scale(0.95);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.difficulty-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
}

.difficulty-btn {
    background: rgba(255,255,255,0.2);
    color: white;
    border: 2px solid white;
    padding: 10px 25px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.difficulty-btn.selected {
    background: white;
    color: #ff758c;
}

/* How to Play */
#howToPlay {
    display: none;
    overflow-y: auto;
}

.how-to-content {
    max-width: 500px;
    background: rgba(255,255,255,0.1);
    padding: 30px;
    border-radius: 20px;
    backdrop-filter: blur(10px);
}

.how-to-content h2 {
    color: white;
    margin-bottom: 20px;
    font-size: 28px;
}

.how-to-content p, .how-to-content ul {
    color: white;
    text-align: left;
    line-height: 1.8;
    margin-bottom: 15px;
}

.how-to-content ul {
    list-style-position: inside;
}

/* Game Over Screen */
#gameOver {
    display: none;
}

.game-over-content {
    background: rgba(255,255,255,0.1);
    padding: 40px 30px;
    border-radius: 20px;
    backdrop-filter: blur(10px);
    max-width: 400px;
}

#gameOverTitle {
    font-size: 36px;
    color: white;
    margin-bottom: 20px;
}

#gameOverImg {
    font-size: 80px;
    margin-bottom: 20px;
}

#gameOverScore, #gameOverHigh, #gameOverStreak, #gameOverLevel {
    color: white;
    font-size: 18px;
    margin: 10px 0;
}

/* Sound toggle */
#soundToggle {
    position: fixed;
    top: max(10px, env(safe-area-inset-top, 10px));
    right: 15px;
    z-index: 200;
    background: rgba(0,0,0,0.3);
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 50px;
    font-size: 20px;
    cursor: pointer;
    transition: background 0.3s;
}

#soundToggle:active {
    background: rgba(0,0,0,0.5);
}

/* Lives display */
#lives {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 24px;
    z-index: 50;
}

/* Level transition overlay */
#levelTransition {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    z-index: 2000;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 40px;
    animation: fadeIn 0.5s ease;
}

#levelTransition .level-number {
    font-size: clamp(3rem, 10vw, 6rem);
    color: white;
    font-weight: bold;
    margin-bottom: 20px;
    text-shadow: 0 0 20px rgba(255,255,255,0.5);
}

#levelTransition .level-theme {
    font-size: clamp(1.5rem, 6vw, 2.5rem);
    color: #FFD700;
    margin-bottom: 10px;
}

#levelTransition .level-description {
    font-size: 18px;
    color: rgba(255,255,255,0.8);
    max-width: 400px;
}
</style>
</head>
<body class="level-1">

<!-- Sound Toggle -->
<button id="soundToggle" onclick="toggleSound()">üîä</button>

<!-- Lives Display -->
<div id="lives"></div>

<!-- Double Points Banner -->
<div id="doubleBanner">‚≠ê DOUBLE POINTS ‚≠ê</div>

<!-- Menu Overlay -->
<div id="menuOverlay">
    <h1>Catch the Love üíï</h1>
    <div style="font-size: 60px; margin: 20px 0;">‚ù§Ô∏è</div>
    <p style="color: white; font-size: 18px; margin-bottom: 10px;">A Game Made with Love for Beatrix</p>
    
    <div class="menu-buttons">
        <button class="menu-button" onclick="showDifficultySelect()">‚ñ∂Ô∏è Start Game</button>
        <button class="menu-button" onclick="showHowToPlay()">‚ùì How to Play</button>
    </div>
    
    <div id="difficultySelect" style="display: none; margin-top: 30px;">
        <p style="color: white; font-size: 20px; margin-bottom: 15px;">Select Difficulty</p>
        <div class="difficulty-buttons">
            <button class="difficulty-btn" onclick="selectDifficulty('easy')">Easy</button>
            <button class="difficulty-btn selected" onclick="selectDifficulty('medium')">Medium</button>
            <button class="difficulty-btn" onclick="selectDifficulty('hard')">Hard</button>
        </div>
        <button class="menu-button" onclick="startGame()" style="margin-top: 20px;">Start! üöÄ</button>
    </div>
    
    <p style="color: rgba(255,255,255,0.6); margin-top: 30px; font-size: 14px;">
        High Score: <span id="menuHighScore">0</span> ‚ù§Ô∏è
    </p>
</div>

<!-- How to Play -->
<div id="howToPlay">
    <div class="how-to-content">
        <h2>How to Play üéÆ</h2>
        <p><strong>Goal:</strong> Catch falling hearts to collect 10 hearts per level and complete all 5 levels!</p>
        
        <ul>
            <li>‚ù§Ô∏è <strong>Hearts:</strong> Catch them! Each heart = 1 point</li>
            <li>‚≠ê <strong>Power-ups:</strong> Get invincibility shield + double points for 5 seconds</li>
            <li>üí£ <strong>Bombs:</strong> Avoid! Loses 1 life</li>
            <li>üçÜ <strong>Easter Egg:</strong> Loses 1 heart from your level progress</li>
        </ul>
        
        <p><strong>Controls:</strong> Drag or touch to move the basket</p>
        
        <p><strong>Lives:</strong> You have 3 lives. Missing a heart or catching a bomb costs a life!</p>
        
        <button class="menu-button" onclick="closeHowToPlay()">Got it! üëç</button>
    </div>
</div>

<!-- Level Transition -->
<div id="levelTransition">
    <div class="level-number"></div>
    <div class="level-theme"></div>
    <div class="level-description"></div>
</div>

<!-- Game Over Screen -->
<div id="gameOver">
    <div class="game-over-content">
        <h2 id="gameOverTitle">Game Over üíî</h2>
        <div id="gameOverImg">üò¢</div>
        <p id="gameOverScore">Score: 0</p>
        <p id="gameOverHigh">High Score: 0</p>
        <p id="gameOverStreak">Max Streak: 0</p>
        <p id="gameOverLevel">Level: 1</p>
        <button class="restart-btn" onclick="restartGame()">Play Again üîÑ</button>
        <button class="restart-btn" onclick="backToMenu()" style="background: linear-gradient(135deg, #667eea, #764ba2); margin-top: 10px;">Main Menu üè†</button>
    </div>
</div>

<!-- Header -->
<div class="header">
    <h1>Catch the Love ‚ù§Ô∏è</h1>
    <div id="scoreBoard">
        <div class="stat">‚ù§Ô∏è <span id="heartsDisplay">0/10</span></div>
        <div class="stat">Level <span id="level">1</span></div>
        <div class="stat">Streak: <span id="streak">0</span></div>
        <div class="stat" id="combo"></div>
    </div>
</div>

<!-- Game Area -->
<div id="gameArea">
    <div id="message"></div>
    <div id="popupText"></div>
    <div id="basket"><img id="basketImg" src="me.png" style="height:90px;width:auto;display:block;filter:drop-shadow(0 4px 10px rgba(0,0,0,0.5));"></div>
</div>

<!-- Love Overlay -->
<div id="loveOverlay">
    <div class="love-emoji">üíï</div>
    <div class="love-msg">I love you, Beatrix!</div>
    <div class="level-tag">Keep going, my love! ‚ù§Ô∏è</div>
</div>

<script>
/* Base64 Images */
const ME_SAD = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23FFE4C4'/%3E%3Ccircle cx='35' cy='40' r='5' fill='%23000'/%3E%3Ccircle cx='65' cy='40' r='5' fill='%23000'/%3E%3Cpath d='M 30 70 Q 50 60 70 70' fill='none' stroke='%23000' stroke-width='3'/%3E%3C/svg%3E";
const ME_HAPPY = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23FFE4C4'/%3E%3Ccircle cx='35' cy='40' r='5' fill='%23000'/%3E%3Ccircle cx='65' cy='40' r='5' fill='%23000'/%3E%3Cpath d='M 30 60 Q 50 75 70 60' fill='none' stroke='%23000' stroke-width='3'/%3E%3C/svg%3E";

/* Level Themes */
const levelThemes = {
    1: {
        name: "Sweet Beginnings",
        description: "Pink skies of love",
        className: "level-1"
    },
    2: {
        name: "Ocean of Dreams",
        description: "Aqua waves of affection",
        className: "level-2"
    },
    3: {
        name: "Sunset Romance",
        description: "Warm peach glow",
        className: "level-3"
    },
    4: {
        name: "Starlight Magic",
        description: "Purple cosmic love",
        className: "level-4"
    },
    5: {
        name: "Golden Horizon",
        description: "The final adventure",
        className: "level-5"
    }
};

/* Game Variables */
const basket = document.getElementById("basket");
const gameArea = document.getElementById("gameArea");
const scoreDisplay = document.getElementById("heartsDisplay");
const levelDisplay = document.getElementById("level");
const streakDisplay = document.getElementById("streak");
const comboDisplay = document.getElementById("combo");
const message = document.getElementById("message");
const popupText = document.getElementById("popupText");
const livesDisplay = document.getElementById("lives");

let score = 0;
let heartsThisLevel = 0;
let level = 1;
let streak = 0;
let maxStreak = 0;
let combo = 0;
let lives = 3;
let gameStarted = false;
let spawnInterval;
let difficulty = 'medium';
let invincible = false;
let doublePoints = false;
let soundEnabled = true;
let highScore = localStorage.getItem('beatrix_highscore') || 0;
document.getElementById('menuHighScore').textContent = highScore;

/* Love messages */
const loveMessages = [
    "You're my sunshine! ‚òÄÔ∏è",
    "Forever yours üíï",
    "My heart beats for you üíì",
    "You make me smile üòä",
    "Best thing ever! ‚ú®",
    "Love you infinity! ‚àû"
];

const funnyMessages = [
    "üî• ON FIRE!",
    "üí´ AMAZING!",
    "‚ö° UNSTOPPABLE!",
    "üåü PERFECT!",
    "üíù INCREDIBLE!",
    "üéØ LEGEND!"
];

/* Sound Effects */
const sounds = {
    catch: new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA='),
    bomb: new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA='),
    powerup: new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA='),
    combo: new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA='),
    levelup: new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA='),
    gameover: new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA='),
    win: new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA='),
    easteregg: new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA='),
    spawn: new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=')
};

const music = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=');
music.loop = true;
music.volume = 0.3;

function playSound(type) {
    if (soundEnabled && sounds[type]) {
        sounds[type].currentTime = 0;
        sounds[type].play().catch(() => {});
    }
}

function toggleSound() {
    soundEnabled = !soundEnabled;
    document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîá';
    if (soundEnabled) {
        music.play().catch(() => {});
    } else {
        music.pause();
    }
}

/* Menu Functions */
function showDifficultySelect() {
    document.getElementById('difficultySelect').style.display = 'block';
}

function selectDifficulty(diff) {
    difficulty = diff;
    document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('selected'));
    event.target.classList.add('selected');
}

function showHowToPlay() {
    document.getElementById('menuOverlay').style.display = 'none';
    document.getElementById('howToPlay').style.display = 'flex';
}

function closeHowToPlay() {
    document.getElementById('howToPlay').style.display = 'none';
    document.getElementById('menuOverlay').style.display = 'flex';
}

function backToMenu() {
    location.reload();
}

/* Game Functions */
function startGame() {
    document.getElementById('menuOverlay').style.display = 'none';
    gameStarted = true;
    lives = 3;
    score = 0;
    heartsThisLevel = 0;
    level = 1;
    streak = 0;
    combo = 0;
    updateLivesDisplay();
    updateHeartsDisplay();
    updateLevelTheme();
    showLevelTransition();
    
    let spawnRate = 1200;
    if (difficulty === 'easy') spawnRate = 1500;
    if (difficulty === 'hard') spawnRate = 900;
    
    spawnInterval = setInterval(createItem, spawnRate);
    setInterval(createSparkle, 300);
    setInterval(createLoveText, 4000);
    
    startCollisionLoop();
    
    if (soundEnabled) music.play().catch(() => {});
}

function updateLevelTheme() {
    const theme = levelThemes[level];
    if (theme) {
        document.body.className = theme.className;
    }
}

function showLevelTransition() {
    const theme = levelThemes[level];
    if (!theme) return;
    
    const transition = document.getElementById('levelTransition');
    transition.querySelector('.level-number').textContent = `Level ${level}`;
    transition.querySelector('.level-theme').textContent = theme.name;
    transition.querySelector('.level-description').textContent = theme.description;
    
    transition.style.display = 'flex';
    
    setTimeout(() => {
        transition.style.display = 'none';
    }, 2500);
}

function restartGame() {
    document.getElementById('gameOver').style.display = 'none';
    startGame();
}

function updateHeartsDisplay() {
    scoreDisplay.textContent = `${heartsThisLevel}/10`;
    levelDisplay.textContent = level;
    streakDisplay.textContent = streak;
}

function updateLivesDisplay() {
    livesDisplay.textContent = 'üíñ'.repeat(lives);
}

function loseLife() {
    lives--;
    updateLivesDisplay();
    
    if (lives <= 0) {
        gameOver();
    }
}

function gameOver() {
    const imgEl = document.getElementById('gameOverImg');
    imgEl.innerHTML = `<img src="${ME_SAD}">`;
    document.getElementById('gameOverTitle').textContent = 'üíî Game Over';
    
    if (score > highScore) {
        highScore = score;
        localStorage.setItem('beatrix_highscore', highScore);
    }
    
    document.getElementById('gameOverScore').textContent = `${score} hearts collected üíñ`;
    document.getElementById('gameOverHigh').textContent = `Best: ${highScore} üèÜ`;
    document.getElementById('gameOverStreak').textContent = `Max Streak: ${maxStreak} üî•`;
    document.getElementById('gameOverLevel').textContent = `Reached Level ${level}`;
    
    gameStarted = false;
    clearInterval(spawnInterval);
    playSound('gameover');
    
    setTimeout(() => {
        document.getElementById('gameOver').style.display = 'flex';
    }, 1000);
}

function checkLevelUp() {
    if (heartsThisLevel >= 10) {
        heartsThisLevel = 0;
        level++;
        levelDisplay.textContent = level;
        updateHeartsDisplay();
        updateLevelTheme();
        showLevelTransition();
        playSound('levelup');
        showLoveMessage();
    }
}

function showLoveMessage() {
    const overlay = document.getElementById('loveOverlay');
    overlay.style.display = 'flex';
    setTimeout(() => {
        overlay.style.display = 'none';
    }, 2500);
}

/* Basket movement */
let isDragging = false;
let basketX = window.innerWidth / 2;

function getGameWidth() {
    return window.visualViewport ? window.visualViewport.width : window.innerWidth;
}

function updateBasketPosition(clientX) {
    const gameWidth = getGameWidth();
    basketX = Math.max(40, Math.min(gameWidth - 40, clientX));
    basket.style.left = basketX + 'px';
    basket.style.transform = 'translateX(-50%)';
}

gameArea.addEventListener('mousedown', (e) => {
    if (!gameStarted) return;
    isDragging = true;
    updateBasketPosition(e.clientX);
});

document.addEventListener('mousemove', (e) => {
    if (isDragging && gameStarted) {
        updateBasketPosition(e.clientX);
    }
});

document.addEventListener('mouseup', () => {
    isDragging = false;
});

gameArea.addEventListener('touchstart', (e) => {
    if (!gameStarted) return;
    e.preventDefault();
    isDragging = true;
    updateBasketPosition(e.touches[0].clientX);
}, { passive: false });

document.addEventListener('touchmove', (e) => {
    if (isDragging && gameStarted) {
        e.preventDefault();
        updateBasketPosition(e.touches[0].clientX);
    }
}, { passive: false });

document.addEventListener('touchend', () => {
    isDragging = false;
});

/* Basket reactions */
function reactToHeart() {
    basket.style.animation = 'celebrateJump 0.5s ease';
    const basketImg = document.getElementById('basketImg');
    console.log('Heart caught! Changing to me3.jpg');
    basketImg.src = 'me3.jpg?' + new Date().getTime();
    setTimeout(() => { 
        basket.style.animation = ''; 
        console.log('Changing back to me.png');
        basketImg.src = 'me.png?' + new Date().getTime();
    }, 2000);
}

function reactToHit() {
    basket.style.animation = 'hitFlash 0.4s ease';
    const basketImg = document.getElementById('basketImg');
    console.log('Hit by bomb/easter egg! Changing to me2.jpg');
    basketImg.src = 'me2.jpg?' + new Date().getTime();
    setTimeout(() => { 
        basket.style.animation = ''; 
        console.log('Changing back to me.png');
        basketImg.src = 'me.png?' + new Date().getTime();
    }, 2000);
}

function screenShake() {
    gameArea.style.animation = 'screenShake 0.4s ease';
    setTimeout(() => { gameArea.style.animation = ''; }, 400);
}

function spawnParticles(x, y) {
    for (let i = 0; i < 8; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        const angle = (i / 8) * Math.PI * 2;
        const distance = 50 + Math.random() * 30;
        particle.style.left = x + 'px';
        particle.style.top = y + 'px';
        particle.style.setProperty('--px', Math.cos(angle) * distance + 'px');
        particle.style.setProperty('--py', Math.sin(angle) * distance + 'px');
        gameArea.appendChild(particle);
        setTimeout(() => particle.remove(), 800);
    }
}

/* Double Points */
function activateDoublePoints() {
    doublePoints = true;
    basket.classList.add('doublePoints');
    document.getElementById('doubleBanner').style.display = 'block';
    
    setTimeout(() => {
        doublePoints = false;
        basket.classList.remove('doublePoints');
        document.getElementById('doubleBanner').style.display = 'none';
    }, 5000);
}

/* Auto-play music on first interaction */
document.body.addEventListener('touchstart', () => {
    if (gameStarted) music.play().catch(() => {});
}, { passive: true, once: true });

/* Create falling items */
function createItem() {
    const rand = Math.random();
    let item;
    
    if (rand < 0.25) {
        // Regular heart
        item = createHeart();
    } else if (rand < 0.35) {
        // Power-up
        item = createPowerup();
    } else if (rand < 0.40) {
        // Bomb
        item = createBomb();
    } else {
        // Flying penis easter egg (60% chance - it's EVERYWHERE!)
        item = createEasterEgg();
    }
}

function createHeart() {
    const heart = document.createElement("div");
    heart.classList.add("heart");
    const hearts = ["‚ù§Ô∏è", "üíï", "üíñ", "üíó", "üíì", "üíù"];
    heart.innerHTML = hearts[Math.floor(Math.random() * hearts.length)];
    heart.style.left = Math.random() * (getGameWidth() - 50) + "px";
    heart.style.animationDuration = (2 + Math.random() * 2) + "s";
    if (difficulty === 'hard') heart.style.animationDuration = (1.5 + Math.random() * 1) + "s";
    if (difficulty === 'easy') heart.style.animationDuration = (3 + Math.random() * 2) + "s";
    gameArea.appendChild(heart);
    activeItems.push({ el: heart, type: 'heart' });
}

function createPowerup() {
    const powerup = document.createElement("div");
    powerup.classList.add("powerup");
    const powerups = ["‚≠ê", "üí´", "‚ú®", "üåü"];
    powerup.innerHTML = powerups[Math.floor(Math.random() * powerups.length)];
    powerup.style.left = Math.random() * (getGameWidth() - 50) + "px";
    const fallDuration = (2 + Math.random() * 2).toFixed(2) + "s";
    powerup.style.animationDuration = fallDuration + ", 0.6s";
    gameArea.appendChild(powerup);
    activeItems.push({ el: powerup, type: 'powerup' });
}

function createBomb() {
    const bomb = document.createElement("div");
    bomb.classList.add("bomb");
    bomb.innerHTML = "üí£";
    bomb.style.left = Math.random() * (getGameWidth() - 50) + "px";
    bomb.style.animationDuration = (2 + Math.random() * 1.5) + "s";
    gameArea.appendChild(bomb);
    activeItems.push({ el: bomb, type: 'bomb' });
}

function createEasterEgg() {
    const egg = document.createElement("div");
    egg.classList.add("bomb");
    egg.innerHTML = "üçÜ";
    egg.style.left = Math.random() * (getGameWidth() - 50) + "px";
    egg.style.animationDuration = (1.5 + Math.random() * 1) + "s";
    egg.style.fontSize = "35px";
    gameArea.appendChild(egg);
    playSound('spawn');
    activeItems.push({ el: egg, type: 'easteregg' });
}

/* Unified RAF-based collision loop ‚Äî replaces per-item setInterval */
let activeItems = []; // { el, type }
let collisionLoopRunning = false;

function startCollisionLoop() {
    if (collisionLoopRunning) return;
    collisionLoopRunning = true;
    rafCollisionLoop();
}

function rafCollisionLoop() {
    if (!gameStarted && activeItems.length === 0) { collisionLoopRunning = false; return; }

    const basketRect = basket.getBoundingClientRect();
    const viewH = window.visualViewport ? window.visualViewport.height : window.innerHeight;

    for (let i = activeItems.length - 1; i >= 0; i--) {
        const { el, type } = activeItems[i];
        const itemRect = el.getBoundingClientRect();

        // Caught
        if (
            itemRect.bottom >= basketRect.top &&
            itemRect.left < basketRect.right &&
            itemRect.right > basketRect.left
        ) {
            handleCatch(type, itemRect);
            el.remove();
            activeItems.splice(i, 1);
            continue;
        }

        // Missed ‚Äî fell off screen
        if (itemRect.top > viewH) {
            el.remove();
            activeItems.splice(i, 1);
            if (type === 'heart') {
                streak = 0;
                combo = 0;
                streakDisplay.textContent = streak;
                comboDisplay.textContent = "";
                // Missing a heart costs a life
                if (gameStarted) {
                    showPopup("üíî MISSED!");
                    loseLife();
                }
            }
        }
    }

    requestAnimationFrame(rafCollisionLoop);
}

function handleCatch(type, itemRect) {
    if (type === 'heart') {
        heartsThisLevel++;
        score++;
        streak++;
        combo++;
        updateHeartsDisplay();

        if (itemRect) {
            const cx = itemRect.left + itemRect.width / 2 - gameArea.getBoundingClientRect().left;
            const cy = itemRect.top + itemRect.height / 2 - gameArea.getBoundingClientRect().top;
            spawnParticles(cx, cy);
        }

        if (doublePoints) {
            heartsThisLevel++;
            score++;
            updateHeartsDisplay();
            showPopup(`üíõ DOUBLE! +2 ‚ù§Ô∏è`);
        }

        if (combo > 2) {
            comboDisplay.textContent = `${combo}x COMBO!`;
            comboDisplay.classList.add('pulse');
            setTimeout(() => comboDisplay.classList.remove('pulse'), 200);
            playSound('combo');
            if (!doublePoints) showPopup(funnyMessages[Math.floor(Math.random() * funnyMessages.length)]);
        } else {
            playSound('catch');
        }

        reactToHeart();
        checkLevelUp();
        if (streak > maxStreak) maxStreak = streak;

    } else if (type === 'powerup') {
        playSound('powerup');
        showPopup("‚≠ê 2x POINTS! ‚≠ê");
        activatePowerup();
        activateDoublePoints();

    } else if (type === 'bomb') {
        if (!invincible) {
            streak = 0; combo = 0;
            streakDisplay.textContent = streak;
            comboDisplay.textContent = "";
            playSound('bomb');
            showPopup("üí• BOMB! -1 Life üíî");
            reactToHit();
            screenShake();
            loseLife();          // üí£ costs a LIFE
        } else {
            showPopup("üõ°Ô∏è PROTECTED!");
        }

    } else if (type === 'easteregg') {
        // üçÜ costs a HEART (from level progress)
        if (heartsThisLevel > 0) {
            heartsThisLevel--;
            score = Math.max(0, score - 1);
            updateHeartsDisplay();
        }
        streak = 0; combo = 0;
        streakDisplay.textContent = streak;
        comboDisplay.textContent = "";
        playSound('easteregg');
        showPopup("üçÜ OUCH! -1 ‚ù§Ô∏è üòÇ");
        reactToHit();
        screenShake();
    }

    // Win condition: reach level 6 (complete 5 levels of 10 hearts)
    if (level > 5 && gameStarted) {
        const imgEl = document.getElementById('gameOverImg');
        imgEl.innerHTML = `<img src="${ME_HAPPY}">`;
        document.getElementById('gameOverTitle').textContent = 'üéâ You Won!';
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('beatrix_highscore', highScore);
        }
        document.getElementById('gameOverScore').textContent = `${score} hearts collected üíñ`;
        document.getElementById('gameOverHigh').textContent = `Best: ${highScore} üèÜ`;
        document.getElementById('gameOverLevel').textContent = `Completed all 5 levels!`;
        gameStarted = false;
        clearInterval(spawnInterval);
        message.style.display = "block";
        playSound('win');
        showPopup("üéâ YOU WIN! üéâ");
        setTimeout(() => {
            document.getElementById('gameOver').style.display = 'flex';
        }, 2000);
    }
}

function activatePowerup() {
    invincible = true;
    basket.classList.add('invincible');
    activateDoublePoints();
    setTimeout(() => {
        invincible = false;
        basket.classList.remove('invincible');
    }, 5000);
}

function showPopup(text) {
    popupText.textContent = text;
    popupText.style.opacity = 1;
    popupText.style.transform = 'translate(-50%, -50%) scale(1)';
    
    setTimeout(() => {
        popupText.style.transition = 'all 0.5s ease-out';
        popupText.style.opacity = 0;
        popupText.style.transform = 'translate(-50%, -80%) scale(0.5)';
    }, 800);
    
    setTimeout(() => {
        popupText.style.transition = '';
    }, 1300);
}

/* Sparkles */
function createSparkle() {
    const sparkle = document.createElement("div");
    sparkle.classList.add("sparkle");
    sparkle.style.left = Math.random() * getGameWidth() + "px";
    sparkle.style.animationDuration = (3 + Math.random() * 3) + "s";
    document.body.appendChild(sparkle);
    setTimeout(() => sparkle.remove(), 6000);
}

/* Floating Love Text */
function createLoveText() {
    const text = document.createElement("div");
    text.classList.add("loveText");
    text.innerHTML = loveMessages[Math.floor(Math.random() * loveMessages.length)];
    text.style.left = Math.random() * (getGameWidth() - 200) + "px";
    document.body.appendChild(text);
    setTimeout(() => text.remove(), 6000);
}

</script>

</body>
</html>
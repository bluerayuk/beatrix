<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#ff758c">
<title>Catch the Love - For Beatrix ‚ù§Ô∏è</title>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    margin: 0;
    overflow: hidden;
    background: linear-gradient(to bottom, #ff758c, #ff7eb3);
    font-family: -apple-system, BlinkMacSystemFont, 'Arial', sans-serif;
    text-align: center;
    touch-action: none;
    position: fixed;
    width: 100%;
    height: 100vh;
    height: 100dvh;
    /* Prevent Safari elastic bounce */
    overscroll-behavior: none;
}

/* Header */
.header {
    position: relative;
    z-index: 100;
    padding: 10px 15px;
    padding-top: max(10px, env(safe-area-inset-top, 10px));
    background: rgba(0,0,0,0.2);
}

h1 {
    color: white;
    font-size: 22px;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.4);
    margin-bottom: 5px;
}

#scoreBoard {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
}

.stat {
    color: white;
    font-size: 16px;
    font-weight: bold;
    text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
}

#combo {
    color: #FFD700;
    font-size: 20px;
    transform: scale(1);
    transition: transform 0.2s;
}

#combo.pulse {
    transform: scale(1.3);
}

/* Sparkles */
.sparkle {
    position: absolute;
    width: 6px;
    height: 6px;
    background: white;
    border-radius: 50%;
    opacity: 0.8;
    animation: sparkleFloat 4s linear infinite;
    pointer-events: none;
}

@keyframes sparkleFloat {
    from { transform: translateY(100vh) scale(0.5); opacity: 0; }
    50% { opacity: 1; }
    to { transform: translateY(-10vh) scale(1.2); opacity: 0; }
}

#gameArea {
    position: relative;
    width: 100vw;
    /* Fallback for older Safari, then use dvh */
    height: calc(100vh - 100px);
    height: calc(100dvh - 100px);
    overflow: hidden;
}

/* Hearts and Items */
.heart, .powerup, .bomb {
    position: absolute;
    font-size: 28px;
    animation: fall linear;
    cursor: pointer;
    user-select: none;
}

.powerup {
    font-size: 32px;
    animation: fall linear, spin 2s linear infinite;
}

.bomb {
    font-size: 30px;
    animation: fallWobble linear;
}

@keyframes fall {
    from { transform: translateY(-50px); }
    to { transform: translateY(calc(100vh + 50px)); }
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

@keyframes wobble {
    0%, 100% { transform: translateY(var(--fall-pos)) rotate(-5deg); }
    50% { transform: translateY(var(--fall-pos)) rotate(5deg); }
}

@keyframes fallWobble {
    from { transform: translateY(-50px) rotate(-5deg); }
    25% { transform: translateY(calc(25vh)) rotate(5deg); }
    50% { transform: translateY(calc(50vh)) rotate(-5deg); }
    75% { transform: translateY(calc(75vh)) rotate(5deg); }
    to { transform: translateY(calc(100vh + 50px)) rotate(-5deg); }
}

#basket {
    position: absolute;
    bottom: max(20px, env(safe-area-inset-bottom, 20px) + 10px);
    font-size: 60px;
    left: 50%;
    transform: translateX(-50%);
    transition: left 0.05s linear;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    z-index: 10;
    /* Ensure instant touch response */
    touch-action: none;
    will-change: left;
}

#basket.invincible {
    animation: rainbow 0.5s linear infinite;
}

@keyframes rainbow {
    0% { filter: hue-rotate(0deg) drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }
    100% { filter: hue-rotate(360deg) drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }
}

/* Messages */
#message {
    position: absolute;
    top: 35%;
    width: 100%;
    font-size: 28px;
    color: white;
    display: none;
    padding: 0 20px;
    animation: fadeIn 2s ease-in-out;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
}

#popupText {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    font-weight: bold;
    color: #FFD700;
    text-shadow: 3px 3px 10px rgba(0,0,0,0.8);
    opacity: 0;
    pointer-events: none;
    z-index: 1000;
}

.loveText {
    position: absolute;
    color: white;
    font-size: 16px;
    opacity: 0.8;
    animation: floatLove 6s linear forwards;
    text-shadow: 1px 1px 4px rgba(0,0,0,0.4);
    pointer-events: none;
}

@keyframes floatLove {
    from { transform: translateY(100vh); opacity: 0; }
    20% { opacity: 1; }
    to { transform: translateY(-20vh); opacity: 0; }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Back button */
.backBtn {
    position: absolute;
    top: max(15px, env(safe-area-inset-top, 0px) + 8px);
    left: max(15px, env(safe-area-inset-left, 0px) + 10px);
    padding: 10px 20px;
    background: rgba(255,255,255,0.3);
    border: 2px solid white;
    border-radius: 20px;
    color: white;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    text-decoration: none;
    z-index: 101;
    transition: all 0.2s;
    touch-action: manipulation;
    -webkit-user-select: none;
    user-select: none;
    min-height: 44px;
    display: flex;
    align-items: center;
}

.backBtn:active {
    transform: scale(0.95);
    background: rgba(255,255,255,0.5);
}

/* Difficulty selector */
#difficultySelect {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255,255,255,0.95);
    padding: 25px 20px;
    border-radius: 20px;
    z-index: 1000;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    width: min(320px, 90vw);
}

#difficultySelect h2 {
    color: #ff758c;
    margin-bottom: 20px;
}

.diffBtn {
    display: block;
    width: 100%;
    margin: 10px auto;
    padding: 15px;
    background: linear-gradient(145deg, #ff758c, #ff7eb3);
    border: none;
    border-radius: 10px;
    color: white;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.15s;
    touch-action: manipulation;
    -webkit-user-select: none;
    user-select: none;
    min-height: 54px;
    -webkit-appearance: none;
    appearance: none;
}
</style>
</head>

<body>

<a href="index.html" class="backBtn">‚Üê Back</a>

<div id="difficultySelect">
    <h2>Choose Your Challenge!</h2>
    <button class="diffBtn" onclick="startGame('easy')">üòä Easy - Chill Vibes</button>
    <button class="diffBtn" onclick="startGame('normal')">üòé Normal - Fun Times</button>
    <button class="diffBtn" onclick="startGame('hard')">üî• Hard - Pro Catcher!</button>
</div>

<div class="header">
    <h1>Catch the Love, Beatrix ‚ù§Ô∏è</h1>
    <div id="scoreBoard">
        <div class="stat">‚ù§Ô∏è <span id="score">0</span></div>
        <div class="stat">‚ö° <span id="streak">0</span></div>
        <div class="stat" id="combo"></div>
    </div>
</div>

<div id="gameArea">
    <div id="basket">üíñ</div>
    <div id="message">Beatrix, I Love You Forever ‚ù§Ô∏è</div>
    <div id="popupText"></div>
</div>

<audio id="bgMusic" loop>
    <source src="1.mp3" type="audio/mpeg">
</audio>

<script>
let score = 0;
let streak = 0;
let maxStreak = 0;
let combo = 0;
let invincible = false;
let speedBoost = false;
let gameStarted = false;
let difficulty = 'normal';

const basket = document.getElementById("basket");
const gameArea = document.getElementById("gameArea");
const scoreDisplay = document.getElementById("score");
const streakDisplay = document.getElementById("streak");
const comboDisplay = document.getElementById("combo");
const message = document.getElementById("message");
const music = document.getElementById("bgMusic");
const popupText = document.getElementById("popupText");

let spawnInterval;
let basketSpeed = 1;

const loveMessages = [
    "You are my forever ‚ù§Ô∏è",
    "My heart is yours üíï",
    "You are my dream ‚ú®",
    "Always and forever üíñ",
    "My beautiful Beatrix üí´",
    "You complete me üåü",
    "Forever yours üíù",
    "You're amazing! üéâ"
];

const funnyMessages = [
    "BOINK! üòÑ",
    "Nice catch! üéØ",
    "Smooth! üòé",
    "On fire! üî•",
    "Wow! ‚ö°",
    "Perfect! ‚ú®",
    "Combo! üí•",
    "Streak! üåü"
];

// Lazy AudioContext ‚Äî Safari requires user gesture before creation
let audioContext = null;

function getAudioContext() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioContext.state === 'suspended') {
        audioContext.resume();
    }
    return audioContext;
}

function playSound(type) {
    try {
        if (typeof AudioContext === 'undefined' && typeof webkitAudioContext === 'undefined') return;
        const audioContext = getAudioContext();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        switch(type) {
            case 'catch':
                oscillator.type = 'sine';
                oscillator.frequency.value = 800 + (combo * 50);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
                break;
                
            case 'powerup':
                oscillator.type = 'square';
                oscillator.frequency.value = 600;
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                oscillator.start(audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.2);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                oscillator.stop(audioContext.currentTime + 0.2);
                break;
                
            case 'bomb':
                oscillator.type = 'sawtooth';
                oscillator.frequency.value = 100;
                gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
                break;
                
            case 'combo':
                for (let i = 0; i < 3; i++) {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.type = 'sine';
                    osc.frequency.value = 800 + (i * 200);
                    gain.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.05 + 0.1);
                    osc.start(audioContext.currentTime + i * 0.05);
                    osc.stop(audioContext.currentTime + i * 0.05 + 0.1);
                }
                break;
                
            case 'win':
                const notes = [523.25, 587.33, 659.25, 783.99, 880.00];
                notes.forEach((freq, i) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.1 + 0.3);
                    osc.start(audioContext.currentTime + i * 0.1);
                    osc.stop(audioContext.currentTime + i * 0.1 + 0.3);
                });
                break;
                
            case 'easteregg':
                // Funny painful "OW!" sound
                oscillator.type = 'sawtooth';
                oscillator.frequency.value = 400;
                gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                oscillator.start(audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(150, audioContext.currentTime + 0.2);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                oscillator.stop(audioContext.currentTime + 0.2);
                break;
                
            case 'spawn':
                // Funny bouncy "BOING!" sound when it appears
                oscillator.type = 'sine';
                oscillator.frequency.value = 200;
                gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                oscillator.start(audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.15);
                oscillator.frequency.exponentialRampToValueAtTime(300, audioContext.currentTime + 0.25);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.25);
                oscillator.stop(audioContext.currentTime + 0.25);
                break;
        }
        
        if (window.navigator.vibrate) {
            if (type === 'catch') window.navigator.vibrate(10);
            if (type === 'powerup') window.navigator.vibrate([20, 50, 20]);
            if (type === 'bomb') window.navigator.vibrate(200);
            if (type === 'combo') window.navigator.vibrate([10, 30, 10, 30, 10]);
            if (type === 'easteregg') window.navigator.vibrate(300); // Long painful vibration
        }
    } catch(e) {
        console.log('Sound error:', e);
    }
}

function startGame(diff) {
    difficulty = diff;
    gameStarted = true;
    document.getElementById('difficultySelect').style.display = 'none';

    // Init AudioContext on user gesture (Safari requirement)
    getAudioContext();
    music.play().catch(e => console.log('Music play failed:', e));

    let spawnRate = 800;
    if (diff === 'easy') spawnRate = 1200;
    if (diff === 'hard') spawnRate = 500;

    spawnInterval = setInterval(createItem, spawnRate);
    setInterval(createSparkle, 300);
    setInterval(createLoveText, 3000);

    // Start the single shared collision loop
    startCollisionLoop();
}

/* Touch + Mouse control */
let basketX = window.innerWidth / 2;

// Get usable game width accounting for safe areas
function getGameWidth() {
    return window.visualViewport ? window.visualViewport.width : window.innerWidth;
}

document.addEventListener("touchmove", (e) => {
    e.preventDefault(); // CRITICAL: stops Safari scrolling the page during play
    basketX = e.touches[0].clientX;
    updateBasketPosition();
}, { passive: false }); // Must be non-passive to call preventDefault

document.addEventListener("mousemove", (e) => {
    basketX = e.clientX;
    updateBasketPosition();
});

function updateBasketPosition() {
    const halfBasket = 30; // ~half basket width
    const w = getGameWidth();
    // Clamp so basket can't go off screen
    const clamped = Math.max(halfBasket, Math.min(w - halfBasket, basketX));
    basket.style.left = clamped + "px";
}

// Resume AudioContext on first touch (Safari requirement)
document.addEventListener("touchstart", () => {
    getAudioContext();
    if (gameStarted) music.play().catch(() => {});
}, { passive: true, once: true });

/* Create falling items */
function createItem() {
    const rand = Math.random();
    let item;
    
    if (rand < 0.25) {
        // Regular heart
        item = createHeart();
    } else if (rand < 0.35) {
        // Power-up
        item = createPowerup();
    } else if (rand < 0.40) {
        // Bomb
        item = createBomb();
    } else {
        // Flying penis easter egg (60% chance - it's EVERYWHERE!)
        item = createEasterEgg();
    }
}

function createHeart() {
    const heart = document.createElement("div");
    heart.classList.add("heart");
    const hearts = ["‚ù§Ô∏è", "üíï", "üíñ", "üíó", "üíì", "üíù"];
    heart.innerHTML = hearts[Math.floor(Math.random() * hearts.length)];
    heart.style.left = Math.random() * (getGameWidth() - 50) + "px";
    heart.style.animationDuration = (2 + Math.random() * 2) + "s";
    if (difficulty === 'hard') heart.style.animationDuration = (1.5 + Math.random() * 1) + "s";
    if (difficulty === 'easy') heart.style.animationDuration = (3 + Math.random() * 2) + "s";
    gameArea.appendChild(heart);
    activeItems.push({ el: heart, type: 'heart' });
}

function createPowerup() {
    const powerup = document.createElement("div");
    powerup.classList.add("powerup");
    const powerups = ["‚≠ê", "üí´", "‚ú®", "üåü"];
    powerup.innerHTML = powerups[Math.floor(Math.random() * powerups.length)];
    powerup.style.left = Math.random() * (getGameWidth() - 50) + "px";
    powerup.style.animationDuration = (2 + Math.random() * 2) + "s";
    gameArea.appendChild(powerup);
    activeItems.push({ el: powerup, type: 'powerup' });
}

function createBomb() {
    const bomb = document.createElement("div");
    bomb.classList.add("bomb");
    bomb.innerHTML = "üí£";
    bomb.style.left = Math.random() * (getGameWidth() - 50) + "px";
    bomb.style.animationDuration = (2 + Math.random() * 1.5) + "s";
    gameArea.appendChild(bomb);
    activeItems.push({ el: bomb, type: 'bomb' });
}

function createEasterEgg() {
    const egg = document.createElement("div");
    egg.classList.add("bomb");
    egg.innerHTML = "üçÜ";
    egg.style.left = Math.random() * (getGameWidth() - 50) + "px";
    egg.style.animationDuration = (1.5 + Math.random() * 1) + "s";
    egg.style.fontSize = "35px";
    gameArea.appendChild(egg);
    playSound('spawn');
    activeItems.push({ el: egg, type: 'easteregg' });
}

/* Unified RAF-based collision loop ‚Äî replaces per-item setInterval */
let activeItems = []; // { el, type }
let collisionLoopRunning = false;

function startCollisionLoop() {
    if (collisionLoopRunning) return;
    collisionLoopRunning = true;
    rafCollisionLoop();
}

function rafCollisionLoop() {
    if (!gameStarted) { collisionLoopRunning = false; return; }

    const basketRect = basket.getBoundingClientRect();
    const viewH = window.visualViewport ? window.visualViewport.height : window.innerHeight;

    for (let i = activeItems.length - 1; i >= 0; i--) {
        const { el, type } = activeItems[i];
        const itemRect = el.getBoundingClientRect();

        // Caught
        if (
            itemRect.bottom >= basketRect.top &&
            itemRect.left < basketRect.right &&
            itemRect.right > basketRect.left
        ) {
            handleCatch(type);
            el.remove();
            activeItems.splice(i, 1);
            continue;
        }

        // Missed ‚Äî fell off screen
        if (itemRect.top > viewH) {
            el.remove();
            activeItems.splice(i, 1);
            if (type === 'heart') {
                streak = 0;
                combo = 0;
                streakDisplay.textContent = streak;
                comboDisplay.textContent = "";
            }
        }
    }

    requestAnimationFrame(rafCollisionLoop);
}

function handleCatch(type) {
    if (type === 'heart') {
        score++;
        streak++;
        combo++;
        scoreDisplay.textContent = score;
        streakDisplay.textContent = streak;

        if (combo > 2) {
            comboDisplay.textContent = `${combo}x COMBO!`;
            comboDisplay.classList.add('pulse');
            setTimeout(() => comboDisplay.classList.remove('pulse'), 200);
            playSound('combo');
            showPopup(funnyMessages[Math.floor(Math.random() * funnyMessages.length)]);
        } else {
            playSound('catch');
        }

        if (streak > maxStreak) maxStreak = streak;

    } else if (type === 'powerup') {
        score += 5;
        scoreDisplay.textContent = score;
        playSound('powerup');
        showPopup("‚≠ê +5 BONUS! ‚≠ê");
        activatePowerup();

    } else if (type === 'bomb') {
        if (!invincible) {
            score = Math.max(0, score - 3);
            streak = 0; combo = 0;
            scoreDisplay.textContent = score;
            streakDisplay.textContent = streak;
            comboDisplay.textContent = "";
            playSound('bomb');
            showPopup("üí• OOPS! -3");
        } else {
            showPopup("üõ°Ô∏è PROTECTED!");
        }

    } else if (type === 'easteregg') {
        score = Math.max(0, score - 5);
        streak = 0; combo = 0;
        scoreDisplay.textContent = score;
        streakDisplay.textContent = streak;
        comboDisplay.textContent = "";
        playSound('easteregg');
        showPopup("üçÜ OUCH! -5 üòÇ");
    }

    if (score >= 30) {
        message.style.display = "block";
        clearInterval(spawnInterval);
        gameStarted = false;
        playSound('win');
        showPopup("üéâ YOU WIN! üéâ");
    }
}

function activatePowerup() {
    invincible = true;
    basket.classList.add('invincible');
    setTimeout(() => {
        invincible = false;
        basket.classList.remove('invincible');
    }, 3000);
}

function showPopup(text) {
    popupText.textContent = text;
    popupText.style.opacity = 1;
    popupText.style.transform = 'translate(-50%, -50%) scale(1)';
    
    setTimeout(() => {
        popupText.style.transition = 'all 0.5s ease-out';
        popupText.style.opacity = 0;
        popupText.style.transform = 'translate(-50%, -80%) scale(0.5)';
    }, 800);
    
    setTimeout(() => {
        popupText.style.transition = '';
    }, 1300);
}

/* Sparkles */
function createSparkle() {
    const sparkle = document.createElement("div");
    sparkle.classList.add("sparkle");
    sparkle.style.left = Math.random() * getGameWidth() + "px";
    sparkle.style.animationDuration = (3 + Math.random() * 3) + "s";
    document.body.appendChild(sparkle);
    setTimeout(() => sparkle.remove(), 6000);
}

/* Floating Love Text */
function createLoveText() {
    const text = document.createElement("div");
    text.classList.add("loveText");
    text.innerHTML = loveMessages[Math.floor(Math.random() * loveMessages.length)];
    text.style.left = Math.random() * (getGameWidth() - 200) + "px";
    document.body.appendChild(text);
    setTimeout(() => text.remove(), 6000);
}

</script>

</body>
</html>
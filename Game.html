<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#ff758c">
<title>Catch the Love - For Beatrix ‚ù§Ô∏è</title>

<script>
// Set background IMMEDIATELY on page load
document.addEventListener('DOMContentLoaded', function() {
    document.body.style.backgroundColor = '#ff758c';
    document.body.style.backgroundImage = 'linear-gradient(to bottom, #ff758c, #ff7eb3)';
    console.log('IMMEDIATE: Background set on page load');
});
</script>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

html {
    background: #ff758c;
    height: 100%;
}

body {
    margin: 0;
    overflow: hidden;
    background: linear-gradient(to bottom, #ff758c, #ff7eb3);
    font-family: -apple-system, BlinkMacSystemFont, 'Arial', sans-serif;
    text-align: center;
    touch-action: none;
    position: fixed;
    width: 100%;
    height: 100vh;
    height: 100dvh;
    overscroll-behavior: none;
    transition: background 1s ease;
}


/* Animated background particles */
.bg-particle {
    position: fixed;
    top: -60px;
    pointer-events: none;
    z-index: 1;
}

.bg-particle.falling {
    animation: bgFall linear forwards;
}

@keyframes bgFall {
    0%   { transform: translateY(0) rotate(0deg);   opacity: 1; }
    90%  { opacity: 1; }
    100% { transform: translateY(110vh) rotate(400deg); opacity: 0; }
}

@keyframes bgDrift {
    0%   { transform: translateY(0) translateX(0) rotate(0deg);   opacity: 1; }
    100% { transform: translateY(110vh) translateX(40px) rotate(360deg); opacity: 0; }
}

@keyframes bgFloat {
    0%,100% { transform: translateY(0) scale(1);   opacity: 0.7; }
    50%      { transform: translateY(-12px) scale(1.15); opacity: 1; }
}

@keyframes bgCloudFloat {
    0%   { transform: translateX(-220px); }
    100% { transform: translateX(calc(100vw + 220px)); }
}

@keyframes bgBubble {
    0%   { transform: translateY(100vh) scale(0.5); opacity: 0; }
    20%  { opacity: 0.8; }
    100% { transform: translateY(-80px)  scale(1.2); opacity: 0; }
}

@keyframes bgPulse {
    0%,100% { transform: scale(1);   opacity: 0.6; }
    50%      { transform: scale(1.3); opacity: 1;   }
}

@keyframes bgMeteor {
    0%   { transform: translate(0, 0) rotate(30deg);          opacity: 1; }
    80%  { opacity: 0.8; }
    100% { transform: translate(60vw, 110vh) rotate(30deg);   opacity: 0; }
}

/* Header */
.header {
    position: relative;
    z-index: 100;
    padding: 10px 15px;
    padding-top: max(10px, env(safe-area-inset-top, 10px));
    background: rgba(0,0,0,0.2);
}

h1 {
    color: white;
    font-size: 22px;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.4);
    margin-bottom: 5px;
}

#scoreBoard {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
}

.stat {
    color: white;
    font-size: 16px;
    font-weight: bold;
    text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
}

#combo {
    color: #FFD700;
    font-size: 20px;
    transform: scale(1);
    transition: transform 0.2s;
}

#combo.pulse {
    transform: scale(1.3);
}

/* Sparkles - color changes per level */
.sparkle {
    position: absolute;
    width: 6px;
    height: 6px;
    background: white;
    border-radius: 50%;
    opacity: 0.8;
    animation: sparkleFloat 4s linear infinite;
    pointer-events: none;
}

@keyframes sparkleFloat {
    from { transform: translateY(100vh) scale(0.5); opacity: 0; }
    50% { opacity: 1; }
    to { transform: translateY(-10vh) scale(1.2); opacity: 0; }
}

#gameArea {
    position: relative;
    width: 100vw;
    height: calc(100vh - 100px);
    height: calc(100dvh - 100px);
    overflow: hidden;
}

/* Hearts and Items */
.heart, .powerup, .bomb {
    position: absolute;
    font-size: 28px;
    animation: fall linear;
    cursor: pointer;
    user-select: none;
}

.powerup {
    font-size: 32px;
    animation: fall linear, starPulse 0.6s ease-in-out infinite alternate;
}

@keyframes starPulse {
    from { filter: brightness(1) drop-shadow(0 0 4px rgba(255,220,0,0.6)); }
    to   { filter: brightness(1.5) drop-shadow(0 0 12px rgba(255,220,0,1)); }
}

.bomb {
    font-size: 30px;
    animation: fallWobble linear;
}

@keyframes fall {
    from { transform: translateY(-50px); }
    to { transform: translateY(calc(100vh + 50px)); }
}


@keyframes fallWobble {
    from { transform: translateY(-50px) rotate(-5deg); }
    25% { transform: translateY(calc(25vh)) rotate(5deg); }
    50% { transform: translateY(calc(50vh)) rotate(-5deg); }
    75% { transform: translateY(calc(75vh)) rotate(5deg); }
    to { transform: translateY(calc(100vh + 50px)) rotate(-5deg); }
}

#basket {
    position: absolute;
    bottom: max(20px, env(safe-area-inset-bottom, 20px) + 10px);
    left: 50%;
    transform: translateX(-50%);
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    z-index: 10;
    touch-action: none;
    will-change: transform;
    -webkit-transform: translateX(-50%);
}

#basket.invincible img {
    animation: shieldGlow 0.4s ease-in-out infinite alternate;
    border-color: gold !important;
}

@keyframes shieldGlow {
    from { box-shadow: 0 0 8px 2px rgba(255, 215, 0, 0.6); }
    to   { box-shadow: 0 0 20px 6px rgba(255, 215, 0, 1); }
}

@keyframes hitFlash {
    0%   { opacity: 1; }
    20%  { opacity: 0.1; }
    40%  { opacity: 1; }
    60%  { opacity: 0.1; }
    80%  { opacity: 1; }
    100% { opacity: 1; }
}

@keyframes celebrateJump {
    0%   { transform: translateY(0) scale(1); }
    30%  { transform: translateY(-18px) scale(1.08); }
    55%  { transform: translateY(-8px) scale(1.04); }
    75%  { transform: translateY(-14px) scale(1.06); }
    100% { transform: translateY(0) scale(1); }
}

@keyframes screenShake {
    0%,100% { transform: translate(0,0); }
    15%     { transform: translate(-8px, 4px); }
    30%     { transform: translate(8px, -4px); }
    45%     { transform: translate(-6px, -6px); }
    60%     { transform: translate(6px, 4px); }
    75%     { transform: translate(-4px, 2px); }
}

@keyframes particleBurst {
    0%   { transform: translate(0,0) scale(1); opacity: 1; }
    100% { transform: translate(var(--px), var(--py)) scale(0); opacity: 0; }
}

/* Golden double-points glow around basket */
#basket.doublePoints img {
    animation: goldPulse 0.5s ease-in-out infinite alternate;
    outline: 3px solid gold;
    outline-offset: 3px;
    border-radius: 4px;
}
@keyframes goldPulse {
    from { filter: drop-shadow(0 0 6px rgba(255,215,0,0.8)); }
    to   { filter: drop-shadow(0 0 18px rgba(255,215,0,1)) brightness(1.1); }
}

/* Double points banner */
#doublePointsBanner, #doubleBanner {
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #000;
    font-weight: bold;
    font-size: 14px;
    padding: 4px 14px;
    border-radius: 20px;
    box-shadow: 0 0 12px rgba(255,215,0,0.8);
    display: none;
    z-index: 50;
    white-space: nowrap;
}




/* Love message overlay */
#levelComplete {
    position: fixed;
    inset: 0;
    z-index: 1500;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 30px 20px;
    animation: fadeIn 0.4s ease;
}

#levelComplete .lc-card {
    background: rgba(0,0,0,0.65);
    backdrop-filter: blur(10px);
    border-radius: 24px;
    padding: 28px 32px;
    max-width: 320px;
    width: 100%;
    border: 1px solid rgba(255,255,255,0.15);
}

#levelComplete .lc-emoji  { font-size: 52px; margin-bottom: 8px; }
#levelComplete .lc-title  { font-size: 1.6rem; font-weight: 800; color: #FFD700; margin-bottom: 4px; }
#levelComplete .lc-theme  { font-size: 1rem; color: rgba(255,255,255,0.8); margin-bottom: 16px; }
#levelComplete .lc-stats  { display: flex; justify-content: space-around; margin-bottom: 20px; }
#levelComplete .lc-stat   { display: flex; flex-direction: column; align-items: center; gap: 2px; }
#levelComplete .lc-stat-val { font-size: 1.5rem; font-weight: 800; color: white; }
#levelComplete .lc-stat-lbl { font-size: 0.7rem; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.05em; }
#levelComplete .lc-next   {
    background: linear-gradient(135deg, #ff758c, #ff7eb3);
    color: white; border: none;
    padding: 13px 36px; font-size: 1.1rem; font-weight: 700;
    border-radius: 50px; cursor: pointer;
    box-shadow: 0 4px 15px rgba(255,100,150,0.4);
    transition: transform 0.15s;
    width: 100%;
}
#levelComplete .lc-next:active { transform: scale(0.96); }

/* ‚îÄ‚îÄ Boss Fight ‚îÄ‚îÄ */
#bossArena {
    position: fixed;
    inset: 0;
    z-index: 800;
    display: none;
    pointer-events: none;
}

/* Boss cinematic intro overlay */
#bossIntro {
    position: fixed;
    inset: 0;
    z-index: 1800;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0);
    pointer-events: none;
}

#bossIntroContent {
    text-align: center;
    animation: none;
}

#bossIntroSprite {
    font-size: clamp(5rem, 20vw, 8rem);
    display: block;
    filter: drop-shadow(0 0 30px rgba(255,0,0,0.8));
    transform: scale(0);
    opacity: 0;
}

#bossIntroName {
    font-size: clamp(1.4rem, 5vw, 2.2rem);
    font-weight: 900;
    color: #ff4444;
    text-shadow: 0 0 20px rgba(255,68,68,0.8), 0 2px 8px rgba(0,0,0,1);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    opacity: 0;
    margin-top: 12px;
}

#bossIntroSub {
    font-size: clamp(0.9rem, 3vw, 1.1rem);
    color: rgba(255,200,100,0.9);
    text-shadow: 0 1px 6px rgba(0,0,0,0.9);
    opacity: 0;
    margin-top: 8px;
    font-weight: 700;
}

@keyframes bossIntroBg {
    0%   { background: rgba(0,0,0,0); }
    30%  { background: rgba(0,0,0,0.85); }
    80%  { background: rgba(0,0,0,0.85); }
    100% { background: rgba(0,0,0,0); }
}

@keyframes bossIntroSpriteIn {
    0%   { transform: scale(0) rotate(-15deg); opacity: 0; filter: brightness(5) drop-shadow(0 0 60px #fff); }
    60%  { transform: scale(1.2) rotate(5deg); opacity: 1; filter: brightness(2) drop-shadow(0 0 30px rgba(255,0,0,1)); }
    100% { transform: scale(1) rotate(0deg); opacity: 1; filter: brightness(1) drop-shadow(0 0 20px rgba(255,0,0,0.6)); }
}

@keyframes bossIntroNameIn {
    0%   { opacity: 0; transform: translateY(20px) scaleX(0.5); letter-spacing: 0.4em; }
    60%  { opacity: 1; transform: translateY(0) scaleX(1); letter-spacing: 0.08em; }
    100% { opacity: 1; }
}

@keyframes bossIntroSubIn {
    0%   { opacity: 0; transform: translateY(10px); }
    100% { opacity: 1; transform: translateY(0); }
}

/* Red screen flash on boss appear */
@keyframes bossFlash {
    0%   { opacity: 0; }
    10%  { opacity: 0.7; }
    30%  { opacity: 0; }
    50%  { opacity: 0.4; }
    70%  { opacity: 0; }
    100% { opacity: 0; }
}

#bossFlashEl {
    position: fixed;
    inset: 0;
    background: #ff0000;
    z-index: 1700;
    pointer-events: none;
    opacity: 0;
    display: none;
}

#bossHUD {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 850;
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    pointer-events: none;
    width: min(340px, 92vw);
}

#bossNameRow {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    justify-content: space-between;
}

#bossName {
    font-size: 0.88rem;
    font-weight: 800;
    color: #ff4444;
    text-shadow: 0 1px 4px rgba(0,0,0,0.8);
    letter-spacing: 0.05em;
    text-transform: uppercase;
    flex: 1;
}

#bossPhaseTag {
    font-size: 0.72rem;
    font-weight: 700;
    color: #fff;
    background: rgba(255,68,68,0.8);
    border-radius: 6px;
    padding: 1px 7px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    white-space: nowrap;
    transition: background 0.4s;
}

#bossPhaseTag.enraged {
    background: linear-gradient(90deg, #ff0000, #ff6600);
    animation: rageTagPulse 0.4s ease-in-out infinite alternate;
    box-shadow: 0 0 8px rgba(255,0,0,0.8);
}

@keyframes rageTagPulse {
    from { filter: brightness(1); }
    to   { filter: brightness(1.5); }
}

#bossHpBar {
    width: 100%;
    height: 16px;
    background: rgba(0,0,0,0.5);
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.2);
    position: relative;
}

/* Phase marker line at 50% */
#bossHpBar::after {
    content: '';
    position: absolute;
    left: 50%;
    top: 0;
    width: 2px;
    height: 100%;
    background: rgba(255,255,255,0.5);
    z-index: 1;
}

#bossHpFill {
    height: 100%;
    background: linear-gradient(90deg, #ff4444, #ff8800);
    border-radius: 8px;
    transition: width 0.3s ease, background 0.5s ease;
    position: relative;
}

#bossHpFill.enraged {
    background: linear-gradient(90deg, #ff0000, #ff4400);
    animation: hpRagePulse 0.3s ease-in-out infinite alternate;
}

@keyframes hpRagePulse {
    from { filter: brightness(1); }
    to   { filter: brightness(1.4); }
}

#bossHpText {
    font-size: 0.72rem;
    color: rgba(255,255,255,0.8);
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
}

/* Rage warning banner */
#bossRageBanner {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1600;
    display: none;
    font-size: clamp(1.4rem, 6vw, 2.2rem);
    font-weight: 900;
    color: #ff2200;
    text-shadow: 0 0 20px rgba(255,0,0,0.9), 0 2px 8px rgba(0,0,0,1);
    letter-spacing: 0.06em;
    text-align: center;
    pointer-events: none;
    animation: rageBannerPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

@keyframes rageBannerPop {
    0%   { transform: translate(-50%,-50%) scale(0.3); opacity: 0; }
    60%  { transform: translate(-50%,-50%) scale(1.15); opacity: 1; }
    100% { transform: translate(-50%,-50%) scale(1);   opacity: 1; }
}

#bossSprite {
    position: fixed;
    top: 140px;
    left: 50%;
    transform: translateX(-50%);
    font-size: clamp(3rem, 12vw, 5rem);
    z-index: 820;
    pointer-events: none;
    animation: bossBob 1.2s ease-in-out infinite;
    text-shadow: 0 0 20px rgba(255,0,0,0.4);
    display: none;
    transition: filter 0.3s;
}

#bossSprite.enraged {
    animation: bossRageBob 0.6s ease-in-out infinite;
    filter: drop-shadow(0 0 16px rgba(255,50,0,1)) brightness(1.3);
}

@keyframes bossBob {
    0%,100% { transform: translateX(-50%) translateY(0) rotate(-3deg); }
    50%      { transform: translateX(-50%) translateY(-12px) rotate(3deg); }
}

@keyframes bossRageBob {
    0%   { transform: translateX(-50%) translateY(0) rotate(-5deg) scale(1); }
    25%  { transform: translateX(calc(-50% - 5px)) translateY(-8px) rotate(5deg) scale(1.05); }
    50%  { transform: translateX(-50%) translateY(-15px) rotate(-5deg) scale(1.08); }
    75%  { transform: translateX(calc(-50% + 5px)) translateY(-8px) rotate(5deg) scale(1.05); }
    100% { transform: translateX(-50%) translateY(0) rotate(-5deg) scale(1); }
}

@keyframes bossHit {
    0%  { transform: translateX(-50%) scale(1.3); filter: brightness(5) drop-shadow(0 0 20px white); }
    50% { transform: translateX(calc(-50% - 10px)) scale(0.95); filter: brightness(2); }
    100%{ transform: translateX(-50%) scale(1);   filter: brightness(1); }
}

@keyframes bossDeathShake {
    0%,100%{ transform: translateX(calc(-50% + 0px)) scale(1); }
    15%    { transform: translateX(calc(-50% - 12px)) scale(1.1) rotate(-5deg); }
    30%    { transform: translateX(calc(-50% + 12px)) scale(0.9) rotate(5deg); }
    45%    { transform: translateX(calc(-50% - 8px)) scale(1.05); }
    60%    { transform: translateX(calc(-50% + 8px)) scale(0.95); }
    75%    { transform: translateX(calc(-50% - 4px)) scale(1.02); }
}

@keyframes bossDeathFade {
    0%   { opacity: 1; transform: translateX(-50%) scale(1); filter: brightness(1); }
    30%  { opacity: 1; transform: translateX(-50%) scale(1.4); filter: brightness(5); }
    100% { opacity: 0; transform: translateX(-50%) scale(2); filter: brightness(8); }
}

/* New death sequence animations */
@keyframes bossStagger {
    0%   { transform: translateX(-50%) rotate(0deg) scale(1); }
    20%  { transform: translateX(calc(-50% - 15px)) rotate(-12deg) scale(0.95); }
    40%  { transform: translateX(calc(-50% + 10px)) rotate(8deg) scale(1.02); }
    60%  { transform: translateX(calc(-50% - 8px)) rotate(-6deg) scale(0.97); }
    80%  { transform: translateX(calc(-50% + 5px)) rotate(4deg) scale(0.99); }
    100% { transform: translateX(-50%) rotate(-3deg) scale(0.95); }
}

@keyframes bossFallDown {
    0%   { transform: translateX(-50%) translateY(0) rotate(-3deg) scale(0.95);
           filter: brightness(1) drop-shadow(0 0 8px rgba(255,100,0,0.6)); }
    30%  { transform: translateX(calc(-50% - 20px)) translateY(15vh) rotate(-20deg) scale(0.9);
           filter: brightness(1.5) drop-shadow(0 0 20px rgba(255,60,0,1)); }
    60%  { transform: translateX(calc(-50% + 10px)) translateY(40vh) rotate(-35deg) scale(0.85);
           filter: brightness(2) drop-shadow(0 0 30px rgba(255,30,0,1)); }
    100% { transform: translateX(calc(-50% - 5px)) translateY(65vh) rotate(-50deg) scale(0.7);
           filter: brightness(3) drop-shadow(0 0 40px rgba(255,0,0,1)); opacity: 0.3; }
}

/* Floating fire embers that rise during death */
@keyframes emberRise {
    0%   { transform: translateY(0) translateX(0) scale(1); opacity: 1; }
    50%  { opacity: 1; }
    100% { transform: translateY(-120px) translateX(var(--ex)) scale(0.3); opacity: 0; }
}

/* Ground shockwave ring on impact */
@keyframes shockwaveExpand {
    0%   { transform: translate(-50%, -50%) scale(0); opacity: 1; border-width: 6px; }
    50%  { opacity: 0.8; }
    100% { transform: translate(-50%, -50%) scale(6); opacity: 0; border-width: 1px; }
}

/* Impact crater flash */
@keyframes impactFlash {
    0%   { opacity: 0; transform: translate(-50%,-50%) scale(0.2); }
    20%  { opacity: 1; transform: translate(-50%,-50%) scale(1); }
    60%  { opacity: 0.6; }
    100% { opacity: 0; transform: translate(-50%,-50%) scale(1.8); }
}

/* Explosion debris flying out */
@keyframes debrisfly {
    0%   { transform: translate(0,0) rotate(0deg) scale(1); opacity: 1; }
    100% { transform: translate(var(--dx), var(--dy)) rotate(var(--dr)) scale(0.3); opacity: 0; }
}

.boss-ember {
    position: fixed;
    pointer-events: none;
    z-index: 821;
    font-size: 16px;
    animation: emberRise 0.8s ease-out forwards;
}

.boss-shockwave {
    position: fixed;
    border: 4px solid rgba(255, 150, 0, 0.9);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    pointer-events: none;
    z-index: 819;
    animation: shockwaveExpand 0.7s ease-out forwards;
    box-shadow: 0 0 20px rgba(255,100,0,0.6), inset 0 0 10px rgba(255,200,0,0.4);
}

.boss-impact-flash {
    position: fixed;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: radial-gradient(circle, #fff 0%, #ffdd00 30%, #ff6600 60%, transparent 100%);
    pointer-events: none;
    z-index: 822;
    animation: impactFlash 0.5s ease-out forwards;
}

.boss-debris {
    position: fixed;
    pointer-events: none;
    z-index: 820;
    font-size: 20px;
    animation: debrisfly 1.2s ease-out forwards;
}

.boss-attack {
    position: absolute;
    font-size: 28px;
    animation: bossAttackFall linear forwards;
    pointer-events: none;
    z-index: 810;
}

.boss-attack.enraged-attack {
    font-size: 32px;
    filter: drop-shadow(0 0 8px rgba(255,100,0,0.9));
    animation: bossAttackFallFast linear forwards;
}

.boss-attack.warning-attack {
    animation: bossAttackFall linear forwards, attackWarn 0.3s ease-in-out infinite alternate;
}

@keyframes attackWarn {
    from { filter: brightness(1); }
    to   { filter: brightness(2) drop-shadow(0 0 12px rgba(255,0,0,1)); }
}

@keyframes bossAttackFall {
    0%   { transform: translateY(0) rotate(0deg);   opacity: 1; }
    100% { transform: translateY(110vh) rotate(360deg); opacity: 0.8; }
}

@keyframes bossAttackFallFast {
    0%   { transform: translateY(0) rotate(0deg) scale(1.2);   opacity: 1; }
    100% { transform: translateY(110vh) rotate(540deg) scale(1); opacity: 0.9; }
}

/* Attack warning line - telegraphs incoming attack */
.attack-warning {
    position: absolute;
    width: 3px;
    top: 0;
    background: linear-gradient(180deg, rgba(255,50,0,0) 0%, rgba(255,50,0,0.6) 50%, rgba(255,50,0,0) 100%);
    pointer-events: none;
    z-index: 808;
    animation: warnLine 0.5s ease-in-out forwards;
}

@keyframes warnLine {
    0%   { opacity: 0; height: 0; }
    50%  { opacity: 1; height: 100%; }
    100% { opacity: 0; height: 100%; }
}

/* Boss health phase pulse on HUD */
@keyframes bossHpShake {
    0%,100% { transform: translateX(0); }
    25%     { transform: translateX(-4px); }
    75%     { transform: translateX(4px); }
}

/* Messages */
#message {
    position: absolute;
    top: 35%;
    width: 100%;
    font-size: 28px;
    color: white;
    display: none;
    padding: 0 20px;
    animation: fadeIn 2s ease-in-out;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
}

#popupText {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    font-weight: bold;
    color: #FFD700;
    text-shadow: 3px 3px 10px rgba(0,0,0,0.8);
    opacity: 0;
    pointer-events: none;
    z-index: 150;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Floating love text */
.loveText {
    position: absolute;
    color: white;
    font-weight: bold;
    font-size: 18px;
    text-shadow: 2px 2px 6px rgba(0,0,0,0.5);
    animation: floatUp 6s ease-in forwards;
    pointer-events: none;
    z-index: 5;
}

@keyframes floatUp {
    from { transform: translateY(100vh); opacity: 0; }
    20% { opacity: 1; }
    80% { opacity: 1; }
    to { transform: translateY(-20vh); opacity: 0; }
}

/* Particle burst */
.particle {
    position: absolute;
    width: 8px;
    height: 8px;
    background: radial-gradient(circle, #FFD700, #FF69B4);
    border-radius: 50%;
    pointer-events: none;
    animation: particleBurst 0.8s ease-out forwards;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MENU ‚Äî Full redesign
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* Shared overlay base */
#menuOverlay, #gameOver, #howToPlay {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 20px;
    overflow-y: auto;
}

/* ‚îÄ‚îÄ Menu background: deep romantic gradient with radial glow ‚îÄ‚îÄ */
#menuOverlay {
    background:
        radial-gradient(ellipse 80% 60% at 50% 30%, rgba(255,100,160,0.45) 0%, transparent 70%),
        radial-gradient(ellipse 60% 50% at 20% 80%, rgba(180,80,255,0.25) 0%, transparent 60%),
        radial-gradient(ellipse 50% 40% at 80% 70%, rgba(255,180,80,0.20) 0%, transparent 60%),
        linear-gradient(160deg, #1a0030 0%, #3d0050 30%, #600030 60%, #1a0020 100%);
    backdrop-filter: blur(0px);
}

/* Animated floating menu hearts background */
.menu-float-heart {
    position: fixed;
    pointer-events: none;
    z-index: 1001;
    font-size: 20px;
    opacity: 0;
    animation: menuHeartFloat linear infinite;
}

@keyframes menuHeartFloat {
    0%   { transform: translateY(110vh) translateX(0) rotate(0deg) scale(0.5); opacity: 0; }
    10%  { opacity: 0.6; }
    90%  { opacity: 0.4; }
    100% { transform: translateY(-10vh) translateX(var(--hx)) rotate(var(--hr)) scale(1.1); opacity: 0; }
}

/* ‚îÄ‚îÄ Menu card ‚îÄ‚îÄ */
.menu-card {
    background: linear-gradient(145deg,
        rgba(255,255,255,0.10) 0%,
        rgba(255,180,220,0.08) 50%,
        rgba(180,80,255,0.06) 100%);
    border: 1px solid rgba(255,255,255,0.18);
    border-radius: 28px;
    padding: clamp(24px,5vw,40px) clamp(20px,6vw,48px);
    width: min(360px, 92vw);
    backdrop-filter: blur(20px);
    box-shadow:
        0 0 60px rgba(255,80,160,0.18),
        0 0 120px rgba(180,60,255,0.10),
        0 20px 60px rgba(0,0,0,0.5),
        inset 0 1px 0 rgba(255,255,255,0.22);
    position: relative;
    animation: menuCardIn 0.6s cubic-bezier(0.175,0.885,0.32,1.275) forwards;
    transform-origin: center bottom;
}

@keyframes menuCardIn {
    0%   { opacity: 0; transform: scale(0.85) translateY(30px); }
    100% { opacity: 1; transform: scale(1)    translateY(0); }
}

/* Title text */
#menuOverlay .menu-title {
    font-size: clamp(2rem, 9vw, 3.2rem);
    font-weight: 900;
    letter-spacing: -0.01em;
    line-height: 1.1;
    margin-bottom: 4px;
    background: linear-gradient(135deg, #fff 0%, #ffcce8 40%, #FFD700 80%, #ffaacc 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: none;
    filter: drop-shadow(0 2px 12px rgba(255,100,180,0.6));
    animation: titleShimmer 3s ease-in-out infinite alternate;
}

@keyframes titleShimmer {
    0%   { filter: drop-shadow(0 2px 12px rgba(255,100,180,0.5)); }
    100% { filter: drop-shadow(0 2px 20px rgba(255,200,80,0.7)); }
}

#menuOverlay .menu-subtitle {
    font-size: clamp(0.78rem, 2.5vw, 0.9rem);
    color: rgba(255,220,240,0.75);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: 6px;
    font-weight: 600;
}

/* Big animated heart */
.menu-hero-heart {
    font-size: clamp(52px, 14vw, 72px);
    display: block;
    margin: 8px 0 14px;
    animation: heroPulse 1.4s ease-in-out infinite;
    filter: drop-shadow(0 0 16px rgba(255,100,160,0.8));
}

@keyframes heroPulse {
    0%,100% { transform: scale(1)    rotate(-4deg); filter: drop-shadow(0 0 16px rgba(255,100,160,0.8)); }
    50%      { transform: scale(1.12) rotate(4deg);  filter: drop-shadow(0 0 28px rgba(255,200,80,0.9)); }
}

/* High score badge */
.menu-hiscore {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(255,215,0,0.12);
    border: 1px solid rgba(255,215,0,0.3);
    border-radius: 20px;
    padding: 4px 14px;
    font-size: 0.82rem;
    color: #FFD700;
    font-weight: 700;
    margin-bottom: 18px;
    letter-spacing: 0.04em;
}

.menu-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
}

/* Primary action button */
.menu-button {
    background: linear-gradient(135deg, #ff5fa0 0%, #ff84c0 50%, #ffaadd 100%);
    color: white;
    border: none;
    padding: 15px 28px;
    font-size: clamp(15px,4vw,18px);
    font-weight: 800;
    border-radius: 50px;
    cursor: pointer;
    letter-spacing: 0.03em;
    box-shadow:
        0 4px 20px rgba(255,80,160,0.45),
        0 1px 0 rgba(255,255,255,0.3) inset;
    transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
    position: relative;
    overflow: hidden;
    width: 100%;
}

.menu-button::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(255,255,255,0.18) 0%, transparent 60%);
    border-radius: inherit;
    pointer-events: none;
}

.menu-button:hover  { transform: translateY(-2px) scale(1.02); box-shadow: 0 8px 28px rgba(255,80,160,0.55), 0 1px 0 rgba(255,255,255,0.3) inset; filter: brightness(1.05); }
.menu-button:active { transform: scale(0.96); box-shadow: 0 2px 10px rgba(255,80,160,0.3); }

/* Secondary button (outline style) */
.menu-button.secondary {
    background: transparent;
    border: 1.5px solid rgba(255,255,255,0.35);
    color: rgba(255,255,255,0.9);
    box-shadow: 0 2px 12px rgba(0,0,0,0.2);
}
.menu-button.secondary:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.6); }

/* Difficulty section */
#difficultySelect {
    margin-top: 16px;
    width: 100%;
}

#difficultySelect p {
    color: rgba(255,220,240,0.85);
    font-size: 0.88rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 10px;
}

.difficulty-buttons {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-bottom: 14px;
}

.difficulty-btn {
    flex: 1;
    background: rgba(255,255,255,0.08);
    color: rgba(255,255,255,0.75);
    border: 1.5px solid rgba(255,255,255,0.2);
    padding: 10px 6px;
    font-size: 13px;
    font-weight: 700;
    border-radius: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    letter-spacing: 0.03em;
}

.difficulty-btn:hover { background: rgba(255,255,255,0.14); border-color: rgba(255,255,255,0.45); color: white; }

.difficulty-btn.selected {
    background: linear-gradient(135deg, rgba(255,90,160,0.7), rgba(255,150,200,0.5));
    border-color: rgba(255,200,230,0.6);
    color: white;
    box-shadow: 0 2px 12px rgba(255,80,160,0.35);
}

/* Divider */
.menu-divider {
    width: 60%;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    margin: 10px auto;
}

/* ‚îÄ‚îÄ How to Play ‚îÄ‚îÄ */
#howToPlay {
    display: none;
    background:
        radial-gradient(ellipse 70% 50% at 50% 20%, rgba(255,100,160,0.3) 0%, transparent 70%),
        linear-gradient(160deg, #1a0030 0%, #3d0050 50%, #1a0020 100%);
    overflow-y: auto;
}

.how-to-content {
    max-width: 400px;
    width: 92vw;
    background: linear-gradient(145deg, rgba(255,255,255,0.10), rgba(255,180,220,0.06));
    border: 1px solid rgba(255,255,255,0.15);
    padding: clamp(20px,5vw,32px);
    border-radius: 24px;
    backdrop-filter: blur(20px);
    box-shadow: 0 20px 60px rgba(0,0,0,0.4);
}

.how-to-content h2 {
    color: white;
    font-size: clamp(1.3rem,5vw,1.6rem);
    font-weight: 900;
    margin-bottom: 16px;
    background: linear-gradient(135deg, #fff, #ffcce8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.how-to-content p, .how-to-content ul {
    color: rgba(255,220,240,0.85);
    text-align: left;
    line-height: 1.8;
    margin-bottom: 12px;
    font-size: 0.9rem;
}

.how-to-content ul { list-style: none; padding: 0; }
.how-to-content ul li { padding: 4px 0; }
.how-to-content strong { color: white; }

/* ‚îÄ‚îÄ Game Over ‚îÄ‚îÄ */
#gameOver {
    display: none;
    background:
        radial-gradient(ellipse 70% 50% at 50% 20%, rgba(255,100,160,0.25) 0%, transparent 70%),
        linear-gradient(160deg, #1a0030 0%, #3d0050 50%, #1a0020 100%);
}

.game-over-content {
    background: linear-gradient(145deg, rgba(255,255,255,0.10), rgba(255,180,220,0.06));
    border: 1px solid rgba(255,255,255,0.15);
    padding: clamp(24px,5vw,40px) clamp(20px,6vw,40px);
    border-radius: 28px;
    backdrop-filter: blur(20px);
    max-width: 360px;
    width: 92vw;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 60px rgba(255,80,160,0.12);
    animation: menuCardIn 0.5s cubic-bezier(0.175,0.885,0.32,1.275) forwards;
}

#gameOverTitle {
    font-size: clamp(1.5rem,6vw,2rem);
    font-weight: 900;
    color: white;
    margin-bottom: 12px;
    text-shadow: 0 2px 12px rgba(255,80,160,0.5);
}

#gameOverImg {
    font-size: 72px;
    margin-bottom: 14px;
}

#gameOverScore, #gameOverHigh, #gameOverStreak, #gameOverLevel {
    color: rgba(255,220,240,0.85);
    font-size: clamp(14px,3.5vw,17px);
    margin: 7px 0;
    font-weight: 600;
}

.restart-btn {
    background: linear-gradient(135deg, #ff5fa0 0%, #ff84c0 50%, #ffaadd 100%);
    color: white;
    border: none;
    padding: 14px 28px;
    font-size: clamp(14px,3.8vw,17px);
    font-weight: 800;
    border-radius: 50px;
    cursor: pointer;
    letter-spacing: 0.03em;
    box-shadow: 0 4px 20px rgba(255,80,160,0.4), 0 1px 0 rgba(255,255,255,0.3) inset;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
    width: 100%;
    margin-top: 8px;
    position: relative;
    overflow: hidden;
}
.restart-btn::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(255,255,255,0.18) 0%, transparent 60%);
    border-radius: inherit;
    pointer-events: none;
}
.restart-btn:hover  { transform: translateY(-2px) scale(1.02); box-shadow: 0 8px 28px rgba(255,80,160,0.5); }
.restart-btn:active { transform: scale(0.96); }

/* Sound toggle */
#soundToggle {
    position: fixed;
    top: max(10px, env(safe-area-inset-top, 10px));
    right: 15px;
    z-index: 200;
    background: rgba(0,0,0,0.3);
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 50px;
    font-size: 20px;
    cursor: pointer;
    transition: background 0.3s;
}

#soundToggle:active {
    background: rgba(0,0,0,0.5);
}

/* Lives display */
#lives {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 24px;
    z-index: 50;
}

/* Level transition ‚Äî pinned to top, no overlay */
#levelTransition {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 2000;
    display: none;
    flex-direction: column;
    align-items: center;
    text-align: center;
    pointer-events: none;
    background: rgba(0,0,0,0.5);
    border-radius: 12px;
    padding: 8px 20px 10px;
    white-space: nowrap;
}

#levelTransition .level-number {
    font-size: 1rem;
    color: white;
    font-weight: bold;
    margin-bottom: 1px;
}

#levelTransition .level-theme {
    font-size: 1.1rem;
    color: #FFD700;
    font-weight: bold;
    margin-bottom: 1px;
}

#levelTransition .level-description {
    font-size: 0.78rem;
    color: rgba(255,255,255,0.75);
}

/* Countdown word ‚Äî dead centre, nothing else nearby */
#countdown {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: clamp(2rem, 10vw, 4rem);
    font-weight: 800;
    pointer-events: none;
    z-index: 2100;
    display: none;
    letter-spacing: 0.05em;
    text-shadow: 0 2px 12px rgba(0,0,0,0.5);
    animation: countPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

@keyframes countPop {
    0%   { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
    70%  { transform: translate(-50%, -50%) scale(1.05); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(1);   opacity: 1; }
}

@keyframes countFade {
    0%   { opacity: 1; transform: translate(-50%, -50%) scale(1);   }
    100% { opacity: 0; transform: translate(-50%, -50%) scale(1.15); }
}

/* ‚îÄ‚îÄ Projectile (shooting) ‚îÄ‚îÄ */
.projectile {
    position: absolute;
    font-size: 22px;
    pointer-events: none;
    z-index: 815;
    filter: drop-shadow(0 0 6px rgba(255,200,0,0.9));
}

#shootHint {
    position: fixed;
    bottom: max(130px, env(safe-area-inset-bottom, 20px) + 120px);
    left: 50%;
    transform: translateX(-50%);
    color: rgba(255,255,255,0.85);
    font-size: 13px;
    font-weight: 700;
    pointer-events: none;
    z-index: 50;
    text-shadow: 0 1px 4px rgba(0,0,0,0.7);
    display: none;
    letter-spacing: 0.04em;
    background: rgba(0,0,0,0.3);
    padding: 4px 12px;
    border-radius: 20px;
}

@keyframes healPop {
    0%   { transform: translateY(0) scale(0.6); opacity: 0; }
    30%  { transform: translateY(-20px) scale(1.3); opacity: 1; }
    100% { transform: translateY(-60px) scale(1); opacity: 0; }
}
.heal-popup {
    position: absolute;
    font-size: 22px;
    font-weight: 900;
    color: #ff4dbb;
    text-shadow: 0 0 10px rgba(255,100,200,0.9), 0 2px 6px rgba(0,0,0,0.8);
    pointer-events: none;
    z-index: 900;
    animation: healPop 1s ease-out forwards;
    white-space: nowrap;
    transform: translateX(-50%);
}

</style>
</head>
<body>

<!-- Sound Toggle -->
<button id="soundToggle" onclick="toggleSound()">üîä</button>

<!-- Lives Display -->
<div id="lives"></div>

<!-- Double Points Banner -->
<div id="doubleBanner">‚≠ê DOUBLE POINTS ‚≠ê</div>

<!-- Floating background hearts for menu -->
<div id="menuHearts"></div>

<!-- Menu Overlay -->
<div id="menuOverlay">
    <div class="menu-card">
        <span class="menu-hero-heart">üíñ</span>
        <div class="menu-title">Catch the Love</div>
        <div class="menu-subtitle">Made with ‚ù§Ô∏è for Beatrix</div>

        <div class="menu-hiscore">üèÜ Best: <span id="menuHighScore">0</span> hearts</div>

        <p style="color:rgba(255,220,240,0.75);font-size:0.8rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:10px;">Choose difficulty</p>
        <div class="difficulty-buttons" id="difficultyBtns">
            <button class="difficulty-btn" onclick="playBtnHover();selectDifficulty('easy',this)">üå∏ Easy</button>
            <button class="difficulty-btn selected" onclick="playBtnHover();selectDifficulty('medium',this)">‚ö° Medium</button>
            <button class="difficulty-btn" onclick="playBtnHover();selectDifficulty('hard',this)">üî• Hard</button>
        </div>

        <button class="menu-button" style="margin-top:14px" onclick="playBtnConfirm();startGame()">üöÄ&nbsp;&nbsp;Start!</button>

        <div class="menu-divider" style="margin:12px auto"></div>

        <button class="menu-button secondary" onclick="playBtnHover();showHowToPlay()">‚ùì&nbsp;&nbsp;How to Play</button>
    </div>
</div>

<!-- How to Play -->
<div id="howToPlay">
    <div class="how-to-content">
        <h2>How to Play üéÆ</h2>
        <p><strong>Goal:</strong> Catch falling hearts to collect 10 hearts per level and complete all 10 levels!</p>

        <ul>
            <li>‚ù§Ô∏è <strong>Hearts:</strong> Catch them! Each heart = 1 point</li>
            <li>‚≠ê <strong>Power-ups:</strong> Invincibility shield + double points for 5 seconds</li>
            <li>üí£ <strong>Bombs:</strong> Avoid! Costs 1 life</li>
            <li>üçÜ <strong>Easter Egg:</strong> Loses 1 heart from your level progress</li>
        </ul>

        <p><strong>Controls:</strong> Drag or touch to move the basket</p>
        <p><strong>Lives:</strong> You have 3 lives. Missing a heart or catching a bomb costs a life!</p>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.15);margin:14px 0">

        <p style="color:#FFD700;font-weight:800;font-size:1rem;margin-bottom:8px">‚öîÔ∏è Boss Fight</p>
        <ul>
            <li>üëπ A boss appears after collecting all 10 hearts each level</li>
            <li>üíò <strong>Tap or click</strong> to shoot projectiles at the boss</li>
            <li>üèÉ The boss moves ‚Äî dodge its attacks while shooting back!</li>
            <li>üíó Catch glowing pink hearts to <strong>restore 1 life</strong></li>
            <li>‚ö†Ô∏è At 50% HP the boss enters <strong>ENRAGED</strong> mode ‚Äî faster and more dangerous</li>
            <li>üí• Deplete all boss HP to complete the level</li>
        </ul>

        <button class="menu-button" onclick="playBtnHover();closeHowToPlay()" style="margin-top:16px">Got it! üëç</button>
    </div>
</div>

<!-- Level Transition -->
<div id="levelTransition">
    <div class="level-number"></div>
    <div class="level-theme"></div>
    <div class="level-description"></div>
</div>

<!-- Countdown -->
<div id="countdown"></div>

<!-- Game Over Screen -->
<div id="gameOver">
    <div class="game-over-content">
        <h2 id="gameOverTitle">Game Over üíî</h2>
        <div id="gameOverImg">üò¢</div>
        <p id="gameOverScore">Score: 0</p>
        <p id="gameOverHigh">High Score: 0</p>
        <p id="gameOverStreak">Max Streak: 0</p>
        <p id="gameOverLevel">Level: 1</p>
        <button class="restart-btn" onclick="playBtnConfirm();restartGame()">Play Again üîÑ</button>
        <button class="restart-btn" onclick="playBtnHover();backToMenu()" style="background: linear-gradient(135deg, #667eea, #764ba2); margin-top: 10px;">Main Menu üè†</button>
    </div>
</div>

<!-- Header -->
<div class="header">
    <h1>Catch the Love ‚ù§Ô∏è</h1>
    <div id="scoreBoard">
        <div class="stat">‚ù§Ô∏è <span id="heartsDisplay">0/10</span></div>
        <div class="stat">Level <span id="level">1</span></div>
        <div class="stat">Streak: <span id="streak">0</span></div>
        <div class="stat" id="combo"></div>
    </div>
</div>

<!-- Shoot hint -->
<div id="shootHint">TAP or CLICK to shoot üíò</div>

<!-- Game Area -->
<div id="gameArea">
    <div id="message"></div>
    <div id="popupText"></div>
    <div id="basket"><img id="basketImg" src="me.jpg" style="height:90px;width:auto;display:block;filter:drop-shadow(0 4px 10px rgba(0,0,0,0.5));"></div>
</div>

<!-- Boss Arena -->
<div id="bossArena"></div>
<div id="bossSprite"></div>
<div id="bossFlashEl"></div>
<div id="bossHUD">
    <div id="bossNameRow">
        <div id="bossName">BOSS</div>
        <div id="bossPhaseTag">Phase 1</div>
    </div>
    <div id="bossHpBar"><div id="bossHpFill" style="width:100%"></div></div>
    <div id="bossHpText">8 / 8 HP</div>
</div>
<div id="bossRageBanner">üò° ENRAGED! üò°</div>
<!-- Boss cinematic intro -->
<div id="bossIntro">
    <div id="bossIntroContent">
        <span id="bossIntroSprite"></span>
        <div id="bossIntroName"></div>
        <div id="bossIntroSub"></div>
    </div>
</div>

<!-- Level Complete Screen -->
<div id="levelComplete">
    <div class="lc-card">
        <div class="lc-emoji" id="lcEmoji">üéâ</div>
        <div class="lc-title" id="lcTitle">Level Complete!</div>
        <div class="lc-theme" id="lcTheme"></div>
        <div class="lc-stats">
            <div class="lc-stat">
                <div class="lc-stat-val" id="lcStreak">0</div>
                <div class="lc-stat-lbl">Best Streak</div>
            </div>
            <div class="lc-stat">
                <div class="lc-stat-val" id="lcScore">0</div>
                <div class="lc-stat-lbl">Total Hearts</div>
            </div>
            <div class="lc-stat">
                <div class="lc-stat-val" id="lcLives">üíñ</div>
                <div class="lc-stat-lbl">Lives Left</div>
            </div>
        </div>
        <button class="lc-next" onclick="playBtnConfirm();nextLevel()">Next Level ‚Üí</button>
    </div>
</div>

<script>
/* Base64 Images */
const ME_SAD = "me2.jpg";
const ME_HAPPY = "me3.jpg";

/* Level Themes */
/* Game Variables */
const basket = document.getElementById("basket");
const gameArea = document.getElementById("gameArea");
const scoreDisplay = document.getElementById("heartsDisplay");
const levelDisplay = document.getElementById("level");
const streakDisplay = document.getElementById("streak");
const comboDisplay = document.getElementById("combo");
const message = document.getElementById("message");
const popupText = document.getElementById("popupText");
const livesDisplay = document.getElementById("lives");

let score = 0;
let heartsThisLevel = 0;
let level = 1;
let streak = 0;
let maxStreak = 0;
let combo = 0;
let lives = 3;
let gameStarted = false;
let spawnInterval;
let difficulty = 'medium';
let invincible = false;
let doublePoints = false;
let soundEnabled = true;
let highScore = localStorage.getItem('beatrix_highscore') || 0;
let themeAnimationInterval;
document.getElementById('menuHighScore').textContent = highScore;

/* Love messages */
const loveMessages = [
    "You're my sunshine! ‚òÄÔ∏è",
    "Forever yours üíï",
    "My heart beats for you üíì",
    "You make me smile üòä",
    "Best thing ever! ‚ú®",
    "Love you infinity! ‚àû"
];

const funnyMessages = [
    "üî• ON FIRE!",
    "üí´ AMAZING!",
    "‚ö° UNSTOPPABLE!",
    "üåü PERFECT!",
    "üíù INCREDIBLE!",
    "üéØ LEGEND!"
];

/* ‚îÄ‚îÄ Web Audio Sound Engine ‚îÄ‚îÄ */
let audioCtx = null;
function getAudioCtx() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    return audioCtx;
}

function playSound(type) {
    if (!soundEnabled) return;
    try {
        const ctx = getAudioCtx();
        const t = ctx.currentTime;
        switch(type) {

            case 'catch': {
                // Sweet little "ding" ‚Äî rising tone
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.type = 'sine';
                o.frequency.setValueAtTime(520, t);
                o.frequency.linearRampToValueAtTime(880, t + 0.12);
                g.gain.setValueAtTime(0.35, t);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
                o.start(t); o.stop(t + 0.3);
                break;
            }

            case 'combo': {
                // Fast upward arpeggio
                [523, 659, 784, 1047].forEach((freq, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'triangle';
                    const st = t + i * 0.07;
                    o.frequency.setValueAtTime(freq, st);
                    g.gain.setValueAtTime(0.3, st);
                    g.gain.exponentialRampToValueAtTime(0.001, st + 0.18);
                    o.start(st); o.stop(st + 0.18);
                });
                break;
            }

            case 'bomb': {
                // Deep thud + noise burst
                const buf = ctx.createBuffer(1, ctx.sampleRate * 0.5, ctx.sampleRate);
                const data = buf.getChannelData(0);
                for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / data.length, 3);
                const src = ctx.createBufferSource();
                src.buffer = buf;
                const g = ctx.createGain();
                const f = ctx.createBiquadFilter();
                f.type = 'lowpass'; f.frequency.value = 180;
                src.connect(f); f.connect(g); g.connect(ctx.destination);
                g.gain.setValueAtTime(1.2, t);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                src.start(t);

                // Sub thud
                const o = ctx.createOscillator();
                const g2 = ctx.createGain();
                o.connect(g2); g2.connect(ctx.destination);
                o.type = 'sine';
                o.frequency.setValueAtTime(120, t);
                o.frequency.exponentialRampToValueAtTime(30, t + 0.4);
                g2.gain.setValueAtTime(0.8, t);
                g2.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
                o.start(t); o.stop(t + 0.4);
                break;
            }

            case 'easteregg': {
                // Silly descending "womp womp"
                [400, 300, 220].forEach((freq, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'sawtooth';
                    const st = t + i * 0.15;
                    o.frequency.setValueAtTime(freq, st);
                    o.frequency.exponentialRampToValueAtTime(freq * 0.7, st + 0.14);
                    g.gain.setValueAtTime(0.25, st);
                    g.gain.exponentialRampToValueAtTime(0.001, st + 0.15);
                    o.start(st); o.stop(st + 0.15);
                });
                break;
            }

            case 'powerup': {
                // Sparkling rising sweep
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.type = 'sine';
                o.frequency.setValueAtTime(330, t);
                o.frequency.exponentialRampToValueAtTime(1320, t + 0.4);
                g.gain.setValueAtTime(0.0, t);
                g.gain.linearRampToValueAtTime(0.4, t + 0.05);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                o.start(t); o.stop(t + 0.5);
                // Shimmer layer
                const o2 = ctx.createOscillator();
                const g2 = ctx.createGain();
                o2.connect(g2); g2.connect(ctx.destination);
                o2.type = 'triangle';
                o2.frequency.setValueAtTime(660, t);
                o2.frequency.exponentialRampToValueAtTime(2640, t + 0.4);
                g2.gain.setValueAtTime(0.2, t);
                g2.gain.exponentialRampToValueAtTime(0.001, t + 0.45);
                o2.start(t); o2.stop(t + 0.45);
                break;
            }

            case 'levelup': {
                // Full celebratory jingle ‚Äî plays while level complete card is shown (~3.5s)
                stopMusic();
                const melody = [
                    {f:523,  t:0.00}, {f:659,  t:0.18}, {f:784,  t:0.36},
                    {f:1047, t:0.54}, {f:784,  t:0.72}, {f:880,  t:0.90},
                    {f:1047, t:1.08}, {f:1175, t:1.32},
                    {f:1047, t:1.56}, {f:880,  t:1.74}, {f:784,  t:1.92},
                    {f:1047, t:2.10}, {f:1319, t:2.40}, {f:1047, t:2.70},
                    {f:784,  t:3.00}, {f:1047, t:3.20}
                ];
                melody.forEach(({f, t: st}) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'sine';
                    o.frequency.value = f;
                    g.gain.setValueAtTime(0.0, t + st);
                    g.gain.linearRampToValueAtTime(0.18, t + st + 0.03);
                    g.gain.exponentialRampToValueAtTime(0.001, t + st + 0.28);
                    o.start(t + st); o.stop(t + st + 0.3);
                });
                // Harmony bass notes
                const bass = [
                    {f:131, t:0.00}, {f:165, t:0.54}, {f:131, t:1.08},
                    {f:196, t:1.56}, {f:131, t:2.10}, {f:196, t:2.70}
                ];
                bass.forEach(({f, t: st}) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'triangle';
                    o.frequency.value = f;
                    g.gain.setValueAtTime(0.12, t + st);
                    g.gain.exponentialRampToValueAtTime(0.001, t + st + 0.45);
                    o.start(t + st); o.stop(t + st + 0.5);
                });
                break;
            }

            case 'gameover': {
                // Sad descending trombone
                [440, 370, 311, 261].forEach((freq, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'sawtooth';
                    const st = t + i * 0.2;
                    o.frequency.setValueAtTime(freq, st);
                    o.frequency.linearRampToValueAtTime(freq * 0.88, st + 0.18);
                    g.gain.setValueAtTime(0.22, st);
                    g.gain.exponentialRampToValueAtTime(0.001, st + 0.22);
                    o.start(st); o.stop(st + 0.22);
                });
                break;
            }

            case 'win': {
                // Big celebratory jingle
                const melody = [523,659,784,1047,784,1047,1319];
                melody.forEach((freq, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = i % 2 === 0 ? 'sine' : 'triangle';
                    const st = t + i * 0.1;
                    o.frequency.setValueAtTime(freq, st);
                    g.gain.setValueAtTime(0.25, st);
                    g.gain.exponentialRampToValueAtTime(0.001, st + 0.2);
                    o.start(st); o.stop(st + 0.2);
                });
                break;
            }

            case 'spawn': {
                // Tiny soft pop
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.type = 'sine';
                o.frequency.setValueAtTime(900, t);
                o.frequency.exponentialRampToValueAtTime(400, t + 0.08);
                g.gain.setValueAtTime(0.15, t);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                o.start(t); o.stop(t + 0.1);
                break;
            }
        }
    } catch(e) {}
}

/* ‚îÄ‚îÄ Per-level music ‚îÄ‚îÄ */
let musicInterval = null;
let musicStep = 0;

/*
  Each song: { bpm, wave, notes[], bass[] }
  notes = melody frequencies (Hz), bass = optional low drone notes
  Level 1 ‚Äî Sweet/dreamy waltz (sine, slow)
  Level 2 ‚Äî Flowing ocean lullaby (triangle, gentle)
  Level 3 ‚Äî Upbeat warm strumming (square, medium)
  Level 4 ‚Äî Mysterious cosmic arp (sawtooth filtered, fast)
  Level 5 ‚Äî Triumphant fanfare (all voices, energetic)
*/
const levelSongs = {
    1: {
        bpm: 320,
        wave: 'sine',
        vol: 0.09,
        notes: [523,659,784,659,784,880,784,659, 523,440,392,440,523,392,330,392],
        bass:  [131,131,131,131, 98, 98, 98, 98, 131,131, 98, 98,131,131, 98, 98]
    },
    2: {
        bpm: 380,
        wave: 'triangle',
        vol: 0.10,
        notes: [440,494,523,587,523,494,440,415, 392,440,494,523,440,392,349,392],
        bass:  [110,110,130,130,110,110, 98, 98,  98, 98,110,110, 98, 98, 87, 87]
    },
    3: {
        bpm: 260,
        wave: 'square',
        vol: 0.06,
        notes: [659,784,880,784,659,587,523,587, 659,784,880,1047,880,784,659,523],
        bass:  [165,165,220,220,165,165,131,131, 165,165,220,220, 165,165,131,131]
    },
    4: {
        bpm: 200,
        wave: 'sawtooth',
        vol: 0.05,
        notes: [293,349,440,523,440,349,293,261, 220,261,330,440,523,440,330,220],
        bass:  [ 73, 73, 87, 87, 87, 87, 73, 73,  55, 55, 73, 73, 87, 87, 73, 73]
    },
    5: {
        bpm: 220,
        wave: 'sine',
        vol: 0.10,
        notes: [523,659,784,1047,784,659,880,1047, 1047,880,784,659,523,659,784,523],
        bass:  [131,165,196, 262,196,165,220, 262,  262,220,196,165,131,165,196,131]
    },
    6: {
        bpm: 300,
        wave: 'triangle',
        vol: 0.08,
        notes: [392,440,494,523,587,523,494,440, 392,349,392,440,523,494,440,392],
        bass:  [ 98, 98,110,131,131,131,110,110,  98, 87, 98,110,131,110,110, 98]
    },
    7: {
        bpm: 340,
        wave: 'sine',
        vol: 0.09,
        notes: [659,698,784,880,784,698,659,622, 587,622,659,698,784,698,622,587],
        bass:  [165,175,196,220,196,175,165,155, 147,155,165,175,196,175,155,147]
    },
    8: {
        bpm: 180,
        wave: 'sawtooth',
        vol: 0.04,
        notes: [220,247,261,294,330,294,261,247, 220,196,220,247,294,261,247,220],
        bass:  [ 55, 55, 65, 73, 82, 73, 65, 65,  55, 49, 55, 65, 73, 65, 65, 55]
    },
    9: {
        bpm: 250,
        wave: 'triangle',
        vol: 0.09,
        notes: [880,988,1047,1175,1047,988,880,831, 784,831,880,988,1047,988,831,784],
        bass:  [220,247, 261, 294, 261,247,220,208, 196,208,220,247, 261,247,208,196]
    },
    10: {
        bpm: 160,
        wave: 'sine',
        vol: 0.11,
        notes: [1047,988,880,784,880,988,1047,1175, 1175,1047,988,880,784,880,1047,1319],
        bass:  [ 262,247,220,196,220,247, 262, 294,  294, 262,247,220,196,220, 262, 330]
    }
};

function startMusic() {
    stopMusic();
    musicStep = 0;
    const song = levelSongs[level] || levelSongs[1];
    const stepMs = song.bpm;

    musicInterval = setInterval(() => {
        if (!soundEnabled) return;
        try {
            const ctx = getAudioCtx();
            const t = ctx.currentTime;
            const idx = musicStep % song.notes.length;
            musicStep++;

            const noteDur = (stepMs / 1000) * 0.85;

            // Melody note
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            o.type = song.wave;
            o.frequency.value = song.notes[idx];
            g.gain.setValueAtTime(0.0, t);
            g.gain.linearRampToValueAtTime(song.vol, t + 0.03);
            g.gain.setValueAtTime(song.vol, t + noteDur * 0.6);
            g.gain.exponentialRampToValueAtTime(0.001, t + noteDur);
            o.start(t); o.stop(t + noteDur);

            // Bass note (sine, quieter)
            if (song.bass && song.bass[idx]) {
                const ob = ctx.createOscillator();
                const gb = ctx.createGain();
                ob.connect(gb); gb.connect(ctx.destination);
                ob.type = 'sine';
                ob.frequency.value = song.bass[idx];
                gb.gain.setValueAtTime(0.0, t);
                gb.gain.linearRampToValueAtTime(song.vol * 0.7, t + 0.05);
                gb.gain.exponentialRampToValueAtTime(0.001, t + noteDur * 1.1);
                ob.start(t); ob.stop(t + noteDur * 1.1);
            }

            // Level 5 gets a shimmer harmony
            if (level === 5) {
                const oh = ctx.createOscillator();
                const gh = ctx.createGain();
                oh.connect(gh); gh.connect(ctx.destination);
                oh.type = 'triangle';
                oh.frequency.value = song.notes[idx] * 1.5;
                gh.gain.setValueAtTime(0.0, t);
                gh.gain.linearRampToValueAtTime(0.04, t + 0.02);
                gh.gain.exponentialRampToValueAtTime(0.001, t + noteDur * 0.8);
                oh.start(t); oh.stop(t + noteDur);
            }

        } catch(e) {}
    }, stepMs);
}

function stopMusic() {
    if (musicInterval) { clearInterval(musicInterval); musicInterval = null; }
}

/* ‚îÄ‚îÄ Menu Music ‚îÄ‚îÄ */
let menuMusicInterval = null;
let menuMusicStep = 0;

/*
  Bouncy ragtime-style waltz ‚Äî upbeat, staccato, playful.
  Structure: A(8) B(8) A(8) C(8) ‚Äî 32 notes then loops.
  Key of C, 3/4 feel at 280ms/step.
*/
const menuSong = {
    bpm: 210,
    melody: [
        // A phrase ‚Äî skippy ascending run
        784, 880,1047,1175, 1047,880, 784, 698,
        // B phrase ‚Äî playful bounce
        659, 784, 880, 784,  698,659, 587, 523,
        // A' phrase ‚Äî higher octave
        1047,1175,1319,1568,1319,1175,1047,880,
        // C phrase ‚Äî descending resolution
        784,  698, 659, 587,  523, 587, 659, 784
    ],
    bass: [
        // Bouncy oom-pah bass: root on beat 1, fifth on beats 2-3
        131,196,196, 147,196,196, 131,196,
        165,220,220, 131,196,196, 123,175,
        131,196,196, 147,196,196, 131,220,
        131,175,165, 123,175,165, 131,196
    ],
    // Staccato pluck layer ‚Äî pizzicato feel
    pluck: [
        1568,0,1319,0, 1175,0,1047,0,
        988, 0, 784,0,  698,0, 659,0,
        1319,0,1047,0, 1319,0,1568,0,
        1047,0, 880,0,  784,0, 880,0
    ]
};

function startMenuMusic() {
    stopMenuMusic();
    menuMusicStep = 0;
    menuMusicInterval = setInterval(() => {
        if (!soundEnabled) return;
        try {
            const ctx = getAudioCtx();
            const t   = ctx.currentTime;
            const idx = menuMusicStep % menuSong.melody.length;
            menuMusicStep++;
            const stepSec = menuSong.bpm / 1000;
            const noteDur = stepSec * 0.72;   // staccato ‚Äî leave a gap

            // ‚îÄ‚îÄ Melody: square wave for that chiptune/toy-piano feel ‚îÄ‚îÄ
            const freq = menuSong.melody[idx];
            if (freq) {
                const om = ctx.createOscillator(); const gm = ctx.createGain();
                om.connect(gm); gm.connect(ctx.destination);
                om.type = 'square';
                om.frequency.value = freq;
                gm.gain.setValueAtTime(0, t);
                gm.gain.linearRampToValueAtTime(0.055, t + 0.008);
                gm.gain.setValueAtTime(0.055, t + noteDur * 0.5);
                gm.gain.exponentialRampToValueAtTime(0.001, t + noteDur);
                om.start(t); om.stop(t + noteDur);

                // Thin sine doubled one octave down for warmth
                const od = ctx.createOscillator(); const gd = ctx.createGain();
                od.connect(gd); gd.connect(ctx.destination);
                od.type = 'sine';
                od.frequency.value = freq / 2;
                gd.gain.setValueAtTime(0.03, t);
                gd.gain.exponentialRampToValueAtTime(0.001, t + noteDur * 0.8);
                od.start(t); od.stop(t + noteDur);
            }

            // ‚îÄ‚îÄ Pluck: very short triangle ping on every other note ‚îÄ‚îÄ
            const pluckFreq = menuSong.pluck[idx];
            if (pluckFreq) {
                const op = ctx.createOscillator(); const gp = ctx.createGain();
                op.connect(gp); gp.connect(ctx.destination);
                op.type = 'triangle';
                op.frequency.value = pluckFreq;
                gp.gain.setValueAtTime(0.05, t);
                gp.gain.exponentialRampToValueAtTime(0.001, t + 0.07);
                op.start(t); op.stop(t + 0.08);
            }

            // ‚îÄ‚îÄ Bass: oom-pah ‚Äî sine, fires on every beat (every 2 steps) ‚îÄ‚îÄ
            if (idx % 2 === 0) {
                const bassFreq = menuSong.bass[idx];
                if (bassFreq) {
                    const ob = ctx.createOscillator(); const gb = ctx.createGain();
                    ob.connect(gb); gb.connect(ctx.destination);
                    ob.type = 'sine';
                    ob.frequency.value = bassFreq;
                    gb.gain.setValueAtTime(0, t);
                    gb.gain.linearRampToValueAtTime(0.10, t + 0.015);
                    gb.gain.exponentialRampToValueAtTime(0.001, t + stepSec * 1.6);
                    ob.start(t); ob.stop(t + stepSec * 1.7);
                }
            }

        } catch(e) {}
    }, menuSong.bpm);
}

function stopMenuMusic() {
    if (menuMusicInterval) { clearInterval(menuMusicInterval); menuMusicInterval = null; }
}

/* ‚îÄ‚îÄ Button sounds ‚îÄ‚îÄ */
function playBtnHover() {
    // Soft, airy click ‚Äî like a light key press
    if (!soundEnabled) return;
    try {
        const ctx = getAudioCtx(); const t = ctx.currentTime;
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.type = 'sine';
        o.frequency.setValueAtTime(880, t);
        o.frequency.linearRampToValueAtTime(1100, t + 0.04);
        g.gain.setValueAtTime(0.18, t);
        g.gain.exponentialRampToValueAtTime(0.001, t + 0.09);
        o.start(t); o.stop(t + 0.09);
    } catch(e) {}
}

function playBtnConfirm() {
    // Bright two-note rising chime ‚Äî satisfying "yes!"
    if (!soundEnabled) return;
    try {
        const ctx = getAudioCtx(); const t = ctx.currentTime;
        [[784, 0], [1047, 0.10]].forEach(([freq, delay]) => {
            const o = ctx.createOscillator(); const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            o.type = 'triangle';
            o.frequency.value = freq;
            g.gain.setValueAtTime(0, t + delay);
            g.gain.linearRampToValueAtTime(0.30, t + delay + 0.012);
            g.gain.exponentialRampToValueAtTime(0.001, t + delay + 0.22);
            o.start(t + delay); o.stop(t + delay + 0.22);
        });
        // Subtle sparkle on top
        const os = ctx.createOscillator(); const gs = ctx.createGain();
        os.connect(gs); gs.connect(ctx.destination);
        os.type = 'sine';
        os.frequency.setValueAtTime(2093, t + 0.08);
        gs.gain.setValueAtTime(0.10, t + 0.08);
        gs.gain.exponentialRampToValueAtTime(0.001, t + 0.22);
        os.start(t + 0.08); os.stop(t + 0.22);
    } catch(e) {}
}

function toggleSound() {
    soundEnabled = !soundEnabled;
    document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîá';
    if (!soundEnabled) {
        stopMusic();
        stopMenuMusic();
        stopBossMusic();
    } else {
        // Resume whichever context is active
        if (!gameStarted) startMenuMusic();
        else startMusic();
    }
}

/* Menu Functions */
function showDifficultySelect() {
    document.getElementById('difficultySelect').style.display = 'block';
}

let startLevel = 1;

function selectStartLevel(lvl) {
    startLevel = lvl;
    document.querySelectorAll('#levelSelect .difficulty-btn').forEach((btn, i) => {
        btn.classList.toggle('selected', i + 1 === lvl);
    });
}

function selectDifficulty(diff, el) {
    difficulty = diff;
    document.querySelectorAll('#difficultyBtns .difficulty-btn').forEach(btn => btn.classList.remove('selected'));
    if (el) el.classList.add('selected');
}

/* ‚îÄ‚îÄ Per-level themes ‚îÄ‚îÄ */
const levelThemeData = {
    1: {
        name: "Sweet Beginnings",
        description: "Pink skies of love",
        bg: 'linear-gradient(180deg, #ff758c 0%, #ff9ab0 60%, #ffb3c6 100%)',
        particles: () => spawnLoop(['üå∏','üå∑','‚úø'], 3000, 13, 'fall', 0.35)
    },
    2: {
        name: "Ocean Dreams",
        description: "Aqua waves of affection",
        bg: 'linear-gradient(180deg, #0099cc 0%, #00ccdd 50%, #a8edea 100%)',
        particles: () => spawnBubbles()
    },
    3: {
        name: "Sunset Romance",
        description: "Warm golden glow",
        bg: 'linear-gradient(180deg, #ff6b35 0%, #f7931e 40%, #ffd89b 100%)',
        particles: () => spawnLoop(['üçÇ','üçÅ','üçÉ'], 800, 20, 'fall', 0.7)
    },
    4: {
        name: "Aurora Night",
        description: "Dancing lights in the sky",
        bg: 'linear-gradient(180deg, #0a0a2e 0%, #0d1b4e 40%, #1a0b4e 100%)',
        particles: () => spawnMeteors()
    },
    5: {
        name: "Golden Sunrise",
        description: "A warm new dawn",
        bg: 'linear-gradient(180deg, #f7971e 0%, #ffd200 50%, #fff176 100%)',
        particles: () => spawnConfetti()
    },
    6: {
        name: "Enchanted Forest",
        description: "Magic in the trees",
        bg: 'linear-gradient(180deg, #134e5e 0%, #1a6b3a 50%, #2d9e5f 100%)',
        particles: () => spawnLoop(['üçÄ','üåø','‚ú®','ü¶ã','üå∫'], 700, 18, 'fall', 0.75)
    },
    7: {
        name: "Cotton Candy Sky",
        description: "Pastel clouds and dreams",
        bg: 'linear-gradient(180deg, #c9d6ff 0%, #e2c9f5 40%, #ffd6f0 100%)',
        particles: () => spawnLoop(['‚òÅÔ∏è','üç¨','üç≠','üíú','üíó'], 900, 20, 'fall', 0.6)
    },
    8: {
        name: "Deep Space",
        description: "Lost among the stars",
        bg: 'linear-gradient(180deg, #000000 0%, #0d0d2b 50%, #1a0533 100%)',
        particles: () => spawnGalaxy()
    },
    9: {
        name: "Cherry Blossom",
        description: "Spring in full bloom",
        bg: 'linear-gradient(180deg, #fceabb 0%, #f8b4c8 50%, #f9d0e0 100%)',
        particles: () => spawnLoop(['üå∏','üå∏','üå∏','üå∑','üå∫','üå∏'], 400, 22, 'fall', 0.8)
    },
    10: {
        name: "Grand Finale ‚ú®",
        description: "You made it ‚Äî all 10 levels!",
        bg: 'linear-gradient(180deg, #0f0c29 0%, #302b63 50%, #24243e 100%)',
        particles: () => spawnFinale()
    }
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BOSS FIGHT SYSTEM ‚Äî ENHANCED
   ‚Ä¢ Cinematic intro with screen flash
   ‚Ä¢ Phase 1 ‚Üí Phase 2 at 50% HP (ENRAGED)
   ‚Ä¢ Per-boss unique attack patterns
   ‚Ä¢ Attack warning lines
   ‚Ä¢ Burst attack mode in enraged phase
   ‚Ä¢ Dramatic boss death sequence
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const bossData = {
    1:  {
        name: 'üåπ THE THORN QUEEN', sprite: 'üåπ', hp: 6, color: '#ff758c',
        taunt: '"Your hearts belong to me!"',
        attacks: ['üåø','üå±','üçÉ'], attackRate: 1400,
        rageAttacks: ['üåø','üåµ','üçÉ','üå±','üåø'], rageRate: 800,
        pattern: 'single'
    },
    2:  {
        name: 'ü¶à DEEP SEA TERROR', sprite: 'ü¶à', hp: 7, color: '#0099cc',
        taunt: '"The depths will claim you!"',
        attacks: ['üåä','üíß','üêö'], attackRate: 1200,
        rageAttacks: ['üåä','üåä','üíß','üêô'], rageRate: 700,
        pattern: 'wave'
    },
    3:  {
        name: 'üî• THE AUTUMN DEMON', sprite: 'üéÉ', hp: 7, color: '#ff6b35',
        taunt: '"Trick or DOOM!"',
        attacks: ['üçÇ','üçÅ','üí®'], attackRate: 1100,
        rageAttacks: ['üî•','üçÇ','üíÄ','üçÅ','üî•'], rageRate: 650,
        pattern: 'spread'
    },
    4:  {
        name: 'üëæ VOID STALKER', sprite: 'üëæ', hp: 8, color: '#6600cc',
        taunt: '"I am inevitable!"',
        attacks: ['‚ö°','üåÄ','üí´'], attackRate: 1000,
        rageAttacks: ['‚ö°','üåÄ','‚ö°','üíÄ','üåÄ'], rageRate: 600,
        pattern: 'zigzag'
    },
    5:  {
        name: '‚òÄÔ∏è SOLAR TITAN', sprite: 'üåû', hp: 8, color: '#f7971e',
        taunt: '"Bow before the sun!"',
        attacks: ['üî•','üí•','‚≠ê'], attackRate: 950,
        rageAttacks: ['üî•','üí•','üî•','‚≠ê','üí•'], rageRate: 550,
        pattern: 'burst'
    },
    6:  {
        name: 'üêâ FOREST DRAGON', sprite: 'üêâ', hp: 9, color: '#134e5e',
        taunt: '"The forest obeys me!"',
        attacks: ['üåø','üî•','üêç'], attackRate: 900,
        rageAttacks: ['üêâ','üî•','üêç','üí®','üî•'], rageRate: 500,
        pattern: 'spread'
    },
    7:  {
        name: 'üç≠ THE SUGAR WITCH', sprite: 'üßô', hp: 9, color: '#c9d6ff',
        taunt: '"Sweet dreams‚Ä¶ forever!"',
        attacks: ['üç¨','üç≠','üç∞'], attackRate: 850,
        rageAttacks: ['üç≠','üç¨','ü¶∑','üç∞','üç´'], rageRate: 480,
        pattern: 'wave'
    },
    8:  {
        name: 'ü§ñ GALAXY OVERLORD', sprite: 'ü§ñ', hp: 10, color: '#330066',
        taunt: '"Resistance is futile!"',
        attacks: ['üíÄ','‚ò¢Ô∏è','üåë'], attackRate: 800,
        rageAttacks: ['üíÄ','‚ò¢Ô∏è','‚ò†Ô∏è','üåë','üíÄ'], rageRate: 450,
        pattern: 'burst'
    },
    9:  {
        name: 'üå∏ BLOSSOM EMPRESS', sprite: 'üë∏', hp: 10, color: '#fceabb',
        taunt: '"Beauty is my weapon!"',
        attacks: ['üå∏','üå∫','üå∑'], attackRate: 750,
        rageAttacks: ['üå∫','üå∏','üíî','üå∑','üå∏'], rageRate: 420,
        pattern: 'spread'
    },
    10: {
        name: 'üíÄ THE FINAL BOSS', sprite: 'üíÄ', hp: 12, color: '#0f0c29',
        taunt: '"No one escapes the end!"',
        attacks: ['üí£','‚ò†Ô∏è','üåë','üî•'], attackRate: 600,
        rageAttacks: ['üíÄ','üí£','‚ò†Ô∏è','üî•','üåë','üíÄ'], rageRate: 350,
        pattern: 'all'
    }
};

let bossActive = false;
let bossHp = 0;
let bossMaxHp = 0;
let bossEnraged = false;
let bossPhase = 1;
let bossAttackInterval = null;
let bossHeartInterval = null;

/* Boss movement (RAF-based, position in px) */
let bossPosX = 0;          // current left px
let bossTargetX = 0;       // chases player
let bossMoveRAF = null;
let bossMoving = false;

/* Shooting */
let shootCooldown = false;
const SHOOT_COOLDOWN_MS = 350;  // min ms between shots

function playBossIntro(boss, onDone) {
    // Screen flash
    const flashEl = document.getElementById('bossFlashEl');
    flashEl.style.display = 'block';
    flashEl.style.animation = 'none';
    void flashEl.offsetWidth;
    flashEl.style.animation = 'bossFlash 0.8s ease forwards';
    setTimeout(() => { flashEl.style.display = 'none'; flashEl.style.animation = ''; }, 900);

    // Cinematic overlay
    const intro = document.getElementById('bossIntro');
    const introSprite = document.getElementById('bossIntroSprite');
    const introName = document.getElementById('bossIntroName');
    const introSub = document.getElementById('bossIntroSub');

    introSprite.textContent = boss.sprite;
    introName.textContent = boss.name;
    introSub.textContent = boss.taunt;

    // Reset
    introSprite.style.cssText = 'transform:scale(0);opacity:0;';
    introName.style.cssText = 'opacity:0;';
    introSub.style.cssText = 'opacity:0;';

    intro.style.display = 'flex';
    intro.style.animation = 'bossIntroBg 2.4s ease forwards';

    // Animate sprite in
    setTimeout(() => {
        introSprite.style.cssText = '';
        introSprite.style.animation = 'bossIntroSpriteIn 0.6s cubic-bezier(0.175,0.885,0.32,1.275) forwards';
        playBossRoar();
    }, 100);

    // Name slides in
    setTimeout(() => {
        introName.style.cssText = '';
        introName.style.animation = 'bossIntroNameIn 0.5s ease forwards';
    }, 600);

    // Taunt fades in
    setTimeout(() => {
        introSub.style.cssText = '';
        introSub.style.animation = 'bossIntroSubIn 0.4s ease forwards';
    }, 1000);

    // Hide after 2.2s
    setTimeout(() => {
        intro.style.display = 'none';
        intro.style.animation = '';
        onDone();
    }, 2300);
}

function startBossFight() {
    const boss = bossData[level];
    if (!boss) { showLevelComplete(); return; }

    bossActive = true;
    bossHp = boss.hp;
    bossMaxHp = boss.hp;
    bossEnraged = false;
    bossPhase = 1;

    stopMusic();

    // Play cinematic intro first, then start the actual fight
    playBossIntro(boss, () => {
        // Setup HUD
        document.getElementById('bossName').textContent = boss.name;
        document.getElementById('bossPhaseTag').textContent = 'Phase 1';
        document.getElementById('bossPhaseTag').classList.remove('enraged');
        document.getElementById('bossHpFill').style.background =
            `linear-gradient(90deg, ${boss.color}, #ff4444)`;
        document.getElementById('bossHpFill').classList.remove('enraged');
        updateBossHpBar();

        const sprite = document.getElementById('bossSprite');
        sprite.textContent = boss.sprite;
        sprite.className = '';

        // Init boss position at top-center, switch to JS-driven positioning
        const gw = getGameWidth();
        bossPosX = gw / 2;
        bossTargetX = gw / 2;
        sprite.style.left = bossPosX + 'px';
        sprite.style.top = '130px';
        sprite.style.transform = 'translateX(-50%)';
        sprite.style.position = 'fixed';
        sprite.style.animation = 'bossBob 1.2s ease-in-out infinite';
        sprite.style.display = 'block';

        document.getElementById('bossHUD').style.display = 'flex';
        document.getElementById('bossArena').style.display = 'block';

        // Show shoot hint
        document.getElementById('shootHint').style.display = 'block';

        startBossMusic();
        startBossMovement();
        scheduleBossAttacks(boss);

        // Hearts become heal pickups during boss
        bossHeartInterval = setInterval(() => {
            if (!bossActive) return;
            createBossHealHeart();
        }, 1400);
    });
}

function createBossHealHeart() {
    const heart = document.createElement('div');
    heart.classList.add('heart');
    heart.innerHTML = 'üíó';
    heart.style.left = Math.random() * (getGameWidth() - 50) + 'px';
    heart.style.animationDuration = (2.0 + Math.random() * 1.0) + 's';
    heart.style.filter = 'drop-shadow(0 0 8px rgba(255,100,200,0.9))';
    heart.style.fontSize = '32px';
    gameArea.appendChild(heart);
    activeItems.push({ el: heart, type: 'bossHeal' });
}

/* ‚îÄ‚îÄ Boss movement loop ‚îÄ‚îÄ */
function startBossMovement() {
    stopBossMovement();
    bossMoving = true;
    bossMoveLoop();
}

function stopBossMovement() {
    bossMoving = false;
    if (bossMoveRAF) { cancelAnimationFrame(bossMoveRAF); bossMoveRAF = null; }
}

let lastBossMoveTime = 0;
function bossMoveLoop(ts) {
    if (!bossMoving || !bossActive) return;

    // Every ~800ms pick a new target position to drift toward
    // Target tracks roughly near player X with some offset
    if (!lastBossMoveTime || ts - lastBossMoveTime > 800) {
        lastBossMoveTime = ts || 0;
        const gw = getGameWidth();
        const jitter = (Math.random() - 0.5) * gw * 0.3;
        // Chase player X (basketX) with jitter so it's not perfectly accurate
        bossTargetX = Math.max(50, Math.min(gw - 50, basketX + jitter));
    }

    // Smooth lerp toward target ‚Äî faster when enraged
    const speed = bossEnraged ? 0.045 : 0.022;
    bossPosX += (bossTargetX - bossPosX) * speed;

    const sprite = document.getElementById('bossSprite');
    sprite.style.left = bossPosX + 'px';

    bossMoveRAF = requestAnimationFrame(bossMoveLoop);
}

function scheduleBossAttacks(boss) {
    clearInterval(bossAttackInterval);
    const rate = bossEnraged ? boss.rageRate : boss.attackRate;
    const attacks = bossEnraged ? boss.rageAttacks : boss.attacks;

    bossAttackInterval = setInterval(() => {
        if (!bossActive) return;
        spawnBossAttackPattern(boss, attacks);
    }, rate);
}

function spawnBossAttackPattern(boss, attacks) {
    const pattern = bossEnraged ? 'burst' : boss.pattern;

    if (pattern === 'wave' && bossEnraged) {
        // 3 attacks across the screen in a sweep
        for (let i = 0; i < 3; i++) {
            setTimeout(() => {
                if (!bossActive) return;
                spawnOneBossAttack(attacks, bossEnraged);
            }, i * 180);
        }
    } else if (pattern === 'burst' || (bossEnraged && Math.random() < 0.35)) {
        // 2 attacks at once
        spawnOneBossAttack(attacks, bossEnraged);
        setTimeout(() => {
            if (!bossActive) return;
            spawnOneBossAttack(attacks, bossEnraged);
        }, 150);
    } else if (pattern === 'spread' && bossEnraged) {
        // 3 spread across fixed positions
        [0.2, 0.5, 0.8].forEach((frac, i) => {
            setTimeout(() => {
                if (!bossActive) return;
                spawnOneBossAttack(attacks, bossEnraged, frac * getGameWidth());
            }, i * 100);
        });
    } else if (pattern === 'all') {
        // Final boss: 3 attacks always
        const count = bossEnraged ? 4 : 2;
        for (let i = 0; i < count; i++) {
            setTimeout(() => {
                if (!bossActive) return;
                spawnOneBossAttack(attacks, bossEnraged);
            }, i * 100);
        }
    } else {
        spawnOneBossAttack(attacks, bossEnraged);
    }
}

function spawnOneBossAttack(attacks, enraged, fixedX) {
    // Show warning line briefly before attack
    if (enraged && Math.random() < 0.5) {
        const x = fixedX !== undefined ? fixedX : (Math.random() * (getGameWidth() - 60));
        spawnAttackWarning(x);
        setTimeout(() => {
            if (!bossActive) return;
            _createBossAttackEl(attacks, enraged, x);
        }, 350);
    } else {
        const x = fixedX !== undefined ? fixedX : (Math.random() * (getGameWidth() - 60));
        _createBossAttackEl(attacks, enraged, x);
    }
}

function spawnAttackWarning(x) {
    const warn = document.createElement('div');
    warn.className = 'attack-warning';
    warn.style.left = (x + 14) + 'px';
    warn.style.height = '100%';
    gameArea.appendChild(warn);
    setTimeout(() => warn.remove(), 600);
}

function _createBossAttackEl(attacks, enraged, x) {
    const el = document.createElement('div');
    el.className = 'boss-attack' + (enraged ? ' enraged-attack' : '');
    el.textContent = attacks[Math.floor(Math.random() * attacks.length)];
    el.style.left = x + 'px';
    el.style.top = '200px';
    const baseDur = enraged ? (Math.random() * 0.7 + 0.8) : (Math.random() * 1.2 + 1.2);
    el.style.animationDuration = baseDur.toFixed(2) + 's';
    gameArea.appendChild(el);
    activeItems.push({ el, type: 'bossattack' });
}

function hitBoss() {
    if (!bossActive) return;
    bossHp--;
    updateBossHpBar();

    // Flash the sprite
    const sprite = document.getElementById('bossSprite');
    sprite.style.animation = 'bossHit 0.3s ease forwards';
    setTimeout(() => {
        if (!bossActive) return;
        sprite.style.animation = bossEnraged
            ? 'bossRageBob 0.6s ease-in-out infinite'
            : 'bossBob 1.2s ease-in-out infinite';
    }, 320);

    playSound('catch');

    // Check for Phase 2 transition (50% HP)
    if (!bossEnraged && bossHp <= Math.floor(bossMaxHp / 2)) {
        triggerBossEnrage();
        return;
    }

    if (bossHp <= 0) {
        defeatedBoss();
    }
}

function triggerBossEnrage() {
    bossEnraged = true;
    bossPhase = 2;
    const boss = bossData[level];

    // Screen shake
    screenShake();

    // Show rage banner
    const banner = document.getElementById('bossRageBanner');
    banner.style.display = 'block';
    banner.style.animation = 'none';
    void banner.offsetWidth;
    banner.style.animation = 'rageBannerPop 0.5s cubic-bezier(0.175,0.885,0.32,1.275) forwards';
    setTimeout(() => {
        banner.style.animation = 'countFade 0.4s ease-out forwards';
        setTimeout(() => { banner.style.display = 'none'; }, 400);
    }, 1800);

    // Update HUD
    document.getElementById('bossPhaseTag').textContent = 'üò° ENRAGED';
    document.getElementById('bossPhaseTag').classList.add('enraged');
    document.getElementById('bossHpFill').classList.add('enraged');

    // Sprite becomes enraged
    const sprite = document.getElementById('bossSprite');
    sprite.classList.add('enraged');

    showPopup('üí¢ PHASE 2 ‚Äî ENRAGED!');
    playBossRoar();

    // Restart attacks at faster rate + speed up movement
    scheduleBossAttacks(boss);
    // Re-trigger movement loop so speed variable is picked up
    stopBossMovement();
    startBossMovement();
}

function updateBossHpBar() {
    const pct = Math.max(0, bossHp / bossMaxHp * 100);
    document.getElementById('bossHpFill').style.width = pct + '%';
    document.getElementById('bossHpText').textContent = `${Math.max(0,bossHp)} / ${bossMaxHp} HP`;

    // Shake the bar on hit
    const bar = document.getElementById('bossHUD');
    bar.style.animation = 'bossHpShake 0.2s ease';
    setTimeout(() => { bar.style.animation = ''; }, 220);
}

function spawnBossEmbers(x, y, count) {
    for (let i = 0; i < count; i++) {
        const em = document.createElement('div');
        em.className = 'boss-ember';
        em.textContent = ['üî•','üí•','‚ú®','‚ö°','üåü'][Math.floor(Math.random() * 5)];
        em.style.left = (x + (Math.random() - 0.5) * 60) + 'px';
        em.style.top  = (y + (Math.random() - 0.5) * 40) + 'px';
        em.style.setProperty('--ex', ((Math.random() - 0.5) * 80) + 'px');
        em.style.animationDuration = (0.5 + Math.random() * 0.6) + 's';
        em.style.animationDelay = (Math.random() * 0.3) + 's';
        document.body.appendChild(em);
        setTimeout(() => em.remove(), 1200);
    }
}

function spawnBossShockwave(x, y) {
    const sw = document.createElement('div');
    sw.className = 'boss-shockwave';
    sw.style.left = x + 'px';
    sw.style.top  = y + 'px';
    document.body.appendChild(sw);
    setTimeout(() => sw.remove(), 800);

    // Second ring slightly delayed
    setTimeout(() => {
        const sw2 = document.createElement('div');
        sw2.className = 'boss-shockwave';
        sw2.style.left = x + 'px';
        sw2.style.top  = y + 'px';
        sw2.style.borderColor = 'rgba(255,255,100,0.7)';
        sw2.style.boxShadow = '0 0 20px rgba(255,255,0,0.5)';
        document.body.appendChild(sw2);
        setTimeout(() => sw2.remove(), 800);
    }, 160);
}

function spawnImpactFlash(x, y) {
    const fl = document.createElement('div');
    fl.className = 'boss-impact-flash';
    fl.style.left = x + 'px';
    fl.style.top  = y + 'px';
    document.body.appendChild(fl);
    setTimeout(() => fl.remove(), 600);
}

function spawnDebris(x, y, bossSprite) {
    const pieces = [bossSprite, 'üí•', 'üî•', '‚ö°', '‚ú®', 'üí´'];
    for (let i = 0; i < 8; i++) {
        const db = document.createElement('div');
        db.className = 'boss-debris';
        db.textContent = pieces[Math.floor(Math.random() * pieces.length)];
        db.style.left = x + 'px';
        db.style.top  = y + 'px';
        const angle = (i / 8) * Math.PI * 2;
        const dist  = 80 + Math.random() * 140;
        db.style.setProperty('--dx', (Math.cos(angle) * dist) + 'px');
        db.style.setProperty('--dy', (Math.sin(angle) * dist - 60) + 'px');
        db.style.setProperty('--dr', ((Math.random() - 0.5) * 720) + 'deg');
        db.style.animationDuration = (0.8 + Math.random() * 0.5) + 's';
        document.body.appendChild(db);
        setTimeout(() => db.remove(), 1500);
    }
}

function defeatedBoss() {
    bossActive = false;
    clearInterval(bossAttackInterval);
    clearInterval(bossHeartInterval);
    clearActiveItems();
    stopBossMusic();

    const sprite = document.getElementById('bossSprite');
    sprite.classList.remove('enraged');
    const bossEmoji = sprite.textContent;

    // Get current sprite position for effects
    const spriteRect = sprite.getBoundingClientRect();
    const sx = spriteRect.left + spriteRect.width / 2;
    const sy = spriteRect.top  + spriteRect.height / 2;

    // ‚îÄ‚îÄ PHASE 1: Stagger (0‚Äì600ms) ‚îÄ‚îÄ
    // Boss staggers left-right, embers start rising
    sprite.style.transition = 'none';
    sprite.style.animation = 'bossStagger 0.6s ease forwards';
    screenShake();
    playBossRoar();

    // Continuous embers while falling
    const emberInterval = setInterval(() => {
        const r = sprite.getBoundingClientRect();
        spawnBossEmbers(r.left + r.width / 2, r.top + r.height / 2, 3);
    }, 120);

    // Slow burn music sting
    playBossDeathSound();

    // ‚îÄ‚îÄ PHASE 2: Catch fire + slow fall (600‚Äì2200ms) ‚îÄ‚îÄ
    setTimeout(() => {
        showPopup('üí• BOSS DEFEATED! üí•');
        sprite.style.fontSize = 'clamp(4rem, 16vw, 7rem)'; // grow slightly as it falls
        sprite.style.animation = 'bossFallDown 1.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards';
        sprite.style.filter = 'drop-shadow(0 0 20px rgba(255,80,0,1)) brightness(1.5)';

        // More embers as it falls
        setTimeout(() => clearInterval(emberInterval), 1700);
    }, 600);

    // ‚îÄ‚îÄ PHASE 3: Impact explosion (2200ms) ‚îÄ‚îÄ
    setTimeout(() => {
        clearInterval(emberInterval);

        // Impact position ‚Äî near bottom of screen
        const impactX = getGameWidth() / 2;
        const impactY = window.innerHeight * 0.82;

        // Hide sprite, replace with explosion
        sprite.style.display = 'none';

        // Screen flash
        const flashEl = document.getElementById('bossFlashEl');
        flashEl.style.display = 'block';
        flashEl.style.animation = 'none';
        void flashEl.offsetWidth;
        flashEl.style.animation = 'bossFlash 0.7s ease forwards';
        setTimeout(() => { flashEl.style.display = 'none'; flashEl.style.animation = ''; }, 800);

        // Heavy screen shake on impact
        gameArea.style.animation = 'screenShake 0.5s ease';
        setTimeout(() => { gameArea.style.animation = ''; }, 500);

        // Impact flash + shockwaves + debris
        spawnImpactFlash(impactX, impactY);
        spawnBossShockwave(impactX, impactY);
        spawnDebris(impactX, impactY, bossEmoji);

        // Multiple particle bursts
        for (let i = 0; i < 5; i++) {
            setTimeout(() => {
                spawnParticles(
                    impactX + (Math.random() - 0.5) * 120,
                    impactY + (Math.random() - 0.5) * 60
                );
            }, i * 80);
        }

        // Second shockwave + extra embers
        setTimeout(() => {
            spawnBossShockwave(impactX, impactY);
            spawnBossEmbers(impactX, impactY, 10);
        }, 200);

        playSound('bomb');
    }, 2200);

    // ‚îÄ‚îÄ PHASE 4: Cleanup + level complete (3400ms) ‚îÄ‚îÄ
    setTimeout(() => {
        sprite.style.display = 'none';
        sprite.style.animation = '';
        sprite.style.filter = '';
        sprite.style.fontSize = '';
        document.getElementById('bossHUD').style.display = 'none';
        document.getElementById('bossArena').style.display = 'none';
        document.getElementById('bossRageBanner').style.display = 'none';
        playSound('levelup');
        showLevelComplete();
    }, 3400);
}

function playBossDeathSound() {
    try {
        const ctx = getAudioCtx(); const t = ctx.currentTime;
        // Descending dramatic chord
        [220, 185, 155, 110].forEach((f, i) => {
            const o = ctx.createOscillator(); const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            o.type = 'sawtooth';
            o.frequency.setValueAtTime(f * 2, t + i * 0.18);
            o.frequency.exponentialRampToValueAtTime(f * 0.5, t + i * 0.18 + 0.9);
            g.gain.setValueAtTime(0.22, t + i * 0.18);
            g.gain.exponentialRampToValueAtTime(0.001, t + i * 0.18 + 1.0);
            o.start(t + i * 0.18); o.stop(t + i * 0.18 + 1.0);
        });
        // Low rumble underneath
        const ob = ctx.createOscillator(); const gb = ctx.createGain();
        ob.connect(gb); gb.connect(ctx.destination);
        ob.type = 'sine';
        ob.frequency.setValueAtTime(80, t);
        ob.frequency.exponentialRampToValueAtTime(20, t + 2.0);
        gb.gain.setValueAtTime(0.3, t);
        gb.gain.exponentialRampToValueAtTime(0.001, t + 2.2);
        ob.start(t); ob.stop(t + 2.2);
    } catch(e) {}
}

function endBossFight() {
    bossActive = false;
    bossEnraged = false;
    clearInterval(bossAttackInterval);
    clearInterval(bossHeartInterval);
    stopBossMovement();
    const sprite = document.getElementById('bossSprite');
    sprite.style.display = 'none';
    sprite.classList.remove('enraged');
    // Reset position for next time
    sprite.style.left = '';
    sprite.style.top = '';
    sprite.style.transform = '';
    sprite.style.position = '';
    document.getElementById('bossHUD').style.display = 'none';
    document.getElementById('bossArena').style.display = 'none';
    document.getElementById('bossRageBanner').style.display = 'none';
    document.getElementById('bossIntro').style.display = 'none';
    document.getElementById('bossFlashEl').style.display = 'none';
    document.getElementById('shootHint').style.display = 'none';
    // Clear any in-flight projectiles
    activeProjectiles.forEach(p => p.el.remove());
    activeProjectiles = [];
    stopBossMusic();
}

/* Boss music ‚Äî tense repeating loop, faster in rage */
let bossMusicInterval = null;
function startBossMusic() {
    stopBossMusic();
    let step = 0;
    const notes = [220,196,220,196,246,220,196,174, 174,196,220,174,130,146,174,130];
    const bpm = bossEnraged ? 110 : 160;
    bossMusicInterval = setInterval(() => {
        if (!soundEnabled) return;
        try {
            const ctx = getAudioCtx();
            const t = ctx.currentTime;
            const freq = notes[step % notes.length]; step++;
            // Extra distorted layer in enrage
            const wave = bossEnraged ? 'square' : 'sawtooth';
            const vol = bossEnraged ? 0.09 : 0.07;
            const o = ctx.createOscillator(); const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            o.type = wave; o.frequency.value = freq;
            g.gain.setValueAtTime(vol, t);
            g.gain.exponentialRampToValueAtTime(0.001, t + 0.22);
            o.start(t); o.stop(t + 0.25);

            // Extra percussive hit every 4 steps in rage
            if (bossEnraged && step % 4 === 0) {
                const ob = ctx.createOscillator(); const gb = ctx.createGain();
                ob.connect(gb); gb.connect(ctx.destination);
                ob.type = 'sine'; ob.frequency.setValueAtTime(60, t);
                ob.frequency.exponentialRampToValueAtTime(20, t + 0.12);
                gb.gain.setValueAtTime(0.15, t);
                gb.gain.exponentialRampToValueAtTime(0.001, t + 0.15);
                ob.start(t); ob.stop(t + 0.15);
            }
        } catch(e) {}
    }, bpm);
}
function stopBossMusic() {
    if (bossMusicInterval) { clearInterval(bossMusicInterval); bossMusicInterval = null; }
}

function playBossRoar() {
    try {
        const ctx = getAudioCtx(); const t = ctx.currentTime;
        [80,60,50,40].forEach((f,i) => {
            const o = ctx.createOscillator(); const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            o.type = 'sawtooth'; o.frequency.setValueAtTime(f*3, t+i*0.12);
            o.frequency.exponentialRampToValueAtTime(f, t+i*0.12+0.5);
            g.gain.setValueAtTime(0.18, t+i*0.12);
            g.gain.exponentialRampToValueAtTime(0.001, t+i*0.12+0.55);
            o.start(t+i*0.12); o.stop(t+i*0.12+0.6);
        });
    } catch(e) {}
}

function applyTheme() {
    // Clear old particles
    clearParticles();

    const theme = levelThemeData[level] || levelThemeData[1];
    document.body.style.background = theme.bg;

    // Start this level's particles
    theme.particles();
}

function clearParticles() {
    if (themeAnimationInterval) {
        clearInterval(themeAnimationInterval);
        themeAnimationInterval = null;
    }
    document.querySelectorAll('.bg-particle').forEach(el => el.remove());
}

function spawnParticleEl(content, isStar) {
    const el = document.createElement('div');
    el.className = 'bg-particle';
    el.style.left = (Math.random() * 100) + 'vw';
    el.style.top = '-60px';
    el.style.fontSize = (Math.random() * 14 + 14) + 'px';
    el.style.zIndex = '1';

    if (isStar) {
        el.style.width  = (Math.random() * 4 + 2) + 'px';
        el.style.height = el.style.width;
        el.style.background = 'white';
        el.style.borderRadius = '50%';
        el.style.boxShadow = '0 0 6px 2px rgba(255,255,255,0.9)';
        el.style.top  = (Math.random() * 100) + 'vh';
        el.style.left = (Math.random() * 100) + 'vw';
        el.style.animation = `bgPulse ${(Math.random() * 2 + 1.5).toFixed(2)}s ease-in-out infinite`;
        el.style.animationDelay = (Math.random() * 3) + 's';
        el.style.position = 'fixed';
        document.body.appendChild(el);
        return el;
    }

    el.textContent = content;
    el.style.animation = `bgFall ${(Math.random() * 4 + 4).toFixed(2)}s linear forwards`;
    el.style.animationDelay = (Math.random() * 0.5) + 's';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 9000);
    return el;
}

function spawnLoop(emojis, interval, fontSize, mode, opacity = 1) {
    themeAnimationInterval = setInterval(() => {
        const el = document.createElement('div');
        el.className = 'bg-particle';
        el.style.position = 'fixed';
        el.style.left = (Math.random() * 98) + 'vw';
        el.style.top = '-50px';
        el.style.fontSize = (Math.random() * 6 + fontSize - 3) + 'px';
        el.style.zIndex = '1';
        el.style.opacity = opacity;
        el.style.pointerEvents = 'none';
        el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        const dur = (Math.random() * 4 + 5).toFixed(2);
        el.style.animation = `bgFall ${dur}s linear forwards`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), (parseFloat(dur) + 0.5) * 1000);
    }, interval);
}

function spawnMeteors() {
    // Diagonal meteors streaking across ‚Äî very different from stars
    themeAnimationInterval = setInterval(() => {
        const el = document.createElement('div');
        el.className = 'bg-particle';
        el.style.position = 'fixed';
        el.style.left = (Math.random() * 90) + 'vw';
        el.style.top = '-10px';
        el.style.fontSize = (Math.random() * 8 + 12) + 'px';
        el.style.zIndex = '1';
        el.style.pointerEvents = 'none';
        el.style.filter = 'drop-shadow(0 0 6px rgba(150,100,255,0.9))';
        el.textContent = ['üå†','üíú','üîÆ'][Math.floor(Math.random() * 3)];
        const dur = (Math.random() * 1.5 + 1.5).toFixed(2);
        // Diagonal fall using bgMeteor keyframe
        el.style.animation = `bgMeteor ${dur}s linear forwards`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), (parseFloat(dur) + 0.3) * 1000);
    }, 600);
}

function spawnConfetti() {
    const pieces = ['üåü','‚≠ê','‚ú®','üíõ','üéä','üéâ'];
    themeAnimationInterval = setInterval(() => {
        const el = document.createElement('div');
        el.className = 'bg-particle';
        el.style.position = 'fixed';
        el.style.left = (Math.random() * 98) + 'vw';
        el.style.top = '-50px';
        el.style.fontSize = (Math.random() * 10 + 12) + 'px';
        el.style.zIndex = '1';
        el.style.pointerEvents = 'none';
        el.textContent = pieces[Math.floor(Math.random() * pieces.length)];
        const dur = (Math.random() * 3 + 4).toFixed(2);
        el.style.animation = `bgFall ${dur}s linear forwards`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), (parseFloat(dur) + 0.5) * 1000);
    }, 350);
}

function spawnGalaxy() {
    // Tiny glowing orbs drifting slowly ‚Äî deep space feel
    const colors = ['rgba(180,100,255,0.9)','rgba(100,180,255,0.9)','rgba(255,255,255,0.9)','rgba(255,100,200,0.8)'];
    themeAnimationInterval = setInterval(() => {
        const el = document.createElement('div');
        el.className = 'bg-particle';
        el.style.position = 'fixed';
        el.style.left = (Math.random() * 98) + 'vw';
        el.style.top = '-20px';
        el.style.zIndex = '1';
        el.style.pointerEvents = 'none';
        const size = Math.random() * 5 + 3;
        el.style.width  = size + 'px';
        el.style.height = size + 'px';
        el.style.borderRadius = '50%';
        const col = colors[Math.floor(Math.random() * colors.length)];
        el.style.background = col;
        el.style.boxShadow = `0 0 ${size * 3}px ${size}px ${col}`;
        const dur = (Math.random() * 6 + 7).toFixed(2);
        el.style.animation = `bgFall ${dur}s linear forwards`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), (parseFloat(dur) + 0.5) * 1000);
    }, 180);
}

function spawnFinale() {
    // Everything ‚Äî meteors, confetti, sparkles all at once
    const all = ['üåü','üéâ','üí•','üéä','‚ú®','üí´','üå†','‚ù§Ô∏è','üíï','üî•'];
    themeAnimationInterval = setInterval(() => {
        for (let i = 0; i < 3; i++) {
            const el = document.createElement('div');
            el.className = 'bg-particle';
            el.style.position = 'fixed';
            el.style.left = (Math.random() * 98) + 'vw';
            el.style.top = '-50px';
            el.style.fontSize = (Math.random() * 14 + 14) + 'px';
            el.style.zIndex = '1';
            el.style.pointerEvents = 'none';
            el.textContent = all[Math.floor(Math.random() * all.length)];
            const dur = (Math.random() * 3 + 3).toFixed(2);
            el.style.animation = `bgFall ${dur}s linear forwards`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), (parseFloat(dur) + 0.5) * 1000);
        }
    }, 200);
}

function spawnBubbles() {
    // Bubbles rise from bottom
    themeAnimationInterval = setInterval(() => {
        const el = document.createElement('div');
        el.className = 'bg-particle';
        el.style.position = 'fixed';
        el.style.left = (Math.random() * 95) + 'vw';
        el.style.bottom = '-40px';
        el.style.top = 'auto';
        el.style.zIndex = '1';
        el.style.pointerEvents = 'none';
        const size = Math.random() * 22 + 10;
        el.style.width  = size + 'px';
        el.style.height = size + 'px';
        el.style.borderRadius = '50%';
        el.style.border = '2px solid rgba(255,255,255,0.6)';
        el.style.background = 'rgba(255,255,255,0.15)';
        const dur = (Math.random() * 4 + 4).toFixed(2);
        el.style.animation = `bgBubble ${dur}s ease-in forwards`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), (parseFloat(dur) + 0.3) * 1000);
    }, 400);
}

function showHowToPlay() {
    document.getElementById('menuOverlay').style.display = 'none';
    document.getElementById('howToPlay').style.display = 'flex';
}

function closeHowToPlay() {
    document.getElementById('howToPlay').style.display = 'none';
    document.getElementById('menuOverlay').style.display = 'flex';
}

function backToMenu() {
    location.reload();
}

/* ‚îÄ‚îÄ Level difficulty scaling ‚îÄ‚îÄ */
function getLevelConfig(lvl) {
    // Difficulty multiplier per menu setting
    const diffMult = { easy: 0.75, medium: 1.0, hard: 1.35 }[difficulty] || 1.0;

    // Base values that tighten each level
    //   spawnMs  : how often a new item spawns (lower = faster)
    //   fallBase : base fall duration in seconds (lower = faster falling)
    //   fallRand : random extra seconds added to fall (lower = less variance)
    //   bombChance   : probability 0-1 of spawning a bomb
    //   eggChance    : probability 0-1 of spawning easter egg
    //   powerupChance: probability 0-1 of spawning powerup
    const base = {
        spawnMs:       Math.max(400, 1400 - (lvl - 1) * 100),  // 1400 ‚Üí 500ms
        fallBase:      Math.max(0.8, 2.8 - (lvl - 1) * 0.2),   // 2.8s ‚Üí 1.0s
        fallRand:      Math.max(0.3, 1.5 - (lvl - 1) * 0.13),  // 1.5s ‚Üí 0.3s variance
        bombChance:    Math.min(0.22, 0.04 + (lvl - 1) * 0.02),// 4% ‚Üí 22%
        eggChance:     Math.min(0.30, 0.08 + (lvl - 1) * 0.025),// 8% ‚Üí 30%
        powerupChance: Math.max(0.04, 0.12 - (lvl - 1) * 0.008)// 12% ‚Üí 5%
    };

    // Apply difficulty multiplier to speed (lower spawnMs = harder)
    base.spawnMs  = Math.round(base.spawnMs / diffMult);
    base.fallBase = base.fallBase / diffMult;

    return base;
}

/* Game Functions */
function startGame() {
    document.getElementById('menuOverlay').style.display = 'none';
    gameStarted = true;
    lives = 3;
    score = 0;
    heartsThisLevel = 0;
    level = startLevel;
    streak = 0;
    combo = 0;
    maxStreak = 0;

    // Clear any leftover items from a previous game
    clearActiveItems();

    // Clear any leftover projectiles
    activeProjectiles.forEach(p => p.el.remove());
    activeProjectiles = [];

    // Reset collision loop flag so it always starts fresh on restart
    collisionLoopRunning = false;

    updateLivesDisplay();
    updateHeartsDisplay();
    applyTheme();
    showLevelTransition();

    // Don't spawn until GO (at 2s into countdown)
    setTimeout(() => {
        if (gameStarted) restartSpawnInterval();
    }, 2000);
    setInterval(createSparkle, 300);
    setInterval(createLoveText, 4000);

    startCollisionLoop();

    stopMenuMusic();
    stopMenuHearts();
    if (soundEnabled) startMusic();
}

function restartSpawnInterval() {
    clearInterval(spawnInterval);
    const cfg = getLevelConfig(level);
    spawnInterval = setInterval(createItem, cfg.spawnMs);
}

function updateLevelTheme() {
    applyTheme();
    if (soundEnabled) startMusic();
}

function showLevelTransition() {
    const theme = levelThemeData[level];
    if (!theme) return;

    const cfg = getLevelConfig(level);
    const speedLabel = level <= 2 ? 'üê¢ Chill' : level <= 4 ? 'üö∂ Easy' : level <= 6 ? 'üèÉ Medium' : level <= 8 ? '‚ö° Fast' : 'üî• Intense';
    const dangerPct  = Math.round((cfg.bombChance + cfg.eggChance) * 100);

    // Show level info briefly at top of screen (no dark overlay)
    const transition = document.getElementById('levelTransition');
    transition.querySelector('.level-number').textContent = `Level ${level} ‚Äî ${theme.name}`;
    transition.querySelector('.level-theme').textContent = theme.description;
    transition.querySelector('.level-description').textContent = `${speedLabel}  ‚Ä¢  ${dangerPct}% danger`;
    transition.style.display = 'flex';
    setTimeout(() => { transition.style.display = 'none'; }, 3800);

    // Ready... Steady... GO! countdown
    const cd = document.getElementById('countdown');
    const steps = [
        { text: 'READY', color: '#FFD700' },
        { text: 'STEADY', color: '#ff9a00' },
        { text: 'GO! üöÄ', color: '#00e676' }
    ];

    steps.forEach(({ text, color }, i) => {
        setTimeout(() => {
            cd.textContent = text;
            cd.style.color = color;
            cd.style.display = 'block';
            cd.style.animation = 'none';
            // Force reflow to restart animation
            void cd.offsetWidth;
            cd.style.animation = 'countPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';

            // Sound: tick for READY/STEADY, fanfare for GO
            if (soundEnabled) {
                if (i < 2) playCountdownTick(i);
                else       playCountdownGo();
            }

            // Fade out before next step
            setTimeout(() => {
                cd.style.animation = 'countFade 0.3s ease-out forwards';
            }, 650);
        }, i * 1000);
    });

    // Hide after GO
    setTimeout(() => { cd.style.display = 'none'; }, 3200);
}

function playCountdownTick(step) {
    // READY = lower pitch, STEADY = slightly higher ‚Äî classic "beep beep"
    try {
        const ctx = getAudioCtx(); const t = ctx.currentTime;
        const freq = step === 0 ? 440 : 554; // A4 ‚Üí C#5

        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.type = 'sine';
        o.frequency.setValueAtTime(freq, t);
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(0.45, t + 0.01);
        g.gain.setValueAtTime(0.45, t + 0.09);
        g.gain.exponentialRampToValueAtTime(0.001, t + 0.22);
        o.start(t); o.stop(t + 0.22);

        // Subtle harmonic layer
        const o2 = ctx.createOscillator(); const g2 = ctx.createGain();
        o2.connect(g2); g2.connect(ctx.destination);
        o2.type = 'triangle';
        o2.frequency.value = freq * 2;
        g2.gain.setValueAtTime(0.12, t);
        g2.gain.exponentialRampToValueAtTime(0.001, t + 0.18);
        o2.start(t); o2.stop(t + 0.18);
    } catch(e) {}
}

function playCountdownGo() {
    // "GO!" ‚Äî bright rising fanfare chord
    try {
        const ctx = getAudioCtx(); const t = ctx.currentTime;
        // Three-note rising arpeggio: E5 ‚Üí G#5 ‚Üí B5
        [[659, 0], [830, 0.08], [987, 0.16]].forEach(([freq, delay]) => {
            const o = ctx.createOscillator(); const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            o.type = 'triangle';
            o.frequency.setValueAtTime(freq, t + delay);
            g.gain.setValueAtTime(0, t + delay);
            g.gain.linearRampToValueAtTime(0.4, t + delay + 0.02);
            g.gain.setValueAtTime(0.4, t + delay + 0.1);
            g.gain.exponentialRampToValueAtTime(0.001, t + delay + 0.45);
            o.start(t + delay); o.stop(t + delay + 0.45);
        });
        // Punchy sub hit on the downbeat
        const ob = ctx.createOscillator(); const gb = ctx.createGain();
        ob.connect(gb); gb.connect(ctx.destination);
        ob.type = 'sine';
        ob.frequency.setValueAtTime(200, t);
        ob.frequency.exponentialRampToValueAtTime(60, t + 0.15);
        gb.gain.setValueAtTime(0.5, t);
        gb.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
        ob.start(t); ob.stop(t + 0.2);
    } catch(e) {}
}

function restartGame() {
    document.getElementById('gameOver').style.display = 'none';
    startGame();
}

function updateHeartsDisplay() {
    scoreDisplay.textContent = `${heartsThisLevel}/10`;
    levelDisplay.textContent = level;
    streakDisplay.textContent = streak;
}

function updateLivesDisplay() {
    livesDisplay.textContent = 'üíñ'.repeat(lives);
}

function loseLife() {
    lives--;
    updateLivesDisplay();
    
    if (lives <= 0) {
        gameOver();
    }
}

function gameOver() {
    const imgEl = document.getElementById('gameOverImg');
    imgEl.innerHTML = `<img src="${ME_SAD}" style="height:100px;width:auto;border-radius:12px;object-fit:cover;">`;
    document.getElementById('gameOverTitle').textContent = 'üíî Game Over';
    
    if (score > highScore) {
        highScore = score;
        localStorage.setItem('beatrix_highscore', highScore);
    }
    
    document.getElementById('gameOverScore').textContent = `${score} hearts collected üíñ`;
    document.getElementById('gameOverHigh').textContent = `Best: ${highScore} üèÜ`;
    document.getElementById('gameOverStreak').textContent = `Max Streak: ${maxStreak} üî•`;
    document.getElementById('gameOverLevel').textContent = `Reached Level ${level}`;
    
    gameStarted = false;
    clearInterval(spawnInterval);
    stopMusic();
    endBossFight();
    playSound('gameover');
    
    setTimeout(() => {
        document.getElementById('gameOver').style.display = 'flex';
    }, 1000);
}

function clearActiveItems() {
    for (let i = activeItems.length - 1; i >= 0; i--) {
        activeItems[i].el.remove();
    }
    activeItems = [];
}

function checkLevelUp() {
    if (heartsThisLevel >= 10) {
        // Stop normal spawning and wipe screen
        clearInterval(spawnInterval);
        clearActiveItems();
        // Start boss fight instead of going straight to level complete
        startBossFight();
    }
}

const levelEmojis = {1:'üå∏',2:'üåä',3:'üçÇ',4:'üå†',5:'‚òÄÔ∏è',6:'üåø',7:'üç¨',8:'üåå',9:'üå∫',10:'üéâ'};
const levelMessages = {
    1:'Pink skies cleared! üå∏', 2:'Waves conquered! üåä', 3:'Autumn mastered! üçÇ',
    4:'Stars aligned! üå†',      5:'Sunrise claimed! ‚òÄÔ∏è', 6:'Forest explored! üåø',
    7:'Sugar rush! üç¨',         8:'Deep space! üåå',       9:'Blossoms caught! üå∫',
    10:'LEGENDARY! üéâ'
};

function showLevelComplete() {
    const completedLevel = level;
    const theme = levelThemeData[completedLevel] || {};

    document.getElementById('lcEmoji').textContent   = levelEmojis[completedLevel] || 'üéâ';
    document.getElementById('lcTitle').textContent   = `Level ${completedLevel} Complete!`;
    document.getElementById('lcTheme').textContent   = levelMessages[completedLevel] || theme.name || '';
    document.getElementById('lcStreak').textContent  = maxStreak;
    document.getElementById('lcScore').textContent   = score;
    document.getElementById('lcLives').textContent   = 'üíñ'.repeat(lives);

    // Match background to current level theme
    const lc = document.getElementById('levelComplete');
    lc.style.background = theme.bg || 'linear-gradient(135deg, #ff758c, #ff7eb3)';
    // Last level button says Finish
    document.querySelector('.lc-next').textContent = completedLevel >= 10 ? 'Finish! üéâ' : 'Next Level ‚Üí';
    lc.style.display = 'flex';
}

function nextLevel() {
    document.getElementById('levelComplete').style.display = 'none';

    // Advance level
    heartsThisLevel = 0;
    level++;
    levelDisplay.textContent = level;
    updateHeartsDisplay();

    // Win ‚Äî completed all 10 levels
    if (level > 10) {
        const imgEl = document.getElementById('gameOverImg');
        imgEl.innerHTML = `<img src="${ME_HAPPY}" style="height:100px;width:auto;border-radius:12px;object-fit:cover;">`;
        document.getElementById('gameOverTitle').textContent = 'üéâ You Won!';
        if (score > highScore) { highScore = score; localStorage.setItem('beatrix_highscore', highScore); }
        document.getElementById('gameOverScore').textContent = `${score} hearts collected üíñ`;
        document.getElementById('gameOverHigh').textContent = `Best: ${highScore} üèÜ`;
        document.getElementById('gameOverStreak').textContent = `Max Streak: ${maxStreak} üî•`;
        document.getElementById('gameOverLevel').textContent = `Completed all 10 levels!`;
        gameStarted = false;
        clearInterval(spawnInterval);
        stopMusic();
        playSound('win');
        showPopup('üéâ YOU WIN! üéâ');
        setTimeout(() => { document.getElementById('gameOver').style.display = 'flex'; }, 1500);
        return;
    }

    updateLevelTheme(); // this calls startMusic() inside

    // Show Ready/Steady/Go then start spawning
    showLevelTransition();
    setTimeout(() => {
        if (gameStarted) restartSpawnInterval();
    }, 2000);
}

/* Basket movement - follows mouse/touch directly, no click required */
let basketX = window.innerWidth / 2;

function getGameWidth() {
    return window.visualViewport ? window.visualViewport.width : window.innerWidth;
}

function updateBasketPosition(clientX) {
    const gameWidth = getGameWidth();
    basketX = Math.max(40, Math.min(gameWidth - 40, clientX));
    basket.style.left = basketX + 'px';
    basket.style.transform = 'translateX(-50%)';
}

document.addEventListener('mousemove', (e) => {
    if (gameStarted) {
        updateBasketPosition(e.clientX);
    }
});

// Click to shoot during boss fight
document.addEventListener('click', (e) => {
    if (gameStarted && bossActive) {
        fireProjectile();
    }
});

// Touch: move basket on drag, shoot on tap (short touch = no significant move)
let touchStartX = 0;
let touchStartY = 0;
let touchMoved = false;

gameArea.addEventListener('touchstart', (e) => {
    if (!gameStarted) return;
    e.preventDefault();
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    touchMoved = false;
    updateBasketPosition(e.touches[0].clientX);
}, { passive: false });

document.addEventListener('touchmove', (e) => {
    if (!gameStarted) return;
    e.preventDefault();
    const dx = Math.abs(e.touches[0].clientX - touchStartX);
    const dy = Math.abs(e.touches[0].clientY - touchStartY);
    if (dx > 8 || dy > 8) touchMoved = true;
    updateBasketPosition(e.touches[0].clientX);
}, { passive: false });

document.addEventListener('touchend', (e) => {
    if (!gameStarted) return;
    // If finger barely moved = tap = shoot
    if (!touchMoved && bossActive) {
        fireProjectile();
    }
}, { passive: true });

/* Preload reaction images */
const imgNormal = new Image(); imgNormal.src = 'me.jpg';
const imgHit    = new Image(); imgHit.src    = 'me2.jpg';
const imgHappy  = new Image(); imgHappy.src  = 'me3.jpg';

let reactionTimeout = null;

/* Basket reactions */
function reactToHeart() {
    basket.style.animation = 'celebrateJump 0.5s ease';
    setTimeout(() => { basket.style.animation = ''; }, 500);

    const basketImg = document.getElementById('basketImg');
    if (reactionTimeout) clearTimeout(reactionTimeout);
    basketImg.src = 'me3.jpg';
    reactionTimeout = setTimeout(() => { basketImg.src = 'me.jpg'; }, 2000);
}

function reactToHit() {
    basket.style.animation = 'hitFlash 0.4s ease';
    setTimeout(() => { basket.style.animation = ''; }, 400);

    const basketImg = document.getElementById('basketImg');
    if (reactionTimeout) clearTimeout(reactionTimeout);
    basketImg.src = 'me2.jpg';
    reactionTimeout = setTimeout(() => { basketImg.src = 'me.jpg'; }, 2000);
}

function screenShake() {
    gameArea.style.animation = 'screenShake 0.4s ease';
    setTimeout(() => { gameArea.style.animation = ''; }, 400);
}

function spawnParticles(x, y) {
    for (let i = 0; i < 8; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        const angle = (i / 8) * Math.PI * 2;
        const distance = 50 + Math.random() * 30;
        particle.style.left = x + 'px';
        particle.style.top = y + 'px';
        particle.style.setProperty('--px', Math.cos(angle) * distance + 'px');
        particle.style.setProperty('--py', Math.sin(angle) * distance + 'px');
        gameArea.appendChild(particle);
        setTimeout(() => particle.remove(), 800);
    }
}

/* Double Points */
function activateDoublePoints() {
    doublePoints = true;
    basket.classList.add('doublePoints');
    document.getElementById('doubleBanner').style.display = 'block';
    
    setTimeout(() => {
        doublePoints = false;
        basket.classList.remove('doublePoints');
        document.getElementById('doubleBanner').style.display = 'none';
    }, 5000);
}

/* Auto-play music on first interaction */
document.body.addEventListener('touchstart', () => {
    if (gameStarted) startMusic();
}, { passive: true, once: true });

/* Create falling items */
function createItem() {
    const cfg = getLevelConfig(level);
    const rand = Math.random();
    const heartThreshold    = 1 - cfg.bombChance - cfg.eggChance - cfg.powerupChance;

    if (rand < heartThreshold) {
        createHeart(cfg);
    } else if (rand < heartThreshold + cfg.powerupChance) {
        createPowerup(cfg);
    } else if (rand < heartThreshold + cfg.powerupChance + cfg.bombChance) {
        createBomb(cfg);
    } else {
        createEasterEgg(cfg);
    }
}

function createHeart(cfg) {
    const heart = document.createElement("div");
    heart.classList.add("heart");
    const hearts = ["‚ù§Ô∏è", "üíï", "üíñ", "üíó", "üíì", "üíù"];
    heart.innerHTML = hearts[Math.floor(Math.random() * hearts.length)];
    heart.style.left = Math.random() * (getGameWidth() - 50) + "px";
    heart.style.animationDuration = (cfg.fallBase + Math.random() * cfg.fallRand) + "s";
    gameArea.appendChild(heart);
    activeItems.push({ el: heart, type: 'heart' });
}

function createPowerup(cfg) {
    const powerup = document.createElement("div");
    powerup.classList.add("powerup");
    const powerups = ["‚≠ê", "üí´", "‚ú®", "üåü"];
    powerup.innerHTML = powerups[Math.floor(Math.random() * powerups.length)];
    powerup.style.left = Math.random() * (getGameWidth() - 50) + "px";
    const fallDur = (cfg.fallBase + Math.random() * cfg.fallRand).toFixed(2);
    powerup.style.animationDuration = fallDur + "s, 0.6s";
    gameArea.appendChild(powerup);
    activeItems.push({ el: powerup, type: 'powerup' });
}

function createBomb(cfg) {
    const bomb = document.createElement("div");
    bomb.classList.add("bomb");
    bomb.innerHTML = "üí£";
    bomb.style.left = Math.random() * (getGameWidth() - 50) + "px";
    // Bombs fall slightly faster than hearts for more danger
    bomb.style.animationDuration = (cfg.fallBase * 0.85 + Math.random() * cfg.fallRand) + "s";
    gameArea.appendChild(bomb);
    activeItems.push({ el: bomb, type: 'bomb' });
}

function createEasterEgg(cfg) {
    const egg = document.createElement("div");
    egg.classList.add("bomb");
    egg.innerHTML = "üçÜ";
    egg.style.left = Math.random() * (getGameWidth() - 50) + "px";
    // Easter eggs fall faster than bombs ‚Äî sneaky
    egg.style.animationDuration = (cfg.fallBase * 0.7 + Math.random() * cfg.fallRand * 0.5) + "s";
    egg.style.fontSize = "35px";
    gameArea.appendChild(egg);
    playSound('spawn');
    activeItems.push({ el: egg, type: 'easteregg' });
}

/* ‚îÄ‚îÄ Shooting System ‚îÄ‚îÄ */
let activeProjectiles = []; // { el, x, y, vy }

function fireProjectile() {
    if (!bossActive || shootCooldown) return;
    shootCooldown = true;
    setTimeout(() => { shootCooldown = false; }, SHOOT_COOLDOWN_MS);

    const proj = document.createElement('div');
    proj.className = 'projectile';
    proj.textContent = 'üíò';

    const gameRect = gameArea.getBoundingClientRect();
    const startX = basketX - gameRect.left;
    const startY = window.innerHeight - gameRect.top - 180;

    proj.style.left = startX + 'px';
    proj.style.top  = startY + 'px';
    proj.style.animationDuration = '0.8s';
    gameArea.appendChild(proj);

    activeProjectiles.push({ el: proj, x: startX, y: startY, vy: 14 });
    playProjectileSound();
}

function playProjectileSound() {
    try {
        const ctx = getAudioCtx(); const t = ctx.currentTime;
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.type = 'sine';
        o.frequency.setValueAtTime(600, t);
        o.frequency.linearRampToValueAtTime(1200, t + 0.12);
        g.gain.setValueAtTime(0.25, t);
        g.gain.exponentialRampToValueAtTime(0.001, t + 0.18);
        o.start(t); o.stop(t + 0.18);
    } catch(e) {}
}

function updateProjectiles() {
    if (!bossActive || activeProjectiles.length === 0) return;

    const spriteEl = document.getElementById('bossSprite');
    const spriteRect = spriteEl.getBoundingClientRect();
    const gameRect = gameArea.getBoundingClientRect();

    for (let i = activeProjectiles.length - 1; i >= 0; i--) {
        const p = activeProjectiles[i];
        p.y -= p.vy;
        p.el.style.top = p.y + 'px';

        // Off-screen ‚Äî remove
        if (p.y < -40) {
            p.el.remove();
            activeProjectiles.splice(i, 1);
            continue;
        }

        // Hit boss ‚Äî check collision with boss sprite rect
        const projLeft   = p.x + gameRect.left;
        const projRight  = projLeft + 24;
        const projTop    = p.y  + gameRect.top;
        const projBottom = projTop + 24;

        if (
            projBottom >= spriteRect.top &&
            projTop    <= spriteRect.bottom &&
            projRight  >= spriteRect.left &&
            projLeft   <= spriteRect.right
        ) {
            // Hit!
            p.el.remove();
            activeProjectiles.splice(i, 1);

            // Spawn impact particles at hit point
            spawnParticles(
                p.x + 12,
                p.y + 12
            );

            hitBoss();
        }
    }
}

/* Unified RAF-based collision loop ‚Äî replaces per-item setInterval */
let activeItems = []; // { el, type }
let collisionLoopRunning = false;

function startCollisionLoop() {
    if (collisionLoopRunning) return;
    collisionLoopRunning = true;
    rafCollisionLoop();
}

function rafCollisionLoop() {
    // Stop only if explicitly reset (e.g. on restart via startGame)
    if (!collisionLoopRunning) return;

    const basketRect = basket.getBoundingClientRect();
    const viewH = window.visualViewport ? window.visualViewport.height : window.innerHeight;

    for (let i = activeItems.length - 1; i >= 0; i--) {
        const { el, type } = activeItems[i];
        const itemRect = el.getBoundingClientRect();

        // Caught
        if (
            itemRect.bottom >= basketRect.top &&
            itemRect.left < basketRect.right &&
            itemRect.right > basketRect.left
        ) {
            handleCatch(type, itemRect);
            el.remove();
            activeItems.splice(i, 1);
            continue;
        }

        // Missed ‚Äî fell off screen
        if (itemRect.top > viewH) {
            el.remove();
            activeItems.splice(i, 1);
            // Boss attacks silently disappear; hearts during boss don't penalise
            if (type === 'heart' && !bossActive) {
                streak = 0;
                combo = 0;
                streakDisplay.textContent = streak;
                comboDisplay.textContent = "";
                if (gameStarted) {
                    showPopup("üíî MISSED!");
                    loseLife();
                }
            }
        }
    }

    // Update projectiles (boss fight shooting)
    updateProjectiles();

    requestAnimationFrame(rafCollisionLoop);
}

function handleCatch(type, itemRect) {
    if (type === 'heart') {
        // During boss fight, hearts damage boss instead of counting toward level
        if (bossActive) {
            hitBoss();
            if (itemRect) {
                const cx = itemRect.left + itemRect.width / 2 - gameArea.getBoundingClientRect().left;
                const cy = itemRect.top + itemRect.height / 2 - gameArea.getBoundingClientRect().top;
                spawnParticles(cx, cy);
            }
            return;
        }

        heartsThisLevel++;
        score++;
        streak++;
        combo++;
        updateHeartsDisplay();

        if (itemRect) {
            const cx = itemRect.left + itemRect.width / 2 - gameArea.getBoundingClientRect().left;
            const cy = itemRect.top + itemRect.height / 2 - gameArea.getBoundingClientRect().top;
            spawnParticles(cx, cy);
        }

        if (doublePoints) {
            heartsThisLevel++;
            score++;
            updateHeartsDisplay();
            showPopup(`üíõ DOUBLE! +2 ‚ù§Ô∏è`);
        }

        if (combo > 2) {
            comboDisplay.textContent = `${combo}x COMBO!`;
            comboDisplay.classList.add('pulse');
            setTimeout(() => comboDisplay.classList.remove('pulse'), 200);
            playSound('combo');
            if (!doublePoints) showPopup(funnyMessages[Math.floor(Math.random() * funnyMessages.length)]);
        } else {
            playSound('catch');
        }

        reactToHeart();
        checkLevelUp();
        if (streak > maxStreak) maxStreak = streak;

    } else if (type === 'powerup') {
        playSound('powerup');
        showPopup("‚≠ê 2x POINTS! ‚≠ê");
        activatePowerup();
        activateDoublePoints();

    } else if (type === 'bomb') {
        if (!invincible) {
            streak = 0; combo = 0;
            streakDisplay.textContent = streak;
            comboDisplay.textContent = "";
            playSound('bomb');
            showPopup("üí• BOMB! -1 Life üíî");
            reactToHit();
            screenShake();
            loseLife();          // üí£ costs a LIFE
        } else {
            showPopup("üõ°Ô∏è PROTECTED!");
        }

    } else if (type === 'easteregg') {
        // üçÜ costs a HEART (from level progress)
        if (heartsThisLevel > 0) {
            heartsThisLevel--;
            score = Math.max(0, score - 1);
            updateHeartsDisplay();
        }
        streak = 0; combo = 0;
        streakDisplay.textContent = streak;
        comboDisplay.textContent = "";
        playSound('easteregg');
        showPopup("üçÜ OUCH! -1 ‚ù§Ô∏è üòÇ");
        reactToHit();
        screenShake();

    } else if (type === 'bossHeal') {
        // During boss fight, catching pink heart heals 1 life (max 3)
        if (lives < 3) {
            lives++;
            updateLivesDisplay();
            playSound('catch');
            // Show heal popup near basket
            const hp = document.createElement('div');
            hp.className = 'heal-popup';
            hp.textContent = '+1 üíñ HEAL!';
            hp.style.left = basketX + 'px';
            hp.style.top = (window.innerHeight - 180) + 'px';
            gameArea.appendChild(hp);
            setTimeout(() => hp.remove(), 1000);
        } else {
            // Already full HP ‚Äî turn into score
            score++;
            playSound('catch');
            showPopup('üíñ FULL HP! +1 ‚≠ê');
        }
        spawnParticles(
            itemRect.left + itemRect.width/2 - gameArea.getBoundingClientRect().left,
            itemRect.top  + itemRect.height/2 - gameArea.getBoundingClientRect().top
        );

    } else if (type === 'bossattack') {
        if (!invincible) {
            playSound('bomb');
            showPopup("üí• BOSS HIT! -1 Life");
            reactToHit();
            screenShake();
            loseLife();
        } else {
            showPopup("üõ°Ô∏è BLOCKED!");
        }
    }

    // Win condition: reach level 11 (complete 10 levels of 10 hearts)
    if (level > 10 && gameStarted) {
        const imgEl = document.getElementById('gameOverImg');
        imgEl.innerHTML = `<img src="${ME_HAPPY}" style="height:100px;width:auto;border-radius:12px;object-fit:cover;">`;
        document.getElementById('gameOverTitle').textContent = 'üéâ You Won!';
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('beatrix_highscore', highScore);
        }
        document.getElementById('gameOverScore').textContent = `${score} hearts collected üíñ`;
        document.getElementById('gameOverHigh').textContent = `Best: ${highScore} üèÜ`;
        document.getElementById('gameOverLevel').textContent = `Completed all 10 levels!`;
        gameStarted = false;
        clearInterval(spawnInterval);
        stopMusic();
        message.style.display = "block";
        playSound('win');
        showPopup("üéâ YOU WIN! üéâ");
        setTimeout(() => {
            document.getElementById('gameOver').style.display = 'flex';
        }, 2000);
    }
}

function activatePowerup() {
    invincible = true;
    basket.classList.add('invincible');
    activateDoublePoints();
    setTimeout(() => {
        invincible = false;
        basket.classList.remove('invincible');
    }, 5000);
}

function showPopup(text) {
    popupText.textContent = text;
    popupText.style.opacity = 1;
    popupText.style.transform = 'translate(-50%, -50%) scale(1)';
    
    setTimeout(() => {
        popupText.style.transition = 'all 0.5s ease-out';
        popupText.style.opacity = 0;
        popupText.style.transform = 'translate(-50%, -80%) scale(0.5)';
    }, 800);
    
    setTimeout(() => {
        popupText.style.transition = '';
    }, 1300);
}

/* Sparkles */
function createSparkle() {
    const sparkle = document.createElement("div");
    sparkle.classList.add("sparkle");
    sparkle.style.left = Math.random() * getGameWidth() + "px";
    sparkle.style.animationDuration = (3 + Math.random() * 3) + "s";
    document.body.appendChild(sparkle);
    setTimeout(() => sparkle.remove(), 6000);
}

/* Floating Love Text */
function createLoveText() {
    const text = document.createElement("div");
    text.classList.add("loveText");
    text.innerHTML = loveMessages[Math.floor(Math.random() * loveMessages.length)];
    text.style.left = Math.random() * (getGameWidth() - 200) + "px";
    document.body.appendChild(text);
    setTimeout(() => text.remove(), 6000);
}

/* Initialize page with default theme + start menu music */
window.addEventListener('DOMContentLoaded', function() {
    document.body.style.background = 'linear-gradient(to bottom, #ff758c, #ff7eb3)';
    startMenuHearts();
});

/* ‚îÄ‚îÄ Floating hearts background for menu ‚îÄ‚îÄ */
let menuHeartsInterval = null;
const MENU_HEARTS = ['üíñ','üíó','üíì','üíï','üíù','‚ú®','üí´','üå∏','üíû','‚ù§Ô∏è'];

function startMenuHearts() {
    stopMenuHearts();
    const container = document.getElementById('menuHearts');
    if (!container) return;
    menuHeartsInterval = setInterval(() => {
        const el = document.createElement('div');
        el.className = 'menu-float-heart';
        el.textContent = MENU_HEARTS[Math.floor(Math.random() * MENU_HEARTS.length)];
        el.style.left   = (Math.random() * 96) + 'vw';
        el.style.bottom = '-60px';
        el.style.fontSize = (14 + Math.random() * 18) + 'px';
        el.style.setProperty('--hx', ((Math.random() - 0.5) * 80) + 'px');
        el.style.setProperty('--hr', ((Math.random() - 0.5) * 40) + 'deg');
        const dur = (7 + Math.random() * 8).toFixed(1);
        el.style.animationDuration = dur + 's';
        el.style.animationDelay = (Math.random() * 1.5) + 's';
        container.appendChild(el);
        setTimeout(() => el.remove(), (parseFloat(dur) + 2) * 1000);
    }, 380);
}

function stopMenuHearts() {
    if (menuHeartsInterval) { clearInterval(menuHeartsInterval); menuHeartsInterval = null; }
    const container = document.getElementById('menuHearts');
    if (container) container.innerHTML = '';
}

/* Start menu music on first user interaction (browser autoplay policy) */
function tryStartMenuMusic() {
    if (!gameStarted && soundEnabled) startMenuMusic();
    startMenuHearts();
    document.body.removeEventListener('click',     tryStartMenuMusic);
    document.body.removeEventListener('touchstart', tryStartMenuMusic);
    document.body.removeEventListener('keydown',    tryStartMenuMusic);
}
document.body.addEventListener('click',      tryStartMenuMusic, { once: true });
document.body.addEventListener('touchstart', tryStartMenuMusic, { once: true, passive: true });
document.body.addEventListener('keydown',    tryStartMenuMusic, { once: true });

</script>

</body>
</html>
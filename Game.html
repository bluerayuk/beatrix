<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#ff758c">
<title>Catch the Love - For Beatrix ‚ù§Ô∏è</title>

<script>
// Set background IMMEDIATELY on page load
document.addEventListener('DOMContentLoaded', function() {
    document.body.style.backgroundColor = '#ff758c';
    document.body.style.backgroundImage = 'linear-gradient(to bottom, #ff758c, #ff7eb3)';
    console.log('IMMEDIATE: Background set on page load');
});
</script>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

html {
    background: #ff758c;
    height: 100%;
}

body {
    margin: 0;
    overflow: hidden;
    background: linear-gradient(to bottom, #ff758c, #ff7eb3);
    font-family: -apple-system, BlinkMacSystemFont, 'Arial', sans-serif;
    text-align: center;
    touch-action: none;
    position: fixed;
    width: 100%;
    height: 100vh;
    height: 100dvh;
    overscroll-behavior: none;
    transition: background 1s ease;
}


/* Animated background particles */
.bg-particle {
    position: fixed;
    top: -60px;
    pointer-events: none;
    z-index: 1;
}

.bg-particle.falling {
    animation: bgFall linear forwards;
}

@keyframes bgFall {
    0%   { transform: translateY(0) rotate(0deg);   opacity: 1; }
    90%  { opacity: 1; }
    100% { transform: translateY(110vh) rotate(400deg); opacity: 0; }
}

@keyframes bgDrift {
    0%   { transform: translateY(0) translateX(0) rotate(0deg);   opacity: 1; }
    100% { transform: translateY(110vh) translateX(40px) rotate(360deg); opacity: 0; }
}

@keyframes bgFloat {
    0%,100% { transform: translateY(0) scale(1);   opacity: 0.7; }
    50%      { transform: translateY(-12px) scale(1.15); opacity: 1; }
}

@keyframes bgCloudFloat {
    0%   { transform: translateX(-220px); }
    100% { transform: translateX(calc(100vw + 220px)); }
}

@keyframes bgBubble {
    0%   { transform: translateY(100vh) scale(0.5); opacity: 0; }
    20%  { opacity: 0.8; }
    100% { transform: translateY(-80px)  scale(1.2); opacity: 0; }
}

@keyframes bgPulse {
    0%,100% { transform: scale(1);   opacity: 0.6; }
    50%      { transform: scale(1.3); opacity: 1;   }
}

/* Header */
.header {
    position: relative;
    z-index: 100;
    padding: 10px 15px;
    padding-top: max(10px, env(safe-area-inset-top, 10px));
    background: rgba(0,0,0,0.2);
}

h1 {
    color: white;
    font-size: 22px;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.4);
    margin-bottom: 5px;
}

#scoreBoard {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
}

.stat {
    color: white;
    font-size: 16px;
    font-weight: bold;
    text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
}

#combo {
    color: #FFD700;
    font-size: 20px;
    transform: scale(1);
    transition: transform 0.2s;
}

#combo.pulse {
    transform: scale(1.3);
}

/* Sparkles - color changes per level */
.sparkle {
    position: absolute;
    width: 6px;
    height: 6px;
    background: white;
    border-radius: 50%;
    opacity: 0.8;
    animation: sparkleFloat 4s linear infinite;
    pointer-events: none;
}

@keyframes sparkleFloat {
    from { transform: translateY(100vh) scale(0.5); opacity: 0; }
    50% { opacity: 1; }
    to { transform: translateY(-10vh) scale(1.2); opacity: 0; }
}

#gameArea {
    position: relative;
    width: 100vw;
    height: calc(100vh - 100px);
    height: calc(100dvh - 100px);
    overflow: hidden;
}

/* Hearts and Items */
.heart, .powerup, .bomb {
    position: absolute;
    font-size: 28px;
    animation: fall linear;
    cursor: pointer;
    user-select: none;
}

.powerup {
    font-size: 32px;
    animation: fall linear, starPulse 0.6s ease-in-out infinite alternate;
}

@keyframes starPulse {
    from { filter: brightness(1) drop-shadow(0 0 4px rgba(255,220,0,0.6)); }
    to   { filter: brightness(1.5) drop-shadow(0 0 12px rgba(255,220,0,1)); }
}

.bomb {
    font-size: 30px;
    animation: fallWobble linear;
}

@keyframes fall {
    from { transform: translateY(-50px); }
    to { transform: translateY(calc(100vh + 50px)); }
}


@keyframes fallWobble {
    from { transform: translateY(-50px) rotate(-5deg); }
    25% { transform: translateY(calc(25vh)) rotate(5deg); }
    50% { transform: translateY(calc(50vh)) rotate(-5deg); }
    75% { transform: translateY(calc(75vh)) rotate(5deg); }
    to { transform: translateY(calc(100vh + 50px)) rotate(-5deg); }
}

#basket {
    position: absolute;
    bottom: max(20px, env(safe-area-inset-bottom, 20px) + 10px);
    left: 50%;
    transform: translateX(-50%);
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    z-index: 10;
    touch-action: none;
    will-change: transform;
    -webkit-transform: translateX(-50%);
}

#basket.invincible img {
    animation: shieldGlow 0.4s ease-in-out infinite alternate;
    border-color: gold !important;
}

@keyframes shieldGlow {
    from { box-shadow: 0 0 8px 2px rgba(255, 215, 0, 0.6); }
    to   { box-shadow: 0 0 20px 6px rgba(255, 215, 0, 1); }
}

@keyframes hitFlash {
    0%   { opacity: 1; }
    20%  { opacity: 0.1; }
    40%  { opacity: 1; }
    60%  { opacity: 0.1; }
    80%  { opacity: 1; }
    100% { opacity: 1; }
}

@keyframes celebrateJump {
    0%   { transform: translateY(0) scale(1); }
    30%  { transform: translateY(-18px) scale(1.08); }
    55%  { transform: translateY(-8px) scale(1.04); }
    75%  { transform: translateY(-14px) scale(1.06); }
    100% { transform: translateY(0) scale(1); }
}

@keyframes screenShake {
    0%,100% { transform: translate(0,0); }
    15%     { transform: translate(-8px, 4px); }
    30%     { transform: translate(8px, -4px); }
    45%     { transform: translate(-6px, -6px); }
    60%     { transform: translate(6px, 4px); }
    75%     { transform: translate(-4px, 2px); }
}

@keyframes particleBurst {
    0%   { transform: translate(0,0) scale(1); opacity: 1; }
    100% { transform: translate(var(--px), var(--py)) scale(0); opacity: 0; }
}

/* Golden double-points glow around basket */
#basket.doublePoints img {
    animation: goldPulse 0.5s ease-in-out infinite alternate;
    outline: 3px solid gold;
    outline-offset: 3px;
    border-radius: 4px;
}
@keyframes goldPulse {
    from { filter: drop-shadow(0 0 6px rgba(255,215,0,0.8)); }
    to   { filter: drop-shadow(0 0 18px rgba(255,215,0,1)) brightness(1.1); }
}

/* Double points banner */
#doublePointsBanner, #doubleBanner {
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #000;
    font-weight: bold;
    font-size: 14px;
    padding: 4px 14px;
    border-radius: 20px;
    box-shadow: 0 0 12px rgba(255,215,0,0.8);
    display: none;
    z-index: 50;
    white-space: nowrap;
}




/* Love message overlay */
#loveOverlay {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, rgba(180,0,60,0.95), rgba(255,100,150,0.95));
    z-index: 1500;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 40px 30px;
    backdrop-filter: blur(4px);
    animation: fadeIn 0.4s ease;
}
#loveOverlay .love-emoji { font-size: 64px; margin-bottom: 16px; }
#loveOverlay .love-msg   { font-size: clamp(1.3rem,5vw,2rem); color: white; font-weight: 600; line-height: 1.5; text-shadow: 0 2px 8px rgba(0,0,0,0.4); }
#loveOverlay .level-tag  { margin-top: 20px; font-size: 1.1rem; color: rgba(255,255,255,0.8); }

/* Messages */
#message {
    position: absolute;
    top: 35%;
    width: 100%;
    font-size: 28px;
    color: white;
    display: none;
    padding: 0 20px;
    animation: fadeIn 2s ease-in-out;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
}

#popupText {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    font-weight: bold;
    color: #FFD700;
    text-shadow: 3px 3px 10px rgba(0,0,0,0.8);
    opacity: 0;
    pointer-events: none;
    z-index: 150;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Floating love text */
.loveText {
    position: absolute;
    color: white;
    font-weight: bold;
    font-size: 18px;
    text-shadow: 2px 2px 6px rgba(0,0,0,0.5);
    animation: floatUp 6s ease-in forwards;
    pointer-events: none;
    z-index: 5;
}

@keyframes floatUp {
    from { transform: translateY(100vh); opacity: 0; }
    20% { opacity: 1; }
    80% { opacity: 1; }
    to { transform: translateY(-20vh); opacity: 0; }
}

/* Particle burst */
.particle {
    position: absolute;
    width: 8px;
    height: 8px;
    background: radial-gradient(circle, #FFD700, #FF69B4);
    border-radius: 50%;
    pointer-events: none;
    animation: particleBurst 0.8s ease-out forwards;
}

/* Menu overlay */
#menuOverlay, #gameOver, #howToPlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 30px;
    backdrop-filter: blur(6px);
}

#menuOverlay h1 {
    font-size: clamp(2rem, 8vw, 3.5rem);
    margin-bottom: 20px;
    background: linear-gradient(135deg, #ff758c, #FFD700);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.menu-buttons {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 20px;
}

.menu-button, .restart-btn {
    background: linear-gradient(135deg, #ff758c, #ff7eb3);
    color: white;
    border: none;
    padding: 15px 40px;
    font-size: 18px;
    font-weight: bold;
    border-radius: 50px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
}

.menu-button:active, .restart-btn:active {
    transform: scale(0.95);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.difficulty-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
}

.difficulty-btn {
    background: rgba(255,255,255,0.2);
    color: white;
    border: 2px solid white;
    padding: 10px 25px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.difficulty-btn.selected {
    background: white;
    color: #ff758c;
}

/* How to Play */
#howToPlay {
    display: none;
    overflow-y: auto;
}

.how-to-content {
    max-width: 500px;
    background: rgba(255,255,255,0.1);
    padding: 30px;
    border-radius: 20px;
    backdrop-filter: blur(10px);
}

.how-to-content h2 {
    color: white;
    margin-bottom: 20px;
    font-size: 28px;
}

.how-to-content p, .how-to-content ul {
    color: white;
    text-align: left;
    line-height: 1.8;
    margin-bottom: 15px;
}

.how-to-content ul {
    list-style-position: inside;
}

/* Game Over Screen */
#gameOver {
    display: none;
}

.game-over-content {
    background: rgba(255,255,255,0.1);
    padding: 40px 30px;
    border-radius: 20px;
    backdrop-filter: blur(10px);
    max-width: 400px;
}

#gameOverTitle {
    font-size: 36px;
    color: white;
    margin-bottom: 20px;
}

#gameOverImg {
    font-size: 80px;
    margin-bottom: 20px;
}

#gameOverScore, #gameOverHigh, #gameOverStreak, #gameOverLevel {
    color: white;
    font-size: 18px;
    margin: 10px 0;
}

/* Sound toggle */
#soundToggle {
    position: fixed;
    top: max(10px, env(safe-area-inset-top, 10px));
    right: 15px;
    z-index: 200;
    background: rgba(0,0,0,0.3);
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 50px;
    font-size: 20px;
    cursor: pointer;
    transition: background 0.3s;
}

#soundToggle:active {
    background: rgba(0,0,0,0.5);
}

/* Lives display */
#lives {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 24px;
    z-index: 50;
}

/* Level transition overlay */
#levelTransition {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    z-index: 2000;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 40px;
    animation: fadeIn 0.5s ease;
}

#levelTransition .level-number {
    font-size: clamp(3rem, 10vw, 6rem);
    color: white;
    font-weight: bold;
    margin-bottom: 20px;
    text-shadow: 0 0 20px rgba(255,255,255,0.5);
}

#levelTransition .level-theme {
    font-size: clamp(1.5rem, 6vw, 2.5rem);
    color: #FFD700;
    margin-bottom: 10px;
}

#levelTransition .level-description {
    font-size: 18px;
    color: rgba(255,255,255,0.8);
    max-width: 400px;
}
</style>
</head>
<body>

<!-- Sound Toggle -->
<button id="soundToggle" onclick="toggleSound()">üîä</button>

<!-- Lives Display -->
<div id="lives"></div>

<!-- Double Points Banner -->
<div id="doubleBanner">‚≠ê DOUBLE POINTS ‚≠ê</div>

<!-- Menu Overlay -->
<div id="menuOverlay">
    <h1>Catch the Love üíï</h1>
    <div style="font-size: 60px; margin: 20px 0;">‚ù§Ô∏è</div>
    <p style="color: white; font-size: 18px; margin-bottom: 10px;">A Game Made with Love for Beatrix</p>
    
    <div class="menu-buttons">
        <button class="menu-button" onclick="showDifficultySelect()">‚ñ∂Ô∏è Start Game</button>
        <button class="menu-button" onclick="showHowToPlay()">‚ùì How to Play</button>
    </div>
    
    <div id="difficultySelect" style="display: none; margin-top: 30px;">
        <p style="color: white; font-size: 20px; margin-bottom: 15px;">Select Difficulty</p>
        <div class="difficulty-buttons">
            <button class="difficulty-btn" onclick="selectDifficulty('easy')">Easy</button>
            <button class="difficulty-btn selected" onclick="selectDifficulty('medium')">Medium</button>
            <button class="difficulty-btn" onclick="selectDifficulty('hard')">Hard</button>
        </div>
        
        <button class="menu-button" onclick="startGame()" style="margin-top: 20px;">Start! üöÄ</button>
    </div>
    
    <p style="color: rgba(255,255,255,0.6); margin-top: 30px; font-size: 14px;">
        High Score: <span id="menuHighScore">0</span> ‚ù§Ô∏è
    </p>
</div>

<!-- How to Play -->
<div id="howToPlay">
    <div class="how-to-content">
        <h2>How to Play üéÆ</h2>
        <p><strong>Goal:</strong> Catch falling hearts to collect 10 hearts per level and complete all 5 levels!</p>
        
        <ul>
            <li>‚ù§Ô∏è <strong>Hearts:</strong> Catch them! Each heart = 1 point</li>
            <li>‚≠ê <strong>Power-ups:</strong> Get invincibility shield + double points for 5 seconds</li>
            <li>üí£ <strong>Bombs:</strong> Avoid! Loses 1 life</li>
            <li>üçÜ <strong>Easter Egg:</strong> Loses 1 heart from your level progress</li>
        </ul>
        
        <p><strong>Controls:</strong> Drag or touch to move the basket</p>
        
        <p><strong>Lives:</strong> You have 3 lives. Missing a heart or catching a bomb costs a life!</p>
        
        <button class="menu-button" onclick="closeHowToPlay()">Got it! üëç</button>
    </div>
</div>

<!-- Level Transition -->
<div id="levelTransition">
    <div class="level-number"></div>
    <div class="level-theme"></div>
    <div class="level-description"></div>
</div>

<!-- Game Over Screen -->
<div id="gameOver">
    <div class="game-over-content">
        <h2 id="gameOverTitle">Game Over üíî</h2>
        <div id="gameOverImg">üò¢</div>
        <p id="gameOverScore">Score: 0</p>
        <p id="gameOverHigh">High Score: 0</p>
        <p id="gameOverStreak">Max Streak: 0</p>
        <p id="gameOverLevel">Level: 1</p>
        <button class="restart-btn" onclick="restartGame()">Play Again üîÑ</button>
        <button class="restart-btn" onclick="backToMenu()" style="background: linear-gradient(135deg, #667eea, #764ba2); margin-top: 10px;">Main Menu üè†</button>
    </div>
</div>

<!-- Header -->
<div class="header">
    <h1>Catch the Love ‚ù§Ô∏è</h1>
    <div id="scoreBoard">
        <div class="stat">‚ù§Ô∏è <span id="heartsDisplay">0/10</span></div>
        <div class="stat">Level <span id="level">1</span></div>
        <div class="stat">Streak: <span id="streak">0</span></div>
        <div class="stat" id="combo"></div>
    </div>
</div>

<!-- Game Area -->
<div id="gameArea">
    <div id="message"></div>
    <div id="popupText"></div>
    <div id="basket"><img id="basketImg" src="me.jpg" style="height:90px;width:auto;display:block;filter:drop-shadow(0 4px 10px rgba(0,0,0,0.5));"></div>
</div>

<!-- Love Overlay -->
<div id="loveOverlay">
    <div class="love-emoji">üíï</div>
    <div class="love-msg">I love you, Beatrix!</div>
    <div class="level-tag">Keep going, my love! ‚ù§Ô∏è</div>
</div>

<script>
/* Base64 Images */
const ME_SAD = "me2.jpg";
const ME_HAPPY = "me3.jpg";

/* Level Themes */
/* Game Variables */
const basket = document.getElementById("basket");
const gameArea = document.getElementById("gameArea");
const scoreDisplay = document.getElementById("heartsDisplay");
const levelDisplay = document.getElementById("level");
const streakDisplay = document.getElementById("streak");
const comboDisplay = document.getElementById("combo");
const message = document.getElementById("message");
const popupText = document.getElementById("popupText");
const livesDisplay = document.getElementById("lives");

let score = 0;
let heartsThisLevel = 0;
let level = 1;
let streak = 0;
let maxStreak = 0;
let combo = 0;
let lives = 3;
let gameStarted = false;
let spawnInterval;
let difficulty = 'medium';
let invincible = false;
let doublePoints = false;
let soundEnabled = true;
let highScore = localStorage.getItem('beatrix_highscore') || 0;
let themeAnimationInterval;
document.getElementById('menuHighScore').textContent = highScore;

/* Love messages */
const loveMessages = [
    "You're my sunshine! ‚òÄÔ∏è",
    "Forever yours üíï",
    "My heart beats for you üíì",
    "You make me smile üòä",
    "Best thing ever! ‚ú®",
    "Love you infinity! ‚àû"
];

const funnyMessages = [
    "üî• ON FIRE!",
    "üí´ AMAZING!",
    "‚ö° UNSTOPPABLE!",
    "üåü PERFECT!",
    "üíù INCREDIBLE!",
    "üéØ LEGEND!"
];

/* ‚îÄ‚îÄ Web Audio Sound Engine ‚îÄ‚îÄ */
let audioCtx = null;
function getAudioCtx() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    return audioCtx;
}

function playSound(type) {
    if (!soundEnabled) return;
    try {
        const ctx = getAudioCtx();
        const t = ctx.currentTime;
        switch(type) {

            case 'catch': {
                // Sweet little "ding" ‚Äî rising tone
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.type = 'sine';
                o.frequency.setValueAtTime(520, t);
                o.frequency.linearRampToValueAtTime(880, t + 0.12);
                g.gain.setValueAtTime(0.35, t);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
                o.start(t); o.stop(t + 0.3);
                break;
            }

            case 'combo': {
                // Fast upward arpeggio
                [523, 659, 784, 1047].forEach((freq, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'triangle';
                    const st = t + i * 0.07;
                    o.frequency.setValueAtTime(freq, st);
                    g.gain.setValueAtTime(0.3, st);
                    g.gain.exponentialRampToValueAtTime(0.001, st + 0.18);
                    o.start(st); o.stop(st + 0.18);
                });
                break;
            }

            case 'bomb': {
                // Deep thud + noise burst
                const buf = ctx.createBuffer(1, ctx.sampleRate * 0.5, ctx.sampleRate);
                const data = buf.getChannelData(0);
                for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / data.length, 3);
                const src = ctx.createBufferSource();
                src.buffer = buf;
                const g = ctx.createGain();
                const f = ctx.createBiquadFilter();
                f.type = 'lowpass'; f.frequency.value = 180;
                src.connect(f); f.connect(g); g.connect(ctx.destination);
                g.gain.setValueAtTime(1.2, t);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                src.start(t);

                // Sub thud
                const o = ctx.createOscillator();
                const g2 = ctx.createGain();
                o.connect(g2); g2.connect(ctx.destination);
                o.type = 'sine';
                o.frequency.setValueAtTime(120, t);
                o.frequency.exponentialRampToValueAtTime(30, t + 0.4);
                g2.gain.setValueAtTime(0.8, t);
                g2.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
                o.start(t); o.stop(t + 0.4);
                break;
            }

            case 'easteregg': {
                // Silly descending "womp womp"
                [400, 300, 220].forEach((freq, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'sawtooth';
                    const st = t + i * 0.15;
                    o.frequency.setValueAtTime(freq, st);
                    o.frequency.exponentialRampToValueAtTime(freq * 0.7, st + 0.14);
                    g.gain.setValueAtTime(0.25, st);
                    g.gain.exponentialRampToValueAtTime(0.001, st + 0.15);
                    o.start(st); o.stop(st + 0.15);
                });
                break;
            }

            case 'powerup': {
                // Sparkling rising sweep
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.type = 'sine';
                o.frequency.setValueAtTime(330, t);
                o.frequency.exponentialRampToValueAtTime(1320, t + 0.4);
                g.gain.setValueAtTime(0.0, t);
                g.gain.linearRampToValueAtTime(0.4, t + 0.05);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                o.start(t); o.stop(t + 0.5);
                // Shimmer layer
                const o2 = ctx.createOscillator();
                const g2 = ctx.createGain();
                o2.connect(g2); g2.connect(ctx.destination);
                o2.type = 'triangle';
                o2.frequency.setValueAtTime(660, t);
                o2.frequency.exponentialRampToValueAtTime(2640, t + 0.4);
                g2.gain.setValueAtTime(0.2, t);
                g2.gain.exponentialRampToValueAtTime(0.001, t + 0.45);
                o2.start(t); o2.stop(t + 0.45);
                break;
            }

            case 'levelup': {
                // Triumphant fanfare ‚Äî C E G C
                [262, 330, 392, 523].forEach((freq, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'square';
                    const st = t + i * 0.13;
                    o.frequency.setValueAtTime(freq, st);
                    g.gain.setValueAtTime(0.18, st);
                    g.gain.exponentialRampToValueAtTime(0.001, st + 0.25);
                    o.start(st); o.stop(st + 0.25);
                });
                // Final chord shimmer
                [523, 659, 784].forEach((freq) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'sine';
                    o.frequency.value = freq;
                    g.gain.setValueAtTime(0.12, t + 0.55);
                    g.gain.exponentialRampToValueAtTime(0.001, t + 1.1);
                    o.start(t + 0.55); o.stop(t + 1.1);
                });
                break;
            }

            case 'gameover': {
                // Sad descending trombone
                [440, 370, 311, 261].forEach((freq, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'sawtooth';
                    const st = t + i * 0.2;
                    o.frequency.setValueAtTime(freq, st);
                    o.frequency.linearRampToValueAtTime(freq * 0.88, st + 0.18);
                    g.gain.setValueAtTime(0.22, st);
                    g.gain.exponentialRampToValueAtTime(0.001, st + 0.22);
                    o.start(st); o.stop(st + 0.22);
                });
                break;
            }

            case 'win': {
                // Big celebratory jingle
                const melody = [523,659,784,1047,784,1047,1319];
                melody.forEach((freq, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = i % 2 === 0 ? 'sine' : 'triangle';
                    const st = t + i * 0.1;
                    o.frequency.setValueAtTime(freq, st);
                    g.gain.setValueAtTime(0.25, st);
                    g.gain.exponentialRampToValueAtTime(0.001, st + 0.2);
                    o.start(st); o.stop(st + 0.2);
                });
                break;
            }

            case 'spawn': {
                // Tiny soft pop
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.type = 'sine';
                o.frequency.setValueAtTime(900, t);
                o.frequency.exponentialRampToValueAtTime(400, t + 0.08);
                g.gain.setValueAtTime(0.15, t);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                o.start(t); o.stop(t + 0.1);
                break;
            }
        }
    } catch(e) {}
}

/* Background music ‚Äî simple looping chime pattern */
let musicInterval = null;
const musicNotes = [523, 659, 784, 659, 523, 392, 440, 523];
let musicStep = 0;

function startMusic() {
    if (musicInterval) return;
    musicInterval = setInterval(() => {
        if (!soundEnabled) return;
        try {
            const ctx = getAudioCtx();
            const t = ctx.currentTime;
            const freq = musicNotes[musicStep % musicNotes.length];
            musicStep++;
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            o.type = 'sine';
            o.frequency.value = freq;
            g.gain.setValueAtTime(0.0, t);
            g.gain.linearRampToValueAtTime(0.08, t + 0.05);
            g.gain.exponentialRampToValueAtTime(0.001, t + 0.55);
            o.start(t); o.stop(t + 0.55);
        } catch(e) {}
    }, 400);
}

function stopMusic() {
    if (musicInterval) { clearInterval(musicInterval); musicInterval = null; }
}

function toggleSound() {
    soundEnabled = !soundEnabled;
    document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîá';
    if (!soundEnabled) stopMusic();
    else startMusic();
}

/* Menu Functions */
function showDifficultySelect() {
    document.getElementById('difficultySelect').style.display = 'block';
}

function selectDifficulty(diff) {
    difficulty = diff;
    document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('selected'));
    event.target.classList.add('selected');
}


/* ‚îÄ‚îÄ Per-level themes ‚îÄ‚îÄ */
const levelThemeData = {
    1: {
        name: "Sweet Beginnings",
        description: "Pink skies of love",
        bg: 'linear-gradient(180deg, #ff758c 0%, #ff9ab0 60%, #ffb3c6 100%)',
        particles: () => spawnLoop(['üíï','‚ù§Ô∏è','üå∏'], 900, 18, 'fall')
    },
    2: {
        name: "Ocean Dreams",
        description: "Aqua waves of affection",
        bg: 'linear-gradient(180deg, #0099cc 0%, #00ccdd 50%, #a8edea 100%)',
        particles: () => spawnBubbles()
    },
    3: {
        name: "Sunset Romance",
        description: "Warm golden glow",
        bg: 'linear-gradient(180deg, #ff6b35 0%, #f7931e 40%, #ffd89b 100%)',
        particles: () => spawnLoop(['üçÇ','üçÅ','‚ú®','üåü'], 700, 22, 'fall')
    },
    4: {
        name: "Starlight Magic",
        description: "Purple cosmic love",
        bg: 'linear-gradient(180deg, #0a0a2e 0%, #1a0b4e 50%, #2d1b6e 100%)',
        particles: () => spawnStars()
    },
    5: {
        name: "Golden Finale",
        description: "The final adventure",
        bg: 'linear-gradient(180deg, #1a1a2e 0%, #16213e 40%, #0f3460 100%)',
        particles: () => { spawnStars(); spawnLoop(['‚≠ê','üí´','‚ú®','üåü','üíõ'], 500, 20, 'fall'); }
    }
};

function applyTheme() {
    // Clear old particles
    clearParticles();

    const theme = levelThemeData[level] || levelThemeData[1];
    document.body.style.background = theme.bg;

    // Start this level's particles
    theme.particles();
}

function clearParticles() {
    if (themeAnimationInterval) {
        clearInterval(themeAnimationInterval);
        themeAnimationInterval = null;
    }
    document.querySelectorAll('.bg-particle').forEach(el => el.remove());
}

function spawnParticleEl(content, isStar) {
    const el = document.createElement('div');
    el.className = 'bg-particle';
    el.style.left = (Math.random() * 100) + 'vw';
    el.style.top = '-60px';
    el.style.fontSize = (Math.random() * 14 + 14) + 'px';
    el.style.zIndex = '1';

    if (isStar) {
        el.style.width  = (Math.random() * 4 + 2) + 'px';
        el.style.height = el.style.width;
        el.style.background = 'white';
        el.style.borderRadius = '50%';
        el.style.boxShadow = '0 0 6px 2px rgba(255,255,255,0.9)';
        el.style.top  = (Math.random() * 100) + 'vh';
        el.style.left = (Math.random() * 100) + 'vw';
        el.style.animation = `bgPulse ${(Math.random() * 2 + 1.5).toFixed(2)}s ease-in-out infinite`;
        el.style.animationDelay = (Math.random() * 3) + 's';
        el.style.position = 'fixed';
        document.body.appendChild(el);
        return el;
    }

    el.textContent = content;
    el.style.animation = `bgFall ${(Math.random() * 4 + 4).toFixed(2)}s linear forwards`;
    el.style.animationDelay = (Math.random() * 0.5) + 's';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 9000);
    return el;
}

function spawnLoop(emojis, interval, fontSize, mode) {
    themeAnimationInterval = setInterval(() => {
        const el = document.createElement('div');
        el.className = 'bg-particle';
        el.style.position = 'fixed';
        el.style.left = (Math.random() * 98) + 'vw';
        el.style.top = '-50px';
        el.style.fontSize = (Math.random() * 8 + fontSize - 4) + 'px';
        el.style.zIndex = '1';
        el.style.pointerEvents = 'none';
        el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        const dur = (Math.random() * 4 + 5).toFixed(2);
        el.style.animation = `bgFall ${dur}s linear forwards`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), (parseFloat(dur) + 0.5) * 1000);
    }, interval);
}

function spawnStars() {
    // Static twinkling stars scattered across screen
    for (let i = 0; i < 35; i++) {
        spawnParticleEl('', true);
    }
    // Occasional shooting stars
    themeAnimationInterval = setInterval(() => {
        const el = document.createElement('div');
        el.className = 'bg-particle';
        el.style.position = 'fixed';
        el.style.left = (Math.random() * 80) + 'vw';
        el.style.top = '-10px';
        el.style.fontSize = (Math.random() * 6 + 10) + 'px';
        el.style.zIndex = '1';
        el.style.pointerEvents = 'none';
        el.textContent = '‚≠ê';
        const dur = (Math.random() * 2 + 2).toFixed(2);
        el.style.animation = `bgFall ${dur}s linear forwards`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), (parseFloat(dur) + 0.3) * 1000);
    }, 1200);
}

function spawnBubbles() {
    // Bubbles rise from bottom
    themeAnimationInterval = setInterval(() => {
        const el = document.createElement('div');
        el.className = 'bg-particle';
        el.style.position = 'fixed';
        el.style.left = (Math.random() * 95) + 'vw';
        el.style.bottom = '-40px';
        el.style.top = 'auto';
        el.style.zIndex = '1';
        el.style.pointerEvents = 'none';
        const size = Math.random() * 22 + 10;
        el.style.width  = size + 'px';
        el.style.height = size + 'px';
        el.style.borderRadius = '50%';
        el.style.border = '2px solid rgba(255,255,255,0.6)';
        el.style.background = 'rgba(255,255,255,0.15)';
        const dur = (Math.random() * 4 + 4).toFixed(2);
        el.style.animation = `bgBubble ${dur}s ease-in forwards`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), (parseFloat(dur) + 0.3) * 1000);
    }, 400);
}

function showHowToPlay() {
    document.getElementById('menuOverlay').style.display = 'none';
    document.getElementById('howToPlay').style.display = 'flex';
}

function closeHowToPlay() {
    document.getElementById('howToPlay').style.display = 'none';
    document.getElementById('menuOverlay').style.display = 'flex';
}

function backToMenu() {
    location.reload();
}

/* Game Functions */
function startGame() {
    document.getElementById('menuOverlay').style.display = 'none';
    gameStarted = true;
    lives = 3;
    score = 0;
    heartsThisLevel = 0;
    level = 1;
    streak = 0;
    combo = 0;
    updateLivesDisplay();
    updateHeartsDisplay();
    applyTheme();
    showLevelTransition();
    
    let spawnRate = 1200;
    if (difficulty === 'easy') spawnRate = 1500;
    if (difficulty === 'hard') spawnRate = 900;
    
    spawnInterval = setInterval(createItem, spawnRate);
    setInterval(createSparkle, 300);
    setInterval(createLoveText, 4000);
    
    startCollisionLoop();
    
    if (soundEnabled) startMusic();
}

function updateLevelTheme() {
    applyTheme();
}

function showLevelTransition() {
    const theme = levelThemeData[level];
    if (!theme) return;
    
    const transition = document.getElementById('levelTransition');
    transition.querySelector('.level-number').textContent = `Level ${level}`;
    transition.querySelector('.level-theme').textContent = theme.name;
    transition.querySelector('.level-description').textContent = theme.description;
    
    transition.style.display = 'flex';
    
    setTimeout(() => {
        transition.style.display = 'none';
    }, 2500);
}

function restartGame() {
    document.getElementById('gameOver').style.display = 'none';
    startGame();
}

function updateHeartsDisplay() {
    scoreDisplay.textContent = `${heartsThisLevel}/10`;
    levelDisplay.textContent = level;
    streakDisplay.textContent = streak;
}

function updateLivesDisplay() {
    livesDisplay.textContent = 'üíñ'.repeat(lives);
}

function loseLife() {
    lives--;
    updateLivesDisplay();
    
    if (lives <= 0) {
        gameOver();
    }
}

function gameOver() {
    const imgEl = document.getElementById('gameOverImg');
    imgEl.innerHTML = `<img src="${ME_SAD}" style="height:100px;width:auto;border-radius:12px;object-fit:cover;">`;
    document.getElementById('gameOverTitle').textContent = 'üíî Game Over';
    
    if (score > highScore) {
        highScore = score;
        localStorage.setItem('beatrix_highscore', highScore);
    }
    
    document.getElementById('gameOverScore').textContent = `${score} hearts collected üíñ`;
    document.getElementById('gameOverHigh').textContent = `Best: ${highScore} üèÜ`;
    document.getElementById('gameOverStreak').textContent = `Max Streak: ${maxStreak} üî•`;
    document.getElementById('gameOverLevel').textContent = `Reached Level ${level}`;
    
    gameStarted = false;
    clearInterval(spawnInterval);
    stopMusic();
    playSound('gameover');
    
    setTimeout(() => {
        document.getElementById('gameOver').style.display = 'flex';
    }, 1000);
}

function checkLevelUp() {
    if (heartsThisLevel >= 10) {
        heartsThisLevel = 0;
        level++;
        levelDisplay.textContent = level;
        updateHeartsDisplay();
        updateLevelTheme();
        showLevelTransition();
        playSound('levelup');
        showLoveMessage();
    }
}

function showLoveMessage() {
    const overlay = document.getElementById('loveOverlay');
    overlay.style.display = 'flex';
    setTimeout(() => {
        overlay.style.display = 'none';
    }, 2500);
}

/* Basket movement - follows mouse/touch directly, no click required */
let basketX = window.innerWidth / 2;

function getGameWidth() {
    return window.visualViewport ? window.visualViewport.width : window.innerWidth;
}

function updateBasketPosition(clientX) {
    const gameWidth = getGameWidth();
    basketX = Math.max(40, Math.min(gameWidth - 40, clientX));
    basket.style.left = basketX + 'px';
    basket.style.transform = 'translateX(-50%)';
}

document.addEventListener('mousemove', (e) => {
    if (gameStarted) {
        updateBasketPosition(e.clientX);
    }
});

gameArea.addEventListener('touchstart', (e) => {
    if (!gameStarted) return;
    e.preventDefault();
    updateBasketPosition(e.touches[0].clientX);
}, { passive: false });

document.addEventListener('touchmove', (e) => {
    if (gameStarted) {
        e.preventDefault();
        updateBasketPosition(e.touches[0].clientX);
    }
}, { passive: false });

/* Preload reaction images */
const imgNormal = new Image(); imgNormal.src = 'me.jpg';
const imgHit    = new Image(); imgHit.src    = 'me2.jpg';
const imgHappy  = new Image(); imgHappy.src  = 'me3.jpg';

let reactionTimeout = null;

/* Basket reactions */
function reactToHeart() {
    basket.style.animation = 'celebrateJump 0.5s ease';
    setTimeout(() => { basket.style.animation = ''; }, 500);

    const basketImg = document.getElementById('basketImg');
    if (reactionTimeout) clearTimeout(reactionTimeout);
    basketImg.src = 'me3.jpg';
    reactionTimeout = setTimeout(() => { basketImg.src = 'me.jpg'; }, 2000);
}

function reactToHit() {
    basket.style.animation = 'hitFlash 0.4s ease';
    setTimeout(() => { basket.style.animation = ''; }, 400);

    const basketImg = document.getElementById('basketImg');
    if (reactionTimeout) clearTimeout(reactionTimeout);
    basketImg.src = 'me2.jpg';
    reactionTimeout = setTimeout(() => { basketImg.src = 'me.jpg'; }, 2000);
}

function screenShake() {
    gameArea.style.animation = 'screenShake 0.4s ease';
    setTimeout(() => { gameArea.style.animation = ''; }, 400);
}

function spawnParticles(x, y) {
    for (let i = 0; i < 8; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        const angle = (i / 8) * Math.PI * 2;
        const distance = 50 + Math.random() * 30;
        particle.style.left = x + 'px';
        particle.style.top = y + 'px';
        particle.style.setProperty('--px', Math.cos(angle) * distance + 'px');
        particle.style.setProperty('--py', Math.sin(angle) * distance + 'px');
        gameArea.appendChild(particle);
        setTimeout(() => particle.remove(), 800);
    }
}

/* Double Points */
function activateDoublePoints() {
    doublePoints = true;
    basket.classList.add('doublePoints');
    document.getElementById('doubleBanner').style.display = 'block';
    
    setTimeout(() => {
        doublePoints = false;
        basket.classList.remove('doublePoints');
        document.getElementById('doubleBanner').style.display = 'none';
    }, 5000);
}

/* Auto-play music on first interaction */
document.body.addEventListener('touchstart', () => {
    if (gameStarted) startMusic();
}, { passive: true, once: true });

/* Create falling items */
function createItem() {
    const rand = Math.random();
    let item;
    
    if (rand < 0.25) {
        // Regular heart
        item = createHeart();
    } else if (rand < 0.35) {
        // Power-up
        item = createPowerup();
    } else if (rand < 0.40) {
        // Bomb
        item = createBomb();
    } else {
        // Flying penis easter egg (60% chance - it's EVERYWHERE!)
        item = createEasterEgg();
    }
}

function createHeart() {
    const heart = document.createElement("div");
    heart.classList.add("heart");
    const hearts = ["‚ù§Ô∏è", "üíï", "üíñ", "üíó", "üíì", "üíù"];
    heart.innerHTML = hearts[Math.floor(Math.random() * hearts.length)];
    heart.style.left = Math.random() * (getGameWidth() - 50) + "px";
    heart.style.animationDuration = (2 + Math.random() * 2) + "s";
    if (difficulty === 'hard') heart.style.animationDuration = (1.5 + Math.random() * 1) + "s";
    if (difficulty === 'easy') heart.style.animationDuration = (3 + Math.random() * 2) + "s";
    gameArea.appendChild(heart);
    activeItems.push({ el: heart, type: 'heart' });
}

function createPowerup() {
    const powerup = document.createElement("div");
    powerup.classList.add("powerup");
    const powerups = ["‚≠ê", "üí´", "‚ú®", "üåü"];
    powerup.innerHTML = powerups[Math.floor(Math.random() * powerups.length)];
    powerup.style.left = Math.random() * (getGameWidth() - 50) + "px";
    const fallDuration = (2 + Math.random() * 2).toFixed(2) + "s";
    powerup.style.animationDuration = fallDuration + ", 0.6s";
    gameArea.appendChild(powerup);
    activeItems.push({ el: powerup, type: 'powerup' });
}

function createBomb() {
    const bomb = document.createElement("div");
    bomb.classList.add("bomb");
    bomb.innerHTML = "üí£";
    bomb.style.left = Math.random() * (getGameWidth() - 50) + "px";
    bomb.style.animationDuration = (2 + Math.random() * 1.5) + "s";
    gameArea.appendChild(bomb);
    activeItems.push({ el: bomb, type: 'bomb' });
}

function createEasterEgg() {
    const egg = document.createElement("div");
    egg.classList.add("bomb");
    egg.innerHTML = "üçÜ";
    egg.style.left = Math.random() * (getGameWidth() - 50) + "px";
    egg.style.animationDuration = (1.5 + Math.random() * 1) + "s";
    egg.style.fontSize = "35px";
    gameArea.appendChild(egg);
    playSound('spawn');
    activeItems.push({ el: egg, type: 'easteregg' });
}

/* Unified RAF-based collision loop ‚Äî replaces per-item setInterval */
let activeItems = []; // { el, type }
let collisionLoopRunning = false;

function startCollisionLoop() {
    if (collisionLoopRunning) return;
    collisionLoopRunning = true;
    rafCollisionLoop();
}

function rafCollisionLoop() {
    if (!gameStarted && activeItems.length === 0) { collisionLoopRunning = false; return; }

    const basketRect = basket.getBoundingClientRect();
    const viewH = window.visualViewport ? window.visualViewport.height : window.innerHeight;

    for (let i = activeItems.length - 1; i >= 0; i--) {
        const { el, type } = activeItems[i];
        const itemRect = el.getBoundingClientRect();

        // Caught
        if (
            itemRect.bottom >= basketRect.top &&
            itemRect.left < basketRect.right &&
            itemRect.right > basketRect.left
        ) {
            handleCatch(type, itemRect);
            el.remove();
            activeItems.splice(i, 1);
            continue;
        }

        // Missed ‚Äî fell off screen
        if (itemRect.top > viewH) {
            el.remove();
            activeItems.splice(i, 1);
            if (type === 'heart') {
                streak = 0;
                combo = 0;
                streakDisplay.textContent = streak;
                comboDisplay.textContent = "";
                // Missing a heart costs a life
                if (gameStarted) {
                    showPopup("üíî MISSED!");
                    loseLife();
                }
            }
        }
    }

    requestAnimationFrame(rafCollisionLoop);
}

function handleCatch(type, itemRect) {
    if (type === 'heart') {
        heartsThisLevel++;
        score++;
        streak++;
        combo++;
        updateHeartsDisplay();

        if (itemRect) {
            const cx = itemRect.left + itemRect.width / 2 - gameArea.getBoundingClientRect().left;
            const cy = itemRect.top + itemRect.height / 2 - gameArea.getBoundingClientRect().top;
            spawnParticles(cx, cy);
        }

        if (doublePoints) {
            heartsThisLevel++;
            score++;
            updateHeartsDisplay();
            showPopup(`üíõ DOUBLE! +2 ‚ù§Ô∏è`);
        }

        if (combo > 2) {
            comboDisplay.textContent = `${combo}x COMBO!`;
            comboDisplay.classList.add('pulse');
            setTimeout(() => comboDisplay.classList.remove('pulse'), 200);
            playSound('combo');
            if (!doublePoints) showPopup(funnyMessages[Math.floor(Math.random() * funnyMessages.length)]);
        } else {
            playSound('catch');
        }

        reactToHeart();
        checkLevelUp();
        if (streak > maxStreak) maxStreak = streak;

    } else if (type === 'powerup') {
        playSound('powerup');
        showPopup("‚≠ê 2x POINTS! ‚≠ê");
        activatePowerup();
        activateDoublePoints();

    } else if (type === 'bomb') {
        if (!invincible) {
            streak = 0; combo = 0;
            streakDisplay.textContent = streak;
            comboDisplay.textContent = "";
            playSound('bomb');
            showPopup("üí• BOMB! -1 Life üíî");
            reactToHit();
            screenShake();
            loseLife();          // üí£ costs a LIFE
        } else {
            showPopup("üõ°Ô∏è PROTECTED!");
        }

    } else if (type === 'easteregg') {
        // üçÜ costs a HEART (from level progress)
        if (heartsThisLevel > 0) {
            heartsThisLevel--;
            score = Math.max(0, score - 1);
            updateHeartsDisplay();
        }
        streak = 0; combo = 0;
        streakDisplay.textContent = streak;
        comboDisplay.textContent = "";
        playSound('easteregg');
        showPopup("üçÜ OUCH! -1 ‚ù§Ô∏è üòÇ");
        reactToHit();
        screenShake();
    }

    // Win condition: reach level 6 (complete 5 levels of 10 hearts)
    if (level > 5 && gameStarted) {
        const imgEl = document.getElementById('gameOverImg');
        imgEl.innerHTML = `<img src="${ME_HAPPY}" style="height:100px;width:auto;border-radius:12px;object-fit:cover;">`;
        document.getElementById('gameOverTitle').textContent = 'üéâ You Won!';
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('beatrix_highscore', highScore);
        }
        document.getElementById('gameOverScore').textContent = `${score} hearts collected üíñ`;
        document.getElementById('gameOverHigh').textContent = `Best: ${highScore} üèÜ`;
        document.getElementById('gameOverLevel').textContent = `Completed all 5 levels!`;
        gameStarted = false;
        clearInterval(spawnInterval);
        stopMusic();
        message.style.display = "block";
        playSound('win');
        showPopup("üéâ YOU WIN! üéâ");
        setTimeout(() => {
            document.getElementById('gameOver').style.display = 'flex';
        }, 2000);
    }
}

function activatePowerup() {
    invincible = true;
    basket.classList.add('invincible');
    activateDoublePoints();
    setTimeout(() => {
        invincible = false;
        basket.classList.remove('invincible');
    }, 5000);
}

function showPopup(text) {
    popupText.textContent = text;
    popupText.style.opacity = 1;
    popupText.style.transform = 'translate(-50%, -50%) scale(1)';
    
    setTimeout(() => {
        popupText.style.transition = 'all 0.5s ease-out';
        popupText.style.opacity = 0;
        popupText.style.transform = 'translate(-50%, -80%) scale(0.5)';
    }, 800);
    
    setTimeout(() => {
        popupText.style.transition = '';
    }, 1300);
}

/* Sparkles */
function createSparkle() {
    const sparkle = document.createElement("div");
    sparkle.classList.add("sparkle");
    sparkle.style.left = Math.random() * getGameWidth() + "px";
    sparkle.style.animationDuration = (3 + Math.random() * 3) + "s";
    document.body.appendChild(sparkle);
    setTimeout(() => sparkle.remove(), 6000);
}

/* Floating Love Text */
function createLoveText() {
    const text = document.createElement("div");
    text.classList.add("loveText");
    text.innerHTML = loveMessages[Math.floor(Math.random() * loveMessages.length)];
    text.style.left = Math.random() * (getGameWidth() - 200) + "px";
    document.body.appendChild(text);
    setTimeout(() => text.remove(), 6000);
}

/* Initialize page with default theme */
window.addEventListener('DOMContentLoaded', function() {
    // Set initial background
    document.body.style.background = 'linear-gradient(to bottom, #ff758c, #ff7eb3)';
    console.log('Page loaded, background set');
});

</script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#ff758c">
<title>Catch the Love - For Beatrix ‚ù§Ô∏è</title>

<script>
// Set background IMMEDIATELY on page load
document.addEventListener('DOMContentLoaded', function() {
    document.body.style.backgroundColor = '#ff758c';
    document.body.style.backgroundImage = 'linear-gradient(to bottom, #ff758c, #ff7eb3)';
    console.log('IMMEDIATE: Background set on page load');
});
</script>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

html {
    background: #ff758c;
    height: 100%;
}

body {
    margin: 0;
    overflow: hidden;
    background: linear-gradient(to bottom, #ff758c, #ff7eb3);
    font-family: -apple-system, BlinkMacSystemFont, 'Arial', sans-serif;
    text-align: center;
    touch-action: none;
    position: fixed;
    width: 100%;
    height: 100vh;
    height: 100dvh;
    overscroll-behavior: none;
    transition: background 1s ease;
}


/* Animated background particles */
.bg-particle {
    position: fixed;
    top: -60px;
    pointer-events: none;
    z-index: 1;
}

.bg-particle.falling {
    animation: bgFall linear forwards;
}

@keyframes bgFall {
    0%   { transform: translateY(0) rotate(0deg);   opacity: 1; }
    90%  { opacity: 1; }
    100% { transform: translateY(110vh) rotate(400deg); opacity: 0; }
}

@keyframes bgDrift {
    0%   { transform: translateY(0) translateX(0) rotate(0deg);   opacity: 1; }
    100% { transform: translateY(110vh) translateX(40px) rotate(360deg); opacity: 0; }
}

@keyframes bgFloat {
    0%,100% { transform: translateY(0) scale(1);   opacity: 0.7; }
    50%      { transform: translateY(-12px) scale(1.15); opacity: 1; }
}

@keyframes bgCloudFloat {
    0%   { transform: translateX(-220px); }
    100% { transform: translateX(calc(100vw + 220px)); }
}

@keyframes bgBubble {
    0%   { transform: translateY(100vh) scale(0.5); opacity: 0; }
    20%  { opacity: 0.8; }
    100% { transform: translateY(-80px)  scale(1.2); opacity: 0; }
}

@keyframes bgPulse {
    0%,100% { transform: scale(1);   opacity: 0.6; }
    50%      { transform: scale(1.3); opacity: 1;   }
}

@keyframes bgMeteor {
    0%   { transform: translate(0, 0) rotate(30deg);          opacity: 1; }
    80%  { opacity: 0.8; }
    100% { transform: translate(60vw, 110vh) rotate(30deg);   opacity: 0; }
}

/* Header */
.header {
    position: relative;
    z-index: 100;
    padding: 10px 15px;
    padding-top: max(10px, env(safe-area-inset-top, 10px));
    background: rgba(0,0,0,0.2);
}

h1 {
    color: white;
    font-size: 22px;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.4);
    margin-bottom: 5px;
}

#scoreBoard {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
}

.stat {
    color: white;
    font-size: 16px;
    font-weight: bold;
    text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
}

#combo {
    color: #FFD700;
    font-size: 20px;
    transform: scale(1);
    transition: transform 0.2s;
}

#combo.pulse {
    transform: scale(1.3);
}

/* Sparkles - color changes per level */
.sparkle {
    position: absolute;
    width: 6px;
    height: 6px;
    background: white;
    border-radius: 50%;
    opacity: 0.8;
    animation: sparkleFloat 4s linear infinite;
    pointer-events: none;
}

@keyframes sparkleFloat {
    from { transform: translateY(100vh) scale(0.5); opacity: 0; }
    50% { opacity: 1; }
    to { transform: translateY(-10vh) scale(1.2); opacity: 0; }
}

#gameArea {
    position: relative;
    width: 100vw;
    height: calc(100vh - 100px);
    height: calc(100dvh - 100px);
    overflow: hidden;
}

/* Hearts and Items */
.heart, .powerup, .bomb {
    position: absolute;
    font-size: 28px;
    animation: fall linear;
    cursor: pointer;
    user-select: none;
}

.powerup {
    font-size: 32px;
    animation: fall linear, starPulse 0.6s ease-in-out infinite alternate;
}

@keyframes starPulse {
    from { filter: brightness(1) drop-shadow(0 0 4px rgba(255,220,0,0.6)); }
    to   { filter: brightness(1.5) drop-shadow(0 0 12px rgba(255,220,0,1)); }
}

.bomb {
    font-size: 30px;
    animation: fallWobble linear;
}

@keyframes fall {
    from { transform: translateY(-50px); }
    to { transform: translateY(calc(100vh + 50px)); }
}


@keyframes fallWobble {
    from { transform: translateY(-50px) rotate(-5deg); }
    25% { transform: translateY(calc(25vh)) rotate(5deg); }
    50% { transform: translateY(calc(50vh)) rotate(-5deg); }
    75% { transform: translateY(calc(75vh)) rotate(5deg); }
    to { transform: translateY(calc(100vh + 50px)) rotate(-5deg); }
}

#basket {
    position: absolute;
    bottom: max(20px, env(safe-area-inset-bottom, 20px) + 10px);
    left: 50%;
    transform: translateX(-50%);
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    z-index: 10;
    touch-action: none;
    will-change: transform;
    -webkit-transform: translateX(-50%);
}

#basket.invincible img {
    animation: shieldGlow 0.4s ease-in-out infinite alternate;
    border-color: gold !important;
}

@keyframes shieldGlow {
    from { box-shadow: 0 0 8px 2px rgba(255, 215, 0, 0.6); }
    to   { box-shadow: 0 0 20px 6px rgba(255, 215, 0, 1); }
}

@keyframes hitFlash {
    0%   { opacity: 1; }
    20%  { opacity: 0.1; }
    40%  { opacity: 1; }
    60%  { opacity: 0.1; }
    80%  { opacity: 1; }
    100% { opacity: 1; }
}

@keyframes celebrateJump {
    0%   { transform: translateY(0) scale(1); }
    30%  { transform: translateY(-18px) scale(1.08); }
    55%  { transform: translateY(-8px) scale(1.04); }
    75%  { transform: translateY(-14px) scale(1.06); }
    100% { transform: translateY(0) scale(1); }
}

@keyframes screenShake {
    0%,100% { transform: translate(0,0); }
    15%     { transform: translate(-8px, 4px); }
    30%     { transform: translate(8px, -4px); }
    45%     { transform: translate(-6px, -6px); }
    60%     { transform: translate(6px, 4px); }
    75%     { transform: translate(-4px, 2px); }
}

@keyframes particleBurst {
    0%   { transform: translate(0,0) scale(1); opacity: 1; }
    100% { transform: translate(var(--px), var(--py)) scale(0); opacity: 0; }
}

/* Golden double-points glow around basket */
#basket.doublePoints img {
    animation: goldPulse 0.5s ease-in-out infinite alternate;
    outline: 3px solid gold;
    outline-offset: 3px;
    border-radius: 4px;
}
@keyframes goldPulse {
    from { filter: drop-shadow(0 0 6px rgba(255,215,0,0.8)); }
    to   { filter: drop-shadow(0 0 18px rgba(255,215,0,1)) brightness(1.1); }
}

/* Double points banner */
#doublePointsBanner, #doubleBanner {
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #000;
    font-weight: bold;
    font-size: 14px;
    padding: 4px 14px;
    border-radius: 20px;
    box-shadow: 0 0 12px rgba(255,215,0,0.8);
    display: none;
    z-index: 50;
    white-space: nowrap;
}




/* Love message overlay */
#levelComplete {
    position: fixed;
    inset: 0;
    z-index: 1500;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 30px 20px;
    animation: fadeIn 0.4s ease;
}

#levelComplete .lc-card {
    background: rgba(0,0,0,0.65);
    backdrop-filter: blur(10px);
    border-radius: 24px;
    padding: 28px 32px;
    max-width: 320px;
    width: 100%;
    border: 1px solid rgba(255,255,255,0.15);
}

#levelComplete .lc-emoji  { font-size: 52px; margin-bottom: 8px; }
#levelComplete .lc-title  { font-size: 1.6rem; font-weight: 800; color: #FFD700; margin-bottom: 4px; }
#levelComplete .lc-theme  { font-size: 1rem; color: rgba(255,255,255,0.8); margin-bottom: 16px; }
#levelComplete .lc-stats  { display: flex; justify-content: space-around; margin-bottom: 20px; }
#levelComplete .lc-stat   { display: flex; flex-direction: column; align-items: center; gap: 2px; }
#levelComplete .lc-stat-val { font-size: 1.5rem; font-weight: 800; color: white; }
#levelComplete .lc-stat-lbl { font-size: 0.7rem; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.05em; }
#levelComplete .lc-next   {
    background: linear-gradient(135deg, #ff758c, #ff7eb3);
    color: white; border: none;
    padding: 13px 36px; font-size: 1.1rem; font-weight: 700;
    border-radius: 50px; cursor: pointer;
    box-shadow: 0 4px 15px rgba(255,100,150,0.4);
    transition: transform 0.15s;
    width: 100%;
}
#levelComplete .lc-next:active { transform: scale(0.96); }

/* Messages */
#message {
    position: absolute;
    top: 35%;
    width: 100%;
    font-size: 28px;
    color: white;
    display: none;
    padding: 0 20px;
    animation: fadeIn 2s ease-in-out;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
}

#popupText {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    font-weight: bold;
    color: #FFD700;
    text-shadow: 3px 3px 10px rgba(0,0,0,0.8);
    opacity: 0;
    pointer-events: none;
    z-index: 150;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Floating love text */
.loveText {
    position: absolute;
    color: white;
    font-weight: bold;
    font-size: 18px;
    text-shadow: 2px 2px 6px rgba(0,0,0,0.5);
    animation: floatUp 6s ease-in forwards;
    pointer-events: none;
    z-index: 5;
}

@keyframes floatUp {
    from { transform: translateY(100vh); opacity: 0; }
    20% { opacity: 1; }
    80% { opacity: 1; }
    to { transform: translateY(-20vh); opacity: 0; }
}

/* Particle burst */
.particle {
    position: absolute;
    width: 8px;
    height: 8px;
    background: radial-gradient(circle, #FFD700, #FF69B4);
    border-radius: 50%;
    pointer-events: none;
    animation: particleBurst 0.8s ease-out forwards;
}

/* Menu overlay */
#menuOverlay, #gameOver, #howToPlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    text-align: center;
    padding: 30px 20px;
    backdrop-filter: blur(6px);
    overflow-y: auto;
}

#menuOverlay h1 {
    font-size: clamp(2rem, 8vw, 3.5rem);
    margin-bottom: 20px;
    background: linear-gradient(135deg, #ff758c, #FFD700);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.menu-buttons {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 20px;
}

.menu-button, .restart-btn {
    background: linear-gradient(135deg, #ff758c, #ff7eb3);
    color: white;
    border: none;
    padding: 15px 40px;
    font-size: 18px;
    font-weight: bold;
    border-radius: 50px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
}

.menu-button:active, .restart-btn:active {
    transform: scale(0.95);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.difficulty-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
}

.difficulty-btn {
    background: rgba(255,255,255,0.2);
    color: white;
    border: 2px solid white;
    padding: 8px 10px;
    font-size: 15px;
    font-weight: bold;
    border-radius: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    line-height: 1.3;
    min-width: 0;
}

.difficulty-btn.selected {
    background: white;
    color: #ff758c;
}

/* How to Play */
#howToPlay {
    display: none;
    overflow-y: auto;
}

.how-to-content {
    max-width: 500px;
    background: rgba(255,255,255,0.1);
    padding: 30px;
    border-radius: 20px;
    backdrop-filter: blur(10px);
}

.how-to-content h2 {
    color: white;
    margin-bottom: 20px;
    font-size: 28px;
}

.how-to-content p, .how-to-content ul {
    color: white;
    text-align: left;
    line-height: 1.8;
    margin-bottom: 15px;
}

.how-to-content ul {
    list-style-position: inside;
}

/* Game Over Screen */
#gameOver {
    display: none;
}

.game-over-content {
    background: rgba(255,255,255,0.1);
    padding: 40px 30px;
    border-radius: 20px;
    backdrop-filter: blur(10px);
    max-width: 400px;
}

#gameOverTitle {
    font-size: 36px;
    color: white;
    margin-bottom: 20px;
}

#gameOverImg {
    font-size: 80px;
    margin-bottom: 20px;
}

#gameOverScore, #gameOverHigh, #gameOverStreak, #gameOverLevel {
    color: white;
    font-size: 18px;
    margin: 10px 0;
}

/* Sound toggle */
#soundToggle {
    position: fixed;
    top: max(10px, env(safe-area-inset-top, 10px));
    right: 15px;
    z-index: 200;
    background: rgba(0,0,0,0.3);
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 50px;
    font-size: 20px;
    cursor: pointer;
    transition: background 0.3s;
}

#soundToggle:active {
    background: rgba(0,0,0,0.5);
}

/* Lives display */
#lives {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 24px;
    z-index: 50;
}

/* Level transition ‚Äî pinned to top, no overlay */
#levelTransition {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 2000;
    display: none;
    flex-direction: column;
    align-items: center;
    text-align: center;
    pointer-events: none;
    background: rgba(0,0,0,0.5);
    border-radius: 12px;
    padding: 8px 20px 10px;
    white-space: nowrap;
}

#levelTransition .level-number {
    font-size: 1rem;
    color: white;
    font-weight: bold;
    margin-bottom: 1px;
}

#levelTransition .level-theme {
    font-size: 1.1rem;
    color: #FFD700;
    font-weight: bold;
    margin-bottom: 1px;
}

#levelTransition .level-description {
    font-size: 0.78rem;
    color: rgba(255,255,255,0.75);
}

/* Countdown word ‚Äî dead centre, nothing else nearby */
#countdown {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: clamp(2rem, 10vw, 4rem);
    font-weight: 800;
    pointer-events: none;
    z-index: 2100;
    display: none;
    letter-spacing: 0.05em;
    text-shadow: 0 2px 12px rgba(0,0,0,0.5);
    animation: countPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

@keyframes countPop {
    0%   { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
    70%  { transform: translate(-50%, -50%) scale(1.05); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(1);   opacity: 1; }
}

@keyframes countFade {
    0%   { opacity: 1; transform: translate(-50%, -50%) scale(1);   }
    100% { opacity: 0; transform: translate(-50%, -50%) scale(1.15); }
}
</style>
</head>
<body>

<!-- Sound Toggle -->
<button id="soundToggle" onclick="toggleSound()">üîä</button>

<!-- Lives Display -->
<div id="lives"></div>

<!-- Double Points Banner -->
<div id="doubleBanner">‚≠ê DOUBLE POINTS ‚≠ê</div>

<!-- Menu Overlay -->
<div id="menuOverlay">
    <h1>Catch the Love üíï</h1>
    <div style="font-size: 60px; margin: 20px 0;">‚ù§Ô∏è</div>
    <p style="color: white; font-size: 18px; margin-bottom: 10px;">A Game Made with Love for Beatrix</p>
    
    <div class="menu-buttons">
        <button class="menu-button" onclick="showDifficultySelect()">‚ñ∂Ô∏è Start Game</button>
        <button class="menu-button" onclick="showHowToPlay()">‚ùì How to Play</button>
    </div>
    
    <div id="difficultySelect" style="display: none; margin-top: 30px;">
        <p style="color: white; font-size: 20px; margin-bottom: 15px;">Select Difficulty</p>
        <div class="difficulty-buttons" id="difficultyBtns">
            <button class="difficulty-btn" onclick="selectDifficulty('easy')">Easy</button>
            <button class="difficulty-btn selected" onclick="selectDifficulty('medium')">Medium</button>
            <button class="difficulty-btn" onclick="selectDifficulty('hard')">Hard</button>
        </div>

        <p style="color: white; font-size: 20px; margin: 25px 0 15px 0;">Start from Level</p>
        <div id="levelSelect" style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;max-width:400px;margin:0 auto;">
            <button class="difficulty-btn selected" onclick="selectStartLevel(1)">1<br><span style="font-size:16px">üå∏</span></button>
            <button class="difficulty-btn" onclick="selectStartLevel(2)">2<br><span style="font-size:16px">üåä</span></button>
            <button class="difficulty-btn" onclick="selectStartLevel(3)">3<br><span style="font-size:16px">üçÇ</span></button>
            <button class="difficulty-btn" onclick="selectStartLevel(4)">4<br><span style="font-size:16px">üå†</span></button>
            <button class="difficulty-btn" onclick="selectStartLevel(5)">5<br><span style="font-size:16px">‚òÄÔ∏è</span></button>
            <button class="difficulty-btn" onclick="selectStartLevel(6)">6<br><span style="font-size:16px">üåø</span></button>
            <button class="difficulty-btn" onclick="selectStartLevel(7)">7<br><span style="font-size:16px">üç¨</span></button>
            <button class="difficulty-btn" onclick="selectStartLevel(8)">8<br><span style="font-size:16px">üåå</span></button>
            <button class="difficulty-btn" onclick="selectStartLevel(9)">9<br><span style="font-size:16px">üå∫</span></button>
            <button class="difficulty-btn" onclick="selectStartLevel(10)">10<br><span style="font-size:16px">üéâ</span></button>
        </div>
        
        <button class="menu-button" onclick="startGame()" style="margin-top: 20px;">Start! üöÄ</button>
    </div>
    
    <p style="color: rgba(255,255,255,0.6); margin-top: 30px; font-size: 14px;">
        High Score: <span id="menuHighScore">0</span> ‚ù§Ô∏è
    </p>
</div>

<!-- How to Play -->
<div id="howToPlay">
    <div class="how-to-content">
        <h2>How to Play üéÆ</h2>
        <p><strong>Goal:</strong> Catch falling hearts to collect 10 hearts per level and complete all 10 levels!</p>
        
        <ul>
            <li>‚ù§Ô∏è <strong>Hearts:</strong> Catch them! Each heart = 1 point</li>
            <li>‚≠ê <strong>Power-ups:</strong> Get invincibility shield + double points for 5 seconds</li>
            <li>üí£ <strong>Bombs:</strong> Avoid! Loses 1 life</li>
            <li>üçÜ <strong>Easter Egg:</strong> Loses 1 heart from your level progress</li>
        </ul>
        
        <p><strong>Controls:</strong> Drag or touch to move the basket</p>
        
        <p><strong>Lives:</strong> You have 3 lives. Missing a heart or catching a bomb costs a life!</p>
        
        <button class="menu-button" onclick="closeHowToPlay()">Got it! üëç</button>
    </div>
</div>

<!-- Level Transition -->
<div id="levelTransition">
    <div class="level-number"></div>
    <div class="level-theme"></div>
    <div class="level-description"></div>
</div>

<!-- Countdown -->
<div id="countdown"></div>

<!-- Game Over Screen -->
<div id="gameOver">
    <div class="game-over-content">
        <h2 id="gameOverTitle">Game Over üíî</h2>
        <div id="gameOverImg">üò¢</div>
        <p id="gameOverScore">Score: 0</p>
        <p id="gameOverHigh">High Score: 0</p>
        <p id="gameOverStreak">Max Streak: 0</p>
        <p id="gameOverLevel">Level: 1</p>
        <button class="restart-btn" onclick="restartGame()">Play Again üîÑ</button>
        <button class="restart-btn" onclick="backToMenu()" style="background: linear-gradient(135deg, #667eea, #764ba2); margin-top: 10px;">Main Menu üè†</button>
    </div>
</div>

<!-- Header -->
<div class="header">
    <h1>Catch the Love ‚ù§Ô∏è</h1>
    <div id="scoreBoard">
        <div class="stat">‚ù§Ô∏è <span id="heartsDisplay">0/10</span></div>
        <div class="stat">Level <span id="level">1</span></div>
        <div class="stat">Streak: <span id="streak">0</span></div>
        <div class="stat" id="combo"></div>
    </div>
</div>

<!-- Game Area -->
<div id="gameArea">
    <div id="message"></div>
    <div id="popupText"></div>
    <div id="basket"><img id="basketImg" src="me.jpg" style="height:90px;width:auto;display:block;filter:drop-shadow(0 4px 10px rgba(0,0,0,0.5));"></div>
</div>

<!-- Level Complete Screen -->
<div id="levelComplete">
    <div class="lc-card">
        <div class="lc-emoji" id="lcEmoji">üéâ</div>
        <div class="lc-title" id="lcTitle">Level Complete!</div>
        <div class="lc-theme" id="lcTheme"></div>
        <div class="lc-stats">
            <div class="lc-stat">
                <div class="lc-stat-val" id="lcStreak">0</div>
                <div class="lc-stat-lbl">Best Streak</div>
            </div>
            <div class="lc-stat">
                <div class="lc-stat-val" id="lcScore">0</div>
                <div class="lc-stat-lbl">Total Hearts</div>
            </div>
            <div class="lc-stat">
                <div class="lc-stat-val" id="lcLives">üíñ</div>
                <div class="lc-stat-lbl">Lives Left</div>
            </div>
        </div>
        <button class="lc-next" onclick="nextLevel()">Next Level ‚Üí</button>
    </div>
</div>

<script>
/* Base64 Images */
const ME_SAD = "me2.jpg";
const ME_HAPPY = "me3.jpg";

/* Level Themes */
/* Game Variables */
const basket = document.getElementById("basket");
const gameArea = document.getElementById("gameArea");
const scoreDisplay = document.getElementById("heartsDisplay");
const levelDisplay = document.getElementById("level");
const streakDisplay = document.getElementById("streak");
const comboDisplay = document.getElementById("combo");
const message = document.getElementById("message");
const popupText = document.getElementById("popupText");
const livesDisplay = document.getElementById("lives");

let score = 0;
let heartsThisLevel = 0;
let level = 1;
let streak = 0;
let maxStreak = 0;
let combo = 0;
let lives = 3;
let gameStarted = false;
let spawnInterval;
let difficulty = 'medium';
let invincible = false;
let doublePoints = false;
let soundEnabled = true;
let highScore = localStorage.getItem('beatrix_highscore') || 0;
let themeAnimationInterval;
document.getElementById('menuHighScore').textContent = highScore;

/* Love messages */
const loveMessages = [
    "You're my sunshine! ‚òÄÔ∏è",
    "Forever yours üíï",
    "My heart beats for you üíì",
    "You make me smile üòä",
    "Best thing ever! ‚ú®",
    "Love you infinity! ‚àû"
];

const funnyMessages = [
    "üî• ON FIRE!",
    "üí´ AMAZING!",
    "‚ö° UNSTOPPABLE!",
    "üåü PERFECT!",
    "üíù INCREDIBLE!",
    "üéØ LEGEND!"
];

/* ‚îÄ‚îÄ Web Audio Sound Engine ‚îÄ‚îÄ */
let audioCtx = null;
function getAudioCtx() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    return audioCtx;
}

function playSound(type) {
    if (!soundEnabled) return;
    try {
        const ctx = getAudioCtx();
        const t = ctx.currentTime;
        switch(type) {

            case 'catch': {
                // Sweet little "ding" ‚Äî rising tone
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.type = 'sine';
                o.frequency.setValueAtTime(520, t);
                o.frequency.linearRampToValueAtTime(880, t + 0.12);
                g.gain.setValueAtTime(0.35, t);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
                o.start(t); o.stop(t + 0.3);
                break;
            }

            case 'combo': {
                // Fast upward arpeggio
                [523, 659, 784, 1047].forEach((freq, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'triangle';
                    const st = t + i * 0.07;
                    o.frequency.setValueAtTime(freq, st);
                    g.gain.setValueAtTime(0.3, st);
                    g.gain.exponentialRampToValueAtTime(0.001, st + 0.18);
                    o.start(st); o.stop(st + 0.18);
                });
                break;
            }

            case 'bomb': {
                // Deep thud + noise burst
                const buf = ctx.createBuffer(1, ctx.sampleRate * 0.5, ctx.sampleRate);
                const data = buf.getChannelData(0);
                for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / data.length, 3);
                const src = ctx.createBufferSource();
                src.buffer = buf;
                const g = ctx.createGain();
                const f = ctx.createBiquadFilter();
                f.type = 'lowpass'; f.frequency.value = 180;
                src.connect(f); f.connect(g); g.connect(ctx.destination);
                g.gain.setValueAtTime(1.2, t);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                src.start(t);

                // Sub thud
                const o = ctx.createOscillator();
                const g2 = ctx.createGain();
                o.connect(g2); g2.connect(ctx.destination);
                o.type = 'sine';
                o.frequency.setValueAtTime(120, t);
                o.frequency.exponentialRampToValueAtTime(30, t + 0.4);
                g2.gain.setValueAtTime(0.8, t);
                g2.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
                o.start(t); o.stop(t + 0.4);
                break;
            }

            case 'easteregg': {
                // Silly descending "womp womp"
                [400, 300, 220].forEach((freq, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'sawtooth';
                    const st = t + i * 0.15;
                    o.frequency.setValueAtTime(freq, st);
                    o.frequency.exponentialRampToValueAtTime(freq * 0.7, st + 0.14);
                    g.gain.setValueAtTime(0.25, st);
                    g.gain.exponentialRampToValueAtTime(0.001, st + 0.15);
                    o.start(st); o.stop(st + 0.15);
                });
                break;
            }

            case 'powerup': {
                // Sparkling rising sweep
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.type = 'sine';
                o.frequency.setValueAtTime(330, t);
                o.frequency.exponentialRampToValueAtTime(1320, t + 0.4);
                g.gain.setValueAtTime(0.0, t);
                g.gain.linearRampToValueAtTime(0.4, t + 0.05);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                o.start(t); o.stop(t + 0.5);
                // Shimmer layer
                const o2 = ctx.createOscillator();
                const g2 = ctx.createGain();
                o2.connect(g2); g2.connect(ctx.destination);
                o2.type = 'triangle';
                o2.frequency.setValueAtTime(660, t);
                o2.frequency.exponentialRampToValueAtTime(2640, t + 0.4);
                g2.gain.setValueAtTime(0.2, t);
                g2.gain.exponentialRampToValueAtTime(0.001, t + 0.45);
                o2.start(t); o2.stop(t + 0.45);
                break;
            }

            case 'levelup': {
                // Full celebratory jingle ‚Äî plays while level complete card is shown (~3.5s)
                stopMusic();
                const melody = [
                    {f:523,  t:0.00}, {f:659,  t:0.18}, {f:784,  t:0.36},
                    {f:1047, t:0.54}, {f:784,  t:0.72}, {f:880,  t:0.90},
                    {f:1047, t:1.08}, {f:1175, t:1.32},
                    {f:1047, t:1.56}, {f:880,  t:1.74}, {f:784,  t:1.92},
                    {f:1047, t:2.10}, {f:1319, t:2.40}, {f:1047, t:2.70},
                    {f:784,  t:3.00}, {f:1047, t:3.20}
                ];
                melody.forEach(({f, t: st}) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'sine';
                    o.frequency.value = f;
                    g.gain.setValueAtTime(0.0, t + st);
                    g.gain.linearRampToValueAtTime(0.18, t + st + 0.03);
                    g.gain.exponentialRampToValueAtTime(0.001, t + st + 0.28);
                    o.start(t + st); o.stop(t + st + 0.3);
                });
                // Harmony bass notes
                const bass = [
                    {f:131, t:0.00}, {f:165, t:0.54}, {f:131, t:1.08},
                    {f:196, t:1.56}, {f:131, t:2.10}, {f:196, t:2.70}
                ];
                bass.forEach(({f, t: st}) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'triangle';
                    o.frequency.value = f;
                    g.gain.setValueAtTime(0.12, t + st);
                    g.gain.exponentialRampToValueAtTime(0.001, t + st + 0.45);
                    o.start(t + st); o.stop(t + st + 0.5);
                });
                break;
            }

            case 'gameover': {
                // Sad descending trombone
                [440, 370, 311, 261].forEach((freq, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'sawtooth';
                    const st = t + i * 0.2;
                    o.frequency.setValueAtTime(freq, st);
                    o.frequency.linearRampToValueAtTime(freq * 0.88, st + 0.18);
                    g.gain.setValueAtTime(0.22, st);
                    g.gain.exponentialRampToValueAtTime(0.001, st + 0.22);
                    o.start(st); o.stop(st + 0.22);
                });
                break;
            }

            case 'win': {
                // Big celebratory jingle
                const melody = [523,659,784,1047,784,1047,1319];
                melody.forEach((freq, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = i % 2 === 0 ? 'sine' : 'triangle';
                    const st = t + i * 0.1;
                    o.frequency.setValueAtTime(freq, st);
                    g.gain.setValueAtTime(0.25, st);
                    g.gain.exponentialRampToValueAtTime(0.001, st + 0.2);
                    o.start(st); o.stop(st + 0.2);
                });
                break;
            }

            case 'spawn': {
                // Tiny soft pop
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.type = 'sine';
                o.frequency.setValueAtTime(900, t);
                o.frequency.exponentialRampToValueAtTime(400, t + 0.08);
                g.gain.setValueAtTime(0.15, t);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                o.start(t); o.stop(t + 0.1);
                break;
            }
        }
    } catch(e) {}
}

/* ‚îÄ‚îÄ Per-level music ‚îÄ‚îÄ */
let musicInterval = null;
let musicStep = 0;

/*
  Each song: { bpm, wave, notes[], bass[] }
  notes = melody frequencies (Hz), bass = optional low drone notes
  Level 1 ‚Äî Sweet/dreamy waltz (sine, slow)
  Level 2 ‚Äî Flowing ocean lullaby (triangle, gentle)
  Level 3 ‚Äî Upbeat warm strumming (square, medium)
  Level 4 ‚Äî Mysterious cosmic arp (sawtooth filtered, fast)
  Level 5 ‚Äî Triumphant fanfare (all voices, energetic)
*/
const levelSongs = {
    1: {
        bpm: 320,
        wave: 'sine',
        vol: 0.09,
        notes: [523,659,784,659,784,880,784,659, 523,440,392,440,523,392,330,392],
        bass:  [131,131,131,131, 98, 98, 98, 98, 131,131, 98, 98,131,131, 98, 98]
    },
    2: {
        bpm: 380,
        wave: 'triangle',
        vol: 0.10,
        notes: [440,494,523,587,523,494,440,415, 392,440,494,523,440,392,349,392],
        bass:  [110,110,130,130,110,110, 98, 98,  98, 98,110,110, 98, 98, 87, 87]
    },
    3: {
        bpm: 260,
        wave: 'square',
        vol: 0.06,
        notes: [659,784,880,784,659,587,523,587, 659,784,880,1047,880,784,659,523],
        bass:  [165,165,220,220,165,165,131,131, 165,165,220,220, 165,165,131,131]
    },
    4: {
        bpm: 200,
        wave: 'sawtooth',
        vol: 0.05,
        notes: [293,349,440,523,440,349,293,261, 220,261,330,440,523,440,330,220],
        bass:  [ 73, 73, 87, 87, 87, 87, 73, 73,  55, 55, 73, 73, 87, 87, 73, 73]
    },
    5: {
        bpm: 220,
        wave: 'sine',
        vol: 0.10,
        notes: [523,659,784,1047,784,659,880,1047, 1047,880,784,659,523,659,784,523],
        bass:  [131,165,196, 262,196,165,220, 262,  262,220,196,165,131,165,196,131]
    },
    6: {
        bpm: 300,
        wave: 'triangle',
        vol: 0.08,
        notes: [392,440,494,523,587,523,494,440, 392,349,392,440,523,494,440,392],
        bass:  [ 98, 98,110,131,131,131,110,110,  98, 87, 98,110,131,110,110, 98]
    },
    7: {
        bpm: 340,
        wave: 'sine',
        vol: 0.09,
        notes: [659,698,784,880,784,698,659,622, 587,622,659,698,784,698,622,587],
        bass:  [165,175,196,220,196,175,165,155, 147,155,165,175,196,175,155,147]
    },
    8: {
        bpm: 180,
        wave: 'sawtooth',
        vol: 0.04,
        notes: [220,247,261,294,330,294,261,247, 220,196,220,247,294,261,247,220],
        bass:  [ 55, 55, 65, 73, 82, 73, 65, 65,  55, 49, 55, 65, 73, 65, 65, 55]
    },
    9: {
        bpm: 250,
        wave: 'triangle',
        vol: 0.09,
        notes: [880,988,1047,1175,1047,988,880,831, 784,831,880,988,1047,988,831,784],
        bass:  [220,247, 261, 294, 261,247,220,208, 196,208,220,247, 261,247,208,196]
    },
    10: {
        bpm: 160,
        wave: 'sine',
        vol: 0.11,
        notes: [1047,988,880,784,880,988,1047,1175, 1175,1047,988,880,784,880,1047,1319],
        bass:  [ 262,247,220,196,220,247, 262, 294,  294, 262,247,220,196,220, 262, 330]
    }
};

function startMusic() {
    stopMusic();
    musicStep = 0;
    const song = levelSongs[level] || levelSongs[1];
    const stepMs = song.bpm;

    musicInterval = setInterval(() => {
        if (!soundEnabled) return;
        try {
            const ctx = getAudioCtx();
            const t = ctx.currentTime;
            const idx = musicStep % song.notes.length;
            musicStep++;

            const noteDur = (stepMs / 1000) * 0.85;

            // Melody note
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            o.type = song.wave;
            o.frequency.value = song.notes[idx];
            g.gain.setValueAtTime(0.0, t);
            g.gain.linearRampToValueAtTime(song.vol, t + 0.03);
            g.gain.setValueAtTime(song.vol, t + noteDur * 0.6);
            g.gain.exponentialRampToValueAtTime(0.001, t + noteDur);
            o.start(t); o.stop(t + noteDur);

            // Bass note (sine, quieter)
            if (song.bass && song.bass[idx]) {
                const ob = ctx.createOscillator();
                const gb = ctx.createGain();
                ob.connect(gb); gb.connect(ctx.destination);
                ob.type = 'sine';
                ob.frequency.value = song.bass[idx];
                gb.gain.setValueAtTime(0.0, t);
                gb.gain.linearRampToValueAtTime(song.vol * 0.7, t + 0.05);
                gb.gain.exponentialRampToValueAtTime(0.001, t + noteDur * 1.1);
                ob.start(t); ob.stop(t + noteDur * 1.1);
            }

            // Level 5 gets a shimmer harmony
            if (level === 5) {
                const oh = ctx.createOscillator();
                const gh = ctx.createGain();
                oh.connect(gh); gh.connect(ctx.destination);
                oh.type = 'triangle';
                oh.frequency.value = song.notes[idx] * 1.5;
                gh.gain.setValueAtTime(0.0, t);
                gh.gain.linearRampToValueAtTime(0.04, t + 0.02);
                gh.gain.exponentialRampToValueAtTime(0.001, t + noteDur * 0.8);
                oh.start(t); oh.stop(t + noteDur);
            }

        } catch(e) {}
    }, stepMs);
}

function stopMusic() {
    if (musicInterval) { clearInterval(musicInterval); musicInterval = null; }
}

function toggleSound() {
    soundEnabled = !soundEnabled;
    document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîá';
    if (!soundEnabled) stopMusic();
    else startMusic();
}

/* Menu Functions */
function showDifficultySelect() {
    document.getElementById('difficultySelect').style.display = 'block';
}

let startLevel = 1;

function selectStartLevel(lvl) {
    startLevel = lvl;
    document.querySelectorAll('#levelSelect .difficulty-btn').forEach((btn, i) => {
        btn.classList.toggle('selected', i + 1 === lvl);
    });
}

function selectDifficulty(diff) {
    difficulty = diff;
    document.querySelectorAll('#difficultyBtns .difficulty-btn').forEach(btn => btn.classList.remove('selected'));
    event.target.classList.add('selected');
}

/* ‚îÄ‚îÄ Per-level themes ‚îÄ‚îÄ */
const levelThemeData = {
    1: {
        name: "Sweet Beginnings",
        description: "Pink skies of love",
        bg: 'linear-gradient(180deg, #ff758c 0%, #ff9ab0 60%, #ffb3c6 100%)',
        particles: () => spawnLoop(['üå∏','üå∑','‚úø'], 3000, 13, 'fall', 0.35)
    },
    2: {
        name: "Ocean Dreams",
        description: "Aqua waves of affection",
        bg: 'linear-gradient(180deg, #0099cc 0%, #00ccdd 50%, #a8edea 100%)',
        particles: () => spawnBubbles()
    },
    3: {
        name: "Sunset Romance",
        description: "Warm golden glow",
        bg: 'linear-gradient(180deg, #ff6b35 0%, #f7931e 40%, #ffd89b 100%)',
        particles: () => spawnLoop(['üçÇ','üçÅ','üçÉ'], 800, 20, 'fall', 0.7)
    },
    4: {
        name: "Aurora Night",
        description: "Dancing lights in the sky",
        bg: 'linear-gradient(180deg, #0a0a2e 0%, #0d1b4e 40%, #1a0b4e 100%)',
        particles: () => spawnMeteors()
    },
    5: {
        name: "Golden Sunrise",
        description: "A warm new dawn",
        bg: 'linear-gradient(180deg, #f7971e 0%, #ffd200 50%, #fff176 100%)',
        particles: () => spawnConfetti()
    },
    6: {
        name: "Enchanted Forest",
        description: "Magic in the trees",
        bg: 'linear-gradient(180deg, #134e5e 0%, #1a6b3a 50%, #2d9e5f 100%)',
        particles: () => spawnLoop(['üçÄ','üåø','‚ú®','ü¶ã','üå∫'], 700, 18, 'fall', 0.75)
    },
    7: {
        name: "Cotton Candy Sky",
        description: "Pastel clouds and dreams",
        bg: 'linear-gradient(180deg, #c9d6ff 0%, #e2c9f5 40%, #ffd6f0 100%)',
        particles: () => spawnLoop(['‚òÅÔ∏è','üç¨','üç≠','üíú','üíó'], 900, 20, 'fall', 0.6)
    },
    8: {
        name: "Deep Space",
        description: "Lost among the stars",
        bg: 'linear-gradient(180deg, #000000 0%, #0d0d2b 50%, #1a0533 100%)',
        particles: () => spawnGalaxy()
    },
    9: {
        name: "Cherry Blossom",
        description: "Spring in full bloom",
        bg: 'linear-gradient(180deg, #fceabb 0%, #f8b4c8 50%, #f9d0e0 100%)',
        particles: () => spawnLoop(['üå∏','üå∏','üå∏','üå∑','üå∫','üå∏'], 400, 22, 'fall', 0.8)
    },
    10: {
        name: "Grand Finale ‚ú®",
        description: "You made it ‚Äî all 10 levels!",
        bg: 'linear-gradient(180deg, #0f0c29 0%, #302b63 50%, #24243e 100%)',
        particles: () => spawnFinale()
    }
};

function applyTheme() {
    // Clear old particles
    clearParticles();

    const theme = levelThemeData[level] || levelThemeData[1];
    document.body.style.background = theme.bg;

    // Start this level's particles
    theme.particles();
}

function clearParticles() {
    if (themeAnimationInterval) {
        clearInterval(themeAnimationInterval);
        themeAnimationInterval = null;
    }
    document.querySelectorAll('.bg-particle').forEach(el => el.remove());
}

function spawnParticleEl(content, isStar) {
    const el = document.createElement('div');
    el.className = 'bg-particle';
    el.style.left = (Math.random() * 100) + 'vw';
    el.style.top = '-60px';
    el.style.fontSize = (Math.random() * 14 + 14) + 'px';
    el.style.zIndex = '1';

    if (isStar) {
        el.style.width  = (Math.random() * 4 + 2) + 'px';
        el.style.height = el.style.width;
        el.style.background = 'white';
        el.style.borderRadius = '50%';
        el.style.boxShadow = '0 0 6px 2px rgba(255,255,255,0.9)';
        el.style.top  = (Math.random() * 100) + 'vh';
        el.style.left = (Math.random() * 100) + 'vw';
        el.style.animation = `bgPulse ${(Math.random() * 2 + 1.5).toFixed(2)}s ease-in-out infinite`;
        el.style.animationDelay = (Math.random() * 3) + 's';
        el.style.position = 'fixed';
        document.body.appendChild(el);
        return el;
    }

    el.textContent = content;
    el.style.animation = `bgFall ${(Math.random() * 4 + 4).toFixed(2)}s linear forwards`;
    el.style.animationDelay = (Math.random() * 0.5) + 's';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 9000);
    return el;
}

function spawnLoop(emojis, interval, fontSize, mode, opacity = 1) {
    themeAnimationInterval = setInterval(() => {
        const el = document.createElement('div');
        el.className = 'bg-particle';
        el.style.position = 'fixed';
        el.style.left = (Math.random() * 98) + 'vw';
        el.style.top = '-50px';
        el.style.fontSize = (Math.random() * 6 + fontSize - 3) + 'px';
        el.style.zIndex = '1';
        el.style.opacity = opacity;
        el.style.pointerEvents = 'none';
        el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        const dur = (Math.random() * 4 + 5).toFixed(2);
        el.style.animation = `bgFall ${dur}s linear forwards`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), (parseFloat(dur) + 0.5) * 1000);
    }, interval);
}

function spawnMeteors() {
    // Diagonal meteors streaking across ‚Äî very different from stars
    themeAnimationInterval = setInterval(() => {
        const el = document.createElement('div');
        el.className = 'bg-particle';
        el.style.position = 'fixed';
        el.style.left = (Math.random() * 90) + 'vw';
        el.style.top = '-10px';
        el.style.fontSize = (Math.random() * 8 + 12) + 'px';
        el.style.zIndex = '1';
        el.style.pointerEvents = 'none';
        el.style.filter = 'drop-shadow(0 0 6px rgba(150,100,255,0.9))';
        el.textContent = ['üå†','üíú','üîÆ'][Math.floor(Math.random() * 3)];
        const dur = (Math.random() * 1.5 + 1.5).toFixed(2);
        // Diagonal fall using bgMeteor keyframe
        el.style.animation = `bgMeteor ${dur}s linear forwards`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), (parseFloat(dur) + 0.3) * 1000);
    }, 600);
}

function spawnConfetti() {
    const pieces = ['üåü','‚≠ê','‚ú®','üíõ','üéä','üéâ'];
    themeAnimationInterval = setInterval(() => {
        const el = document.createElement('div');
        el.className = 'bg-particle';
        el.style.position = 'fixed';
        el.style.left = (Math.random() * 98) + 'vw';
        el.style.top = '-50px';
        el.style.fontSize = (Math.random() * 10 + 12) + 'px';
        el.style.zIndex = '1';
        el.style.pointerEvents = 'none';
        el.textContent = pieces[Math.floor(Math.random() * pieces.length)];
        const dur = (Math.random() * 3 + 4).toFixed(2);
        el.style.animation = `bgFall ${dur}s linear forwards`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), (parseFloat(dur) + 0.5) * 1000);
    }, 350);
}

function spawnGalaxy() {
    // Tiny glowing orbs drifting slowly ‚Äî deep space feel
    const colors = ['rgba(180,100,255,0.9)','rgba(100,180,255,0.9)','rgba(255,255,255,0.9)','rgba(255,100,200,0.8)'];
    themeAnimationInterval = setInterval(() => {
        const el = document.createElement('div');
        el.className = 'bg-particle';
        el.style.position = 'fixed';
        el.style.left = (Math.random() * 98) + 'vw';
        el.style.top = '-20px';
        el.style.zIndex = '1';
        el.style.pointerEvents = 'none';
        const size = Math.random() * 5 + 3;
        el.style.width  = size + 'px';
        el.style.height = size + 'px';
        el.style.borderRadius = '50%';
        const col = colors[Math.floor(Math.random() * colors.length)];
        el.style.background = col;
        el.style.boxShadow = `0 0 ${size * 3}px ${size}px ${col}`;
        const dur = (Math.random() * 6 + 7).toFixed(2);
        el.style.animation = `bgFall ${dur}s linear forwards`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), (parseFloat(dur) + 0.5) * 1000);
    }, 180);
}

function spawnFinale() {
    // Everything ‚Äî meteors, confetti, sparkles all at once
    const all = ['üåü','üéâ','üí•','üéä','‚ú®','üí´','üå†','‚ù§Ô∏è','üíï','üî•'];
    themeAnimationInterval = setInterval(() => {
        for (let i = 0; i < 3; i++) {
            const el = document.createElement('div');
            el.className = 'bg-particle';
            el.style.position = 'fixed';
            el.style.left = (Math.random() * 98) + 'vw';
            el.style.top = '-50px';
            el.style.fontSize = (Math.random() * 14 + 14) + 'px';
            el.style.zIndex = '1';
            el.style.pointerEvents = 'none';
            el.textContent = all[Math.floor(Math.random() * all.length)];
            const dur = (Math.random() * 3 + 3).toFixed(2);
            el.style.animation = `bgFall ${dur}s linear forwards`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), (parseFloat(dur) + 0.5) * 1000);
        }
    }, 200);
}

function spawnBubbles() {
    // Bubbles rise from bottom
    themeAnimationInterval = setInterval(() => {
        const el = document.createElement('div');
        el.className = 'bg-particle';
        el.style.position = 'fixed';
        el.style.left = (Math.random() * 95) + 'vw';
        el.style.bottom = '-40px';
        el.style.top = 'auto';
        el.style.zIndex = '1';
        el.style.pointerEvents = 'none';
        const size = Math.random() * 22 + 10;
        el.style.width  = size + 'px';
        el.style.height = size + 'px';
        el.style.borderRadius = '50%';
        el.style.border = '2px solid rgba(255,255,255,0.6)';
        el.style.background = 'rgba(255,255,255,0.15)';
        const dur = (Math.random() * 4 + 4).toFixed(2);
        el.style.animation = `bgBubble ${dur}s ease-in forwards`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), (parseFloat(dur) + 0.3) * 1000);
    }, 400);
}

function showHowToPlay() {
    document.getElementById('menuOverlay').style.display = 'none';
    document.getElementById('howToPlay').style.display = 'flex';
}

function closeHowToPlay() {
    document.getElementById('howToPlay').style.display = 'none';
    document.getElementById('menuOverlay').style.display = 'flex';
}

function backToMenu() {
    location.reload();
}

/* ‚îÄ‚îÄ Level difficulty scaling ‚îÄ‚îÄ */
function getLevelConfig(lvl) {
    // Difficulty multiplier per menu setting
    const diffMult = { easy: 0.75, medium: 1.0, hard: 1.35 }[difficulty] || 1.0;

    // Base values that tighten each level
    //   spawnMs  : how often a new item spawns (lower = faster)
    //   fallBase : base fall duration in seconds (lower = faster falling)
    //   fallRand : random extra seconds added to fall (lower = less variance)
    //   bombChance   : probability 0-1 of spawning a bomb
    //   eggChance    : probability 0-1 of spawning easter egg
    //   powerupChance: probability 0-1 of spawning powerup
    const base = {
        spawnMs:       Math.max(400, 1400 - (lvl - 1) * 100),  // 1400 ‚Üí 500ms
        fallBase:      Math.max(0.8, 2.8 - (lvl - 1) * 0.2),   // 2.8s ‚Üí 1.0s
        fallRand:      Math.max(0.3, 1.5 - (lvl - 1) * 0.13),  // 1.5s ‚Üí 0.3s variance
        bombChance:    Math.min(0.22, 0.04 + (lvl - 1) * 0.02),// 4% ‚Üí 22%
        eggChance:     Math.min(0.30, 0.08 + (lvl - 1) * 0.025),// 8% ‚Üí 30%
        powerupChance: Math.max(0.04, 0.12 - (lvl - 1) * 0.008)// 12% ‚Üí 5%
    };

    // Apply difficulty multiplier to speed (lower spawnMs = harder)
    base.spawnMs  = Math.round(base.spawnMs / diffMult);
    base.fallBase = base.fallBase / diffMult;

    return base;
}

/* Game Functions */
function startGame() {
    document.getElementById('menuOverlay').style.display = 'none';
    gameStarted = true;
    lives = 3;
    score = 0;
    heartsThisLevel = 0;
    level = startLevel;
    streak = 0;
    combo = 0;
    updateLivesDisplay();
    updateHeartsDisplay();
    applyTheme();
    showLevelTransition();

    // Don't spawn until GO (at 2s into countdown)
    setTimeout(() => {
        if (gameStarted) restartSpawnInterval();
    }, 2000);
    setInterval(createSparkle, 300);
    setInterval(createLoveText, 4000);

    startCollisionLoop();

    if (soundEnabled) startMusic();
}

function restartSpawnInterval() {
    clearInterval(spawnInterval);
    const cfg = getLevelConfig(level);
    spawnInterval = setInterval(createItem, cfg.spawnMs);
}

function updateLevelTheme() {
    applyTheme();
    if (soundEnabled) startMusic();
}

function showLevelTransition() {
    const theme = levelThemeData[level];
    if (!theme) return;

    const cfg = getLevelConfig(level);
    const speedLabel = level <= 2 ? 'üê¢ Chill' : level <= 4 ? 'üö∂ Easy' : level <= 6 ? 'üèÉ Medium' : level <= 8 ? '‚ö° Fast' : 'üî• Intense';
    const dangerPct  = Math.round((cfg.bombChance + cfg.eggChance) * 100);

    // Show level info briefly at top of screen (no dark overlay)
    const transition = document.getElementById('levelTransition');
    transition.querySelector('.level-number').textContent = `Level ${level} ‚Äî ${theme.name}`;
    transition.querySelector('.level-theme').textContent = theme.description;
    transition.querySelector('.level-description').textContent = `${speedLabel}  ‚Ä¢  ${dangerPct}% danger`;
    transition.style.display = 'flex';
    setTimeout(() => { transition.style.display = 'none'; }, 3800);

    // Ready... Steady... GO! countdown
    const cd = document.getElementById('countdown');
    const steps = [
        { text: 'READY', color: '#FFD700' },
        { text: 'STEADY', color: '#ff9a00' },
        { text: 'GO! üöÄ', color: '#00e676' }
    ];

    steps.forEach(({ text, color }, i) => {
        setTimeout(() => {
            cd.textContent = text;
            cd.style.color = color;
            cd.style.display = 'block';
            cd.style.animation = 'none';
            // Force reflow to restart animation
            void cd.offsetWidth;
            cd.style.animation = 'countPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';

            // Fade out before next step
            setTimeout(() => {
                cd.style.animation = 'countFade 0.3s ease-out forwards';
            }, 650);
        }, i * 1000);
    });

    // Hide after GO
    setTimeout(() => { cd.style.display = 'none'; }, 3200);
}

function restartGame() {
    document.getElementById('gameOver').style.display = 'none';
    startGame();
}

function updateHeartsDisplay() {
    scoreDisplay.textContent = `${heartsThisLevel}/10`;
    levelDisplay.textContent = level;
    streakDisplay.textContent = streak;
}

function updateLivesDisplay() {
    livesDisplay.textContent = 'üíñ'.repeat(lives);
}

function loseLife() {
    lives--;
    updateLivesDisplay();
    
    if (lives <= 0) {
        gameOver();
    }
}

function gameOver() {
    const imgEl = document.getElementById('gameOverImg');
    imgEl.innerHTML = `<img src="${ME_SAD}" style="height:100px;width:auto;border-radius:12px;object-fit:cover;">`;
    document.getElementById('gameOverTitle').textContent = 'üíî Game Over';
    
    if (score > highScore) {
        highScore = score;
        localStorage.setItem('beatrix_highscore', highScore);
    }
    
    document.getElementById('gameOverScore').textContent = `${score} hearts collected üíñ`;
    document.getElementById('gameOverHigh').textContent = `Best: ${highScore} üèÜ`;
    document.getElementById('gameOverStreak').textContent = `Max Streak: ${maxStreak} üî•`;
    document.getElementById('gameOverLevel').textContent = `Reached Level ${level}`;
    
    gameStarted = false;
    clearInterval(spawnInterval);
    stopMusic();
    playSound('gameover');
    
    setTimeout(() => {
        document.getElementById('gameOver').style.display = 'flex';
    }, 1000);
}

function clearActiveItems() {
    for (let i = activeItems.length - 1; i >= 0; i--) {
        activeItems[i].el.remove();
    }
    activeItems = [];
}

function checkLevelUp() {
    if (heartsThisLevel >= 10) {
        // Stop spawning and wipe screen
        clearInterval(spawnInterval);
        clearActiveItems();
        playSound('levelup');
        showLevelComplete();
    }
}

const levelEmojis = {1:'üå∏',2:'üåä',3:'üçÇ',4:'üå†',5:'‚òÄÔ∏è',6:'üåø',7:'üç¨',8:'üåå',9:'üå∫',10:'üéâ'};
const levelMessages = {
    1:'Pink skies cleared! üå∏', 2:'Waves conquered! üåä', 3:'Autumn mastered! üçÇ',
    4:'Stars aligned! üå†',      5:'Sunrise claimed! ‚òÄÔ∏è', 6:'Forest explored! üåø',
    7:'Sugar rush! üç¨',         8:'Deep space! üåå',       9:'Blossoms caught! üå∫',
    10:'LEGENDARY! üéâ'
};

function showLevelComplete() {
    const completedLevel = level;
    const theme = levelThemeData[completedLevel] || {};

    document.getElementById('lcEmoji').textContent   = levelEmojis[completedLevel] || 'üéâ';
    document.getElementById('lcTitle').textContent   = `Level ${completedLevel} Complete!`;
    document.getElementById('lcTheme').textContent   = levelMessages[completedLevel] || theme.name || '';
    document.getElementById('lcStreak').textContent  = maxStreak;
    document.getElementById('lcScore').textContent   = score;
    document.getElementById('lcLives').textContent   = 'üíñ'.repeat(lives);

    // Match background to current level theme
    const lc = document.getElementById('levelComplete');
    lc.style.background = theme.bg || 'linear-gradient(135deg, #ff758c, #ff7eb3)';
    // Last level button says Finish
    document.querySelector('.lc-next').textContent = completedLevel >= 10 ? 'Finish! üéâ' : 'Next Level ‚Üí';
    lc.style.display = 'flex';
}

function nextLevel() {
    document.getElementById('levelComplete').style.display = 'none';

    // Advance level
    heartsThisLevel = 0;
    level++;
    levelDisplay.textContent = level;
    updateHeartsDisplay();

    // Win ‚Äî completed all 10 levels
    if (level > 10) {
        const imgEl = document.getElementById('gameOverImg');
        imgEl.innerHTML = `<img src="${ME_HAPPY}" style="height:100px;width:auto;border-radius:12px;object-fit:cover;">`;
        document.getElementById('gameOverTitle').textContent = 'üéâ You Won!';
        if (score > highScore) { highScore = score; localStorage.setItem('beatrix_highscore', highScore); }
        document.getElementById('gameOverScore').textContent = `${score} hearts collected üíñ`;
        document.getElementById('gameOverHigh').textContent = `Best: ${highScore} üèÜ`;
        document.getElementById('gameOverStreak').textContent = `Max Streak: ${maxStreak} üî•`;
        document.getElementById('gameOverLevel').textContent = `Completed all 10 levels!`;
        gameStarted = false;
        clearInterval(spawnInterval);
        stopMusic();
        playSound('win');
        showPopup('üéâ YOU WIN! üéâ');
        setTimeout(() => { document.getElementById('gameOver').style.display = 'flex'; }, 1500);
        return;
    }

    updateLevelTheme(); // this calls startMusic() inside

    // Show Ready/Steady/Go then start spawning
    showLevelTransition();
    setTimeout(() => {
        if (gameStarted) restartSpawnInterval();
    }, 2000);
}

/* Basket movement - follows mouse/touch directly, no click required */
let basketX = window.innerWidth / 2;

function getGameWidth() {
    return window.visualViewport ? window.visualViewport.width : window.innerWidth;
}

function updateBasketPosition(clientX) {
    const gameWidth = getGameWidth();
    basketX = Math.max(40, Math.min(gameWidth - 40, clientX));
    basket.style.left = basketX + 'px';
    basket.style.transform = 'translateX(-50%)';
}

document.addEventListener('mousemove', (e) => {
    if (gameStarted) {
        updateBasketPosition(e.clientX);
    }
});

gameArea.addEventListener('touchstart', (e) => {
    if (!gameStarted) return;
    e.preventDefault();
    updateBasketPosition(e.touches[0].clientX);
}, { passive: false });

document.addEventListener('touchmove', (e) => {
    if (gameStarted) {
        e.preventDefault();
        updateBasketPosition(e.touches[0].clientX);
    }
}, { passive: false });

/* Preload reaction images */
const imgNormal = new Image(); imgNormal.src = 'me.jpg';
const imgHit    = new Image(); imgHit.src    = 'me2.jpg';
const imgHappy  = new Image(); imgHappy.src  = 'me3.jpg';

let reactionTimeout = null;

/* Basket reactions */
function reactToHeart() {
    basket.style.animation = 'celebrateJump 0.5s ease';
    setTimeout(() => { basket.style.animation = ''; }, 500);

    const basketImg = document.getElementById('basketImg');
    if (reactionTimeout) clearTimeout(reactionTimeout);
    basketImg.src = 'me3.jpg';
    reactionTimeout = setTimeout(() => { basketImg.src = 'me.jpg'; }, 2000);
}

function reactToHit() {
    basket.style.animation = 'hitFlash 0.4s ease';
    setTimeout(() => { basket.style.animation = ''; }, 400);

    const basketImg = document.getElementById('basketImg');
    if (reactionTimeout) clearTimeout(reactionTimeout);
    basketImg.src = 'me2.jpg';
    reactionTimeout = setTimeout(() => { basketImg.src = 'me.jpg'; }, 2000);
}

function screenShake() {
    gameArea.style.animation = 'screenShake 0.4s ease';
    setTimeout(() => { gameArea.style.animation = ''; }, 400);
}

function spawnParticles(x, y) {
    for (let i = 0; i < 8; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        const angle = (i / 8) * Math.PI * 2;
        const distance = 50 + Math.random() * 30;
        particle.style.left = x + 'px';
        particle.style.top = y + 'px';
        particle.style.setProperty('--px', Math.cos(angle) * distance + 'px');
        particle.style.setProperty('--py', Math.sin(angle) * distance + 'px');
        gameArea.appendChild(particle);
        setTimeout(() => particle.remove(), 800);
    }
}

/* Double Points */
function activateDoublePoints() {
    doublePoints = true;
    basket.classList.add('doublePoints');
    document.getElementById('doubleBanner').style.display = 'block';
    
    setTimeout(() => {
        doublePoints = false;
        basket.classList.remove('doublePoints');
        document.getElementById('doubleBanner').style.display = 'none';
    }, 5000);
}

/* Auto-play music on first interaction */
document.body.addEventListener('touchstart', () => {
    if (gameStarted) startMusic();
}, { passive: true, once: true });

/* Create falling items */
function createItem() {
    const cfg = getLevelConfig(level);
    const rand = Math.random();
    const heartThreshold    = 1 - cfg.bombChance - cfg.eggChance - cfg.powerupChance;

    if (rand < heartThreshold) {
        createHeart(cfg);
    } else if (rand < heartThreshold + cfg.powerupChance) {
        createPowerup(cfg);
    } else if (rand < heartThreshold + cfg.powerupChance + cfg.bombChance) {
        createBomb(cfg);
    } else {
        createEasterEgg(cfg);
    }
}

function createHeart(cfg) {
    const heart = document.createElement("div");
    heart.classList.add("heart");
    const hearts = ["‚ù§Ô∏è", "üíï", "üíñ", "üíó", "üíì", "üíù"];
    heart.innerHTML = hearts[Math.floor(Math.random() * hearts.length)];
    heart.style.left = Math.random() * (getGameWidth() - 50) + "px";
    heart.style.animationDuration = (cfg.fallBase + Math.random() * cfg.fallRand) + "s";
    gameArea.appendChild(heart);
    activeItems.push({ el: heart, type: 'heart' });
}

function createPowerup(cfg) {
    const powerup = document.createElement("div");
    powerup.classList.add("powerup");
    const powerups = ["‚≠ê", "üí´", "‚ú®", "üåü"];
    powerup.innerHTML = powerups[Math.floor(Math.random() * powerups.length)];
    powerup.style.left = Math.random() * (getGameWidth() - 50) + "px";
    const fallDur = (cfg.fallBase + Math.random() * cfg.fallRand).toFixed(2);
    powerup.style.animationDuration = fallDur + "s, 0.6s";
    gameArea.appendChild(powerup);
    activeItems.push({ el: powerup, type: 'powerup' });
}

function createBomb(cfg) {
    const bomb = document.createElement("div");
    bomb.classList.add("bomb");
    bomb.innerHTML = "üí£";
    bomb.style.left = Math.random() * (getGameWidth() - 50) + "px";
    // Bombs fall slightly faster than hearts for more danger
    bomb.style.animationDuration = (cfg.fallBase * 0.85 + Math.random() * cfg.fallRand) + "s";
    gameArea.appendChild(bomb);
    activeItems.push({ el: bomb, type: 'bomb' });
}

function createEasterEgg(cfg) {
    const egg = document.createElement("div");
    egg.classList.add("bomb");
    egg.innerHTML = "üçÜ";
    egg.style.left = Math.random() * (getGameWidth() - 50) + "px";
    // Easter eggs fall faster than bombs ‚Äî sneaky
    egg.style.animationDuration = (cfg.fallBase * 0.7 + Math.random() * cfg.fallRand * 0.5) + "s";
    egg.style.fontSize = "35px";
    gameArea.appendChild(egg);
    playSound('spawn');
    activeItems.push({ el: egg, type: 'easteregg' });
}

/* Unified RAF-based collision loop ‚Äî replaces per-item setInterval */
let activeItems = []; // { el, type }
let collisionLoopRunning = false;

function startCollisionLoop() {
    if (collisionLoopRunning) return;
    collisionLoopRunning = true;
    rafCollisionLoop();
}

function rafCollisionLoop() {
    if (!gameStarted && activeItems.length === 0) { collisionLoopRunning = false; return; }

    const basketRect = basket.getBoundingClientRect();
    const viewH = window.visualViewport ? window.visualViewport.height : window.innerHeight;

    for (let i = activeItems.length - 1; i >= 0; i--) {
        const { el, type } = activeItems[i];
        const itemRect = el.getBoundingClientRect();

        // Caught
        if (
            itemRect.bottom >= basketRect.top &&
            itemRect.left < basketRect.right &&
            itemRect.right > basketRect.left
        ) {
            handleCatch(type, itemRect);
            el.remove();
            activeItems.splice(i, 1);
            continue;
        }

        // Missed ‚Äî fell off screen
        if (itemRect.top > viewH) {
            el.remove();
            activeItems.splice(i, 1);
            if (type === 'heart') {
                streak = 0;
                combo = 0;
                streakDisplay.textContent = streak;
                comboDisplay.textContent = "";
                // Missing a heart costs a life
                if (gameStarted) {
                    showPopup("üíî MISSED!");
                    loseLife();
                }
            }
        }
    }

    requestAnimationFrame(rafCollisionLoop);
}

function handleCatch(type, itemRect) {
    if (type === 'heart') {
        heartsThisLevel++;
        score++;
        streak++;
        combo++;
        updateHeartsDisplay();

        if (itemRect) {
            const cx = itemRect.left + itemRect.width / 2 - gameArea.getBoundingClientRect().left;
            const cy = itemRect.top + itemRect.height / 2 - gameArea.getBoundingClientRect().top;
            spawnParticles(cx, cy);
        }

        if (doublePoints) {
            heartsThisLevel++;
            score++;
            updateHeartsDisplay();
            showPopup(`üíõ DOUBLE! +2 ‚ù§Ô∏è`);
        }

        if (combo > 2) {
            comboDisplay.textContent = `${combo}x COMBO!`;
            comboDisplay.classList.add('pulse');
            setTimeout(() => comboDisplay.classList.remove('pulse'), 200);
            playSound('combo');
            if (!doublePoints) showPopup(funnyMessages[Math.floor(Math.random() * funnyMessages.length)]);
        } else {
            playSound('catch');
        }

        reactToHeart();
        checkLevelUp();
        if (streak > maxStreak) maxStreak = streak;

    } else if (type === 'powerup') {
        playSound('powerup');
        showPopup("‚≠ê 2x POINTS! ‚≠ê");
        activatePowerup();
        activateDoublePoints();

    } else if (type === 'bomb') {
        if (!invincible) {
            streak = 0; combo = 0;
            streakDisplay.textContent = streak;
            comboDisplay.textContent = "";
            playSound('bomb');
            showPopup("üí• BOMB! -1 Life üíî");
            reactToHit();
            screenShake();
            loseLife();          // üí£ costs a LIFE
        } else {
            showPopup("üõ°Ô∏è PROTECTED!");
        }

    } else if (type === 'easteregg') {
        // üçÜ costs a HEART (from level progress)
        if (heartsThisLevel > 0) {
            heartsThisLevel--;
            score = Math.max(0, score - 1);
            updateHeartsDisplay();
        }
        streak = 0; combo = 0;
        streakDisplay.textContent = streak;
        comboDisplay.textContent = "";
        playSound('easteregg');
        showPopup("üçÜ OUCH! -1 ‚ù§Ô∏è üòÇ");
        reactToHit();
        screenShake();
    }

    // Win condition: reach level 11 (complete 10 levels of 10 hearts)
    if (level > 10 && gameStarted) {
        const imgEl = document.getElementById('gameOverImg');
        imgEl.innerHTML = `<img src="${ME_HAPPY}" style="height:100px;width:auto;border-radius:12px;object-fit:cover;">`;
        document.getElementById('gameOverTitle').textContent = 'üéâ You Won!';
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('beatrix_highscore', highScore);
        }
        document.getElementById('gameOverScore').textContent = `${score} hearts collected üíñ`;
        document.getElementById('gameOverHigh').textContent = `Best: ${highScore} üèÜ`;
        document.getElementById('gameOverLevel').textContent = `Completed all 10 levels!`;
        gameStarted = false;
        clearInterval(spawnInterval);
        stopMusic();
        message.style.display = "block";
        playSound('win');
        showPopup("üéâ YOU WIN! üéâ");
        setTimeout(() => {
            document.getElementById('gameOver').style.display = 'flex';
        }, 2000);
    }
}

function activatePowerup() {
    invincible = true;
    basket.classList.add('invincible');
    activateDoublePoints();
    setTimeout(() => {
        invincible = false;
        basket.classList.remove('invincible');
    }, 5000);
}

function showPopup(text) {
    popupText.textContent = text;
    popupText.style.opacity = 1;
    popupText.style.transform = 'translate(-50%, -50%) scale(1)';
    
    setTimeout(() => {
        popupText.style.transition = 'all 0.5s ease-out';
        popupText.style.opacity = 0;
        popupText.style.transform = 'translate(-50%, -80%) scale(0.5)';
    }, 800);
    
    setTimeout(() => {
        popupText.style.transition = '';
    }, 1300);
}

/* Sparkles */
function createSparkle() {
    const sparkle = document.createElement("div");
    sparkle.classList.add("sparkle");
    sparkle.style.left = Math.random() * getGameWidth() + "px";
    sparkle.style.animationDuration = (3 + Math.random() * 3) + "s";
    document.body.appendChild(sparkle);
    setTimeout(() => sparkle.remove(), 6000);
}

/* Floating Love Text */
function createLoveText() {
    const text = document.createElement("div");
    text.classList.add("loveText");
    text.innerHTML = loveMessages[Math.floor(Math.random() * loveMessages.length)];
    text.style.left = Math.random() * (getGameWidth() - 200) + "px";
    document.body.appendChild(text);
    setTimeout(() => text.remove(), 6000);
}

/* Initialize page with default theme */
window.addEventListener('DOMContentLoaded', function() {
    // Set initial background
    document.body.style.background = 'linear-gradient(to bottom, #ff758c, #ff7eb3)';
    console.log('Page loaded, background set');
});

</script>

</body>
</html>